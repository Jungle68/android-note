import{_ as n,o as s,c as a,e as t}from"./app.89e8a229.js";const p={},e=t(`<h1 id="activity\u542F\u52A8\u8FC7\u7A0B" tabindex="-1"><a class="header-anchor" href="#activity\u542F\u52A8\u8FC7\u7A0B" aria-hidden="true">#</a> Activity\u542F\u52A8\u8FC7\u7A0B</h1><p>\u524D\u4E24\u5929\u9762\u8BD5\u4E86\u5929\u732B\u7684\u5F00\u53D1\uFF0C\u88AB\u95EE\u5230\u4E86<code>Activity</code>\u542F\u52A8\u8FC7\u7A0B\uFF0C\u4E0D\u61C2\u554A.... \u4ECA\u5929\u5C31\u6765\u5206\u6790\u4E00\u4E0B\uFF0C\u6211\u4EEC\u5F00\u542F<code>Activity</code>\u4E3B\u8981\u6709\u4E24\u79CD\u65B9\u5F0F:</p><ul><li>\u901A\u8FC7\u684C\u9762\u56FE\u6807\u542F\u52A8\uFF0C\u684C\u9762\u5C31\u662F<code>Launcher</code>\u5176\u5B9E\u4ED6\u4E5F\u662F\u4E00\u4E2A\u5E94\u7528\u7A0B\u5E8F\uFF0C\u4ED6\u4E5F\u662F\u7EE7\u627F<code>Activity</code>\u3002</li><li>\u5728\u7A0B\u5E8F\u5185\u90E8\u8C03\u7528<code>startActivity()</code>\u5F00\u542F\u3002</li></ul><p>\u800C<code>Launcher</code>\u70B9\u51FB\u56FE\u6807\u5176\u5B9E\u4E5F\u662F\u8C03\u7528\u4E86<code>Activity</code>\u7684<code>startActivity()</code>\u65B9\u6CD5\uFF0C\u6240\u4EE5\u6211\u4EEC\u5C31\u4ECE<code>startActivity()</code>\u65B9\u6CD5\u5165\u624B\u4E86\u3002<br> \u9996\u5148\u770B\u4E00\u4E0B<code>Activity</code>\u7C7B\u4E2D\u7684<code>startActivity()</code>\u65B9\u6CD5:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">startActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7EE7\u7EED\u770B<code>startActivity(intent, null)</code>:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Launch a new activity.  You will not receive any information about when
 * the activity exits.  This implementation overrides the base version,
 * providing information about
 * the activity performing the launch.  Because of this additional
 * information, the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Intent</span><span class="token punctuation">#</span><span class="token field">FLAG_ACTIVITY_NEW_TASK</span></span><span class="token punctuation">}</span> launch flag is not
 * required; if not specified, the new activity will be added to the
 * task of the caller.
 *
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>This method throws <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">ActivityNotFoundException</span></span><span class="token punctuation">}</span>
 * if there was no Activity found to run the given Intent.
 *
 * <span class="token keyword">@param</span> <span class="token parameter">intent</span> The intent to start.
 * <span class="token keyword">@param</span> <span class="token parameter">options</span> Additional options for how the Activity should be started.
 * See <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">Context</span><span class="token punctuation">#</span><span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">,</span> <span class="token class-name">Bundle</span><span class="token punctuation">)</span></span>
 * Context.startActivity(Intent, Bundle)<span class="token punctuation">}</span> for more details.
 *
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">ActivityNotFoundException</span></span>
 *
 * <span class="token keyword">@see</span> <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token punctuation">#</span><span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
 * <span class="token keyword">@see</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">startActivityForResult</span></span>
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">startActivityForResult</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">// Note we want to go through this call for compatibility with</span>
		<span class="token comment">// applications that may have overridden the method.</span>
		<span class="token function">startActivityForResult</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u63A5\u4E0B\u6765\u4F1A\u8C03\u7528<code>startActivityForResult()</code>\u65B9\u6CD5(\u6CE8\u91CA\u4E5F\u5F88\u91CD\u8981\u554A\uFF0C\u91CC\u9762\u4E5F\u8BF4\u660E\u4E86singleTask\u542F\u52A8\u6A21\u5F0F\u65F6\u8BE5\u65B9\u6CD5\u4E0D\u4F1A\u8D70\u5230\u56DE\u8C03\u4E2D):</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Launch an activity for which you would like a result when it finished.
 * When this activity exits, your
 * onActivityResult() method will be called with the given requestCode.
 * Using a negative requestCode is the same as calling
 * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">startActivity</span></span><span class="token punctuation">}</span> (the activity is not launched as a sub-activity).
 *
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Note that this method should only be used with Intent protocols
 * that are defined to return a result.  In other protocols (such as
 * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Intent</span><span class="token punctuation">#</span><span class="token field">ACTION_MAIN</span></span><span class="token punctuation">}</span> or <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Intent</span><span class="token punctuation">#</span><span class="token field">ACTION_VIEW</span></span><span class="token punctuation">}</span>), you may
 * not get the result when you expect.  For example, if the activity you
 * are launching uses the singleTask launch mode, it will not run in your
 * task and thus you will immediately receive a cancel result.
 *
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>As a special case, if you call startActivityForResult() with a requestCode
 * &gt;= 0 during the initial onCreate(Bundle savedInstanceState)/onResume() of your
 * activity, then your window will not be displayed until a result is
 * returned back from the started activity.  This is to avoid visible
 * flickering when redirecting to another activity.
 *
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>This method throws <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">ActivityNotFoundException</span></span><span class="token punctuation">}</span>
 * if there was no Activity found to run the given Intent.
 *
 * <span class="token keyword">@param</span> <span class="token parameter">intent</span> The intent to start.
 * <span class="token keyword">@param</span> <span class="token parameter">requestCode</span> If &gt;= 0, this code will be returned in
 *                    onActivityResult() when the activity exits.
 * <span class="token keyword">@param</span> <span class="token parameter">options</span> Additional options for how the Activity should be started.
 * See <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">Context</span><span class="token punctuation">#</span><span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">,</span> <span class="token class-name">Bundle</span><span class="token punctuation">)</span></span>
 * Context.startActivity(Intent, Bundle)<span class="token punctuation">}</span> for more details.
 *
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">ActivityNotFoundException</span></span>
 *
 * <span class="token keyword">@see</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">startActivity</span></span>
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startActivityForResult</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// mParent\u4E5F\u662FActivity\u7C7B\uFF0C\u901A\u8FC7\u540D\u5B57\u5C31\u80FD\u770B\u660E\u767D\u4E86\u3002</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mParent <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// \u5F00\u59CB\u4E86\u554A</span>
		<span class="token class-name">Instrumentation<span class="token punctuation">.</span>ActivityResult</span> ar <span class="token operator">=</span>
			mInstrumentation<span class="token punctuation">.</span><span class="token function">execStartActivity</span><span class="token punctuation">(</span>
				<span class="token keyword">this</span><span class="token punctuation">,</span> mMainThread<span class="token punctuation">.</span><span class="token function">getApplicationThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mToken<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
				intent<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ar <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			mMainThread<span class="token punctuation">.</span><span class="token function">sendActivityResult</span><span class="token punctuation">(</span>
				mToken<span class="token punctuation">,</span> mEmbeddedID<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> ar<span class="token punctuation">.</span><span class="token function">getResultCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				ar<span class="token punctuation">.</span><span class="token function">getResultData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>requestCode <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// If this start is requesting a result, we can avoid making</span>
			<span class="token comment">// the activity visible until the result is received.  Setting</span>
			<span class="token comment">// this code during onCreate(Bundle savedInstanceState) or onResume() will keep the</span>
			<span class="token comment">// activity hidden during this time, to avoid flickering.</span>
			<span class="token comment">// This can only be done when a result is requested because</span>
			<span class="token comment">// that guarantees we will get information back when the</span>
			<span class="token comment">// activity is finished, no matter what happens to it.</span>
			mStartedActivity <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token function">cancelInputsAndStartExitTransition</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// TODO Consider clearing/flushing other event sources and events for child windows.</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			mParent<span class="token punctuation">.</span><span class="token function">startActivityFromChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token comment">// Note we want to go through this method for compatibility with</span>
			<span class="token comment">// existing applications that may have overridden it.</span>
			mParent<span class="token punctuation">.</span><span class="token function">startActivityFromChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span> requestCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u91CC\u9762\u8C03\u7528\u4E86<code>mInstrumentation.execStartActivity</code>\u8FD9\u662F\u5565\u73A9\u610F\uFF0C\u5148\u770B\u4E00\u4E0B<code>mInstrumentation</code>\u5C5E\u6027\uFF0C\u4ED6\u662F<code>Instrumentation</code>\u7C7B\uFF0C\u6211\u4EEC\u770B\u4E0B\u6587\u6863</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Base class for implementing application instrumentation code.  When running
 * with instrumentation turned on, this class will be instantiated for you
 * before any of the application code, allowing you to monitor all of the
 * interaction the system has with the application.  An Instrumentation
 * implementation is described to the system through an AndroidManifest.xml&#39;s
 * <span class="token entity named-entity" title="&lt;">&amp;lt;</span>instrumentation<span class="token entity named-entity" title="&gt;">&amp;gt;</span> tag.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Instrumentation</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u653E\u72D7\u67E5\u4E86\u4E0B<code>Instrumentation</code>\u7684\u610F\u601D\u662F\u4EEA\u5668\u3001\u5DE5\u5177\u3001\u88C5\u7F6E\u7684\u610F\u601D\u3002\u6211\u5C31\u5927\u4F53\u7FFB\u4E00\u4E0B(\u82F1\u8BED\u4E0D\u597D- -~\uFF0C\u53EF\u80FD\u4E0D\u51C6\u786E)\u8BE5\u7C7B\u662F\u5B9E\u73B0\u5E94\u7528\u7A0B\u5E8F\u4EE3\u7801\u7684\u57FA\u7C7B\uFF0C\u5F53\u8BE5\u7C7B\u5728 \u542F\u52A8\u7684\u72B6\u6001\u4E0B\u8FD0\u884C\u65F6\uFF0C\u8BE5\u7C7B\u4F1A\u5728\u5176\u4ED6\u4EFB\u4F55\u5E94\u7528\u7A0B\u5E8F\u8FD0\u884C\u524D\u8FDB\u884C\u521D\u59CB\u5316\uFF0C\u5141\u8BB8\u4F60\u4EF6\u4E8B\u6240\u6709\u5E94\u7528\u7A0B\u5E8F\u4E0E\u7CFB\u7EDF\u7684\u4EA4\u4E92\u3002\u4E00\u4E2A<code>Instrumentation</code>\u5B9E\u4F8B\u4F1A\u901A\u8FC7<code>Manifest</code>\u6587\u4EF6 \u4E2D\u7684<code>&lt;instrumenttation</code>\u6807\u7B7E\u63CF\u8FF0\u7ED9\u7CFB\u7EDF\u3002<br> \u6240\u4EE5\u7EE7\u7EED\u770B\u4E00\u4E0B<code>mInstrumentation.execStartActivity()</code>:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
   // \u4E0B\u9762\u7684\u6CE8\u91CA\u8BF4\u7684\u5F88\u660E\u767D\u4E86\u9ED8\u8BA4\u5B9E\u73B0\u4F1A\u66F4\u65B0\u4EFB\u4F55\u6D3B\u8DC3\u7684\u5BF9\u8C61\u5E76\u5206\u53D1\u7ED9\u7CFB\u7EDF\u7684\`activity manager\`
 * Execute a startActivity call made by the application.  The default 
 * implementation takes care of updating any active <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ActivityMonitor</span></span><span class="token punctuation">}</span>
 * objects and dispatches this call to the system activity manager; you can
 * override this to watch for the application to start an activity, and 
 * modify what happens when it does. 
 *
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>This method returns an <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ActivityResult</span></span><span class="token punctuation">}</span> object, which you can 
 * use when intercepting application calls to avoid performing the start 
 * activity action but still return the result the application is 
 * expecting.  To do this, override this method to catch the call to start 
 * activity so that it returns a new ActivityResult containing the results 
 * you would like the application to see, and don&#39;t call up to the super 
 * class.  Note that an application is only expecting a result if 
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>var</span><span class="token punctuation">&gt;</span></span>requestCode<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>var</span><span class="token punctuation">&gt;</span></span> is <span class="token entity named-entity" title="&gt;">&amp;gt;</span>= 0.
 *
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>This method throws <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">ActivityNotFoundException</span></span><span class="token punctuation">}</span>
 * if there was no Activity found to run the given Intent.
 *
 * <span class="token keyword">@param</span> <span class="token parameter">who</span> The Context from which the activity is being started.
 * <span class="token keyword">@param</span> <span class="token parameter">contextThread</span> The main thread of the Context from which the activity
 *                      is being started.
 * <span class="token keyword">@param</span> <span class="token parameter">token</span> Internal token identifying to the system who is starting 
 *              the activity; may be null.
 * <span class="token keyword">@param</span> <span class="token parameter">target</span> Which activity is performing the start (and thus receiving 
 *               any result); may be null if this call is not being made
 *               from an activity.
 * <span class="token keyword">@param</span> <span class="token parameter">intent</span> The actual Intent to start.
 * <span class="token keyword">@param</span> <span class="token parameter">requestCode</span> Identifier for this request&#39;s result; less than zero 
 *                    if the caller is not expecting a result.
 * <span class="token keyword">@param</span> <span class="token parameter">options</span> Addition options.
 *
 * <span class="token keyword">@return</span> To force the return of a particular result, return an 
 *         ActivityResult object containing the desired data; otherwise
 *         return null.  The default implementation always returns null.
 *
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">ActivityNotFoundException</span></span>
 *
 * <span class="token keyword">@see</span> <span class="token reference"><span class="token class-name">Activity</span><span class="token punctuation">#</span><span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">)</span></span>
 * <span class="token keyword">@see</span> <span class="token reference"><span class="token class-name">Activity</span><span class="token punctuation">#</span><span class="token function">startActivityForResult</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span></span>
 * <span class="token keyword">@see</span> <span class="token reference"><span class="token class-name">Activity</span><span class="token punctuation">#</span><span class="token field">startActivityFromChild</span></span>
 *
 * <span class="token punctuation">{</span><span class="token keyword">@hide</span><span class="token punctuation">}</span>
 */</span>
<span class="token keyword">public</span> <span class="token class-name">ActivityResult</span> <span class="token function">execStartActivity</span><span class="token punctuation">(</span>
		<span class="token class-name">Context</span> who<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> contextThread<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> token<span class="token punctuation">,</span> <span class="token class-name">Activity</span> target<span class="token punctuation">,</span>
		<span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">IApplicationThread</span> whoThread <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span><span class="token punctuation">)</span> contextThread<span class="token punctuation">;</span>
	<span class="token class-name">Uri</span> referrer <span class="token operator">=</span> target <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> target<span class="token punctuation">.</span><span class="token function">onProvideReferrer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>referrer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		intent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>EXTRA_REFERRER<span class="token punctuation">,</span> referrer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mActivityMonitors <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mSync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token class-name">N</span> <span class="token operator">=</span> mActivityMonitors<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token class-name">N</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">final</span> <span class="token class-name">ActivityMonitor</span> am <span class="token operator">=</span> mActivityMonitors<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>am<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>who<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> intent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					am<span class="token punctuation">.</span>mHits<span class="token operator">++</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>am<span class="token punctuation">.</span><span class="token function">isBlocking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token keyword">return</span> requestCode <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">?</span> am<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		intent<span class="token punctuation">.</span><span class="token function">migrateExtraStreamToClipData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		intent<span class="token punctuation">.</span><span class="token function">prepareToLeaveProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// \u901A\u8FC7\u6CE8\u91CA\u7136\u540E\u518D\u7ED3\u5408\u4EE3\u7801\u4E00\u770B\u6211\u4EEC\u5C31\u77E5\u9053\u8FD9\u5E94\u8BE5\u5C31\u662F\u5206\u53D1\u5230\u7CFB\u7EDFactivity manager\u7684\u8FC7\u7A0B</span>
		<span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token class-name">ActivityManagerNative</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">startActivity</span><span class="token punctuation">(</span>whoThread<span class="token punctuation">,</span> who<span class="token punctuation">.</span><span class="token function">getBasePackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span>
					intent<span class="token punctuation">.</span><span class="token function">resolveTypeIfNeeded</span><span class="token punctuation">(</span>who<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					token<span class="token punctuation">,</span> target <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> target<span class="token punctuation">.</span>mEmbeddedID <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
					requestCode<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">checkStartActivityResult</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Failure from system&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u90A3\u5C31\u76F4\u63A5\u770B\u4E0B<code>ActivityManagerNative.getDefault().startActivity()</code>\u65B9\u6CD5\uFF0C\u770B\u4E4B\u524D\u6211\u4EEC\u5148\u770B\u770B<code>ActivityManagerNative.getDefault()</code>\u662F\u4EC0\u4E48\u9B3C:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Retrieve the system&#39;s default/global activity manager.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">public</span> <span class="token class-name">IActivityManager</span> <span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> gDefault<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6CE8\u91CA\u8BF4\u7684\u660E\u767D\u7684\u5C31\u662F\u62FF\u5230\u7CFB\u7EDF\u9ED8\u8BA4/\u5168\u5C40\u7684<code>activity manager</code>\uFF0C\u901A\u8FC7\u540D\u5B57\u4E5F\u80FD\u770B\u51FA\u6765<code>IActivityManager</code>\u662F\u4E2A\u63A5\u53E3\uFF0C\u90A3\u5C31\u7EE7\u7EED\u770B<code>IActivityManager.startActivity()</code>\u65B9\u6CD5\u5427:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span> <span class="token class-name">String</span> callingPackage<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span>
            <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> resultTo<span class="token punctuation">,</span> <span class="token class-name">String</span> resultWho<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span>
            <span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u91CC\u5C31\u987A\u4FBF\u770B\u4E00\u4E0B<code>IActivityManager</code>\u63A5\u53E3\u662F\u795E\u9A6C\u9B3C\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>/**
 * System private API for talking with the activity manager service.  This
 * provides calls from the application back to the activity manager.
 *
 * {@hide}
 */
public interface IActivityManager extends IInterface {
	...
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4F46\u662F\u770B\u5230\u8FD9\u91CC\u6211\u4E0D\u77E5\u9053\u600E\u4E48\u7EE7\u7EED\u5F80\u4E0B\u5206\u6790\u4E86\u554A\uFF0C\u65E2\u7136\u662F\u63A5\u53E3\u6211\u4EEC\u8981\u627E\u5230\u5B9E\u73B0\u7C7B\u554A\uFF0C\u53C8\u662F\u901A\u8FC7<code>ActivityManagerNative.getDefault()</code>\u5F97\u5230\u7684<code>IActivityManager</code>\u5B9E\u4F8B\uFF0C \u6240\u4EE5\u8FD9\u91CC\u6211\u4EEC\u518D\u770B\u4E0B<code>ActivityManagerNative</code>\u7C7B\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/** <span class="token punctuation">{</span><span class="token keyword">@hide</span><span class="token punctuation">}</span> */</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ActivityManagerNative</span> <span class="token keyword">extends</span> <span class="token class-name">Binder</span> <span class="token keyword">implements</span> <span class="token class-name">IActivityManager</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u554A\uFF01 \u9690\u85CF\u7684\uFF0C\u8FDE\u4E2A\u6CE8\u91CA\u4E5F\u6CA1\u6709\uFF0C\u6211\u62D6\u52A8\u4E86\u4E0B\u8FD9\u4E2A\u7C7B\u4E00\u770B<code>5992</code>\u884C\uFF0C\u4E0D\u77E5\u9053\u4ECE\u54EA\u4E0B\u624B\u4E86\uFF0C\u8FD8\u80FD\u4ECE\u54EA\u4E0B\u624B\u554A\uFF0C\u5F53\u7136\u662F\u4ECE<code>ActivityManagerNative.getDefault()</code>\u65B9\u6CD5\u554A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ActivityManagerNative</span> <span class="token keyword">extends</span> <span class="token class-name">Binder</span> <span class="token keyword">implements</span> <span class="token class-name">IActivityManager</span> <span class="token punctuation">{</span>

	<span class="token comment">// \u7EE7\u627FBinder\u63A5\u53E3\uFF0C\u800C\u4E14asInterFace\u65B9\u6CD5\uFF0C\u6211\u597D\u60F3\u660E\u767D\u4E86\u70B9\u4EC0\u4E48</span>
    <span class="token doc-comment comment">/**
     * Cast a Binder object into an activity manager interface, generating
     * a proxy if needed.
     */</span>
    <span class="token keyword">static</span> <span class="token keyword">public</span> <span class="token class-name">IActivityManager</span> <span class="token function">asInterface</span><span class="token punctuation">(</span><span class="token class-name">IBinder</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">IActivityManager</span> in <span class="token operator">=</span>
            <span class="token punctuation">(</span><span class="token class-name">IActivityManager</span><span class="token punctuation">)</span>obj<span class="token punctuation">.</span><span class="token function">queryLocalInterface</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>in <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> in<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ActivityManagerProxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * Retrieve the system&#39;s default/global activity manager.
     */</span>
    <span class="token keyword">static</span> <span class="token keyword">public</span> <span class="token class-name">IActivityManager</span> <span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// \u4F7F\u7528\u4E86getDefaule\u7684get\u65B9\u6CD5</span>
        <span class="token keyword">return</span> gDefault<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>	
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7EE7\u7EED\u770B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Singleton</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IActivityManager</span><span class="token punctuation">&gt;</span></span> gDefault <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IActivityManager</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">protected</span> <span class="token class-name">IActivityManager</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token comment">// \u8FDB\u7A0B\u95F4\u901A\u4FE1\u4E86</span>
		<span class="token class-name">IBinder</span> b <span class="token operator">=</span> <span class="token class-name">ServiceManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token string">&quot;activity&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token string">&quot;ActivityManager&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;default service binder = &quot;</span> <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// \u770B\u5230\u4E86\u5417\uFF1F\u7528\u5230\u4E86\u521A\u624D\u6211\u4EEC\u8BF4\u7684asInterface\u65B9\u6CD5</span>
		<span class="token class-name">IActivityManager</span> am <span class="token operator">=</span> <span class="token function">asInterface</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token string">&quot;ActivityManager&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;default service = &quot;</span> <span class="token operator">+</span> am<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> am<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u597D\u4E86\uFF0C\u6211\u4EEC\u518D\u770B\u4E0B<code>asInterface()</code>\u65B9\u6CD5:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">public</span> <span class="token class-name">IActivityManager</span> <span class="token function">asInterface</span><span class="token punctuation">(</span><span class="token class-name">IBinder</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token class-name">IActivityManager</span> in <span class="token operator">=</span>
		<span class="token punctuation">(</span><span class="token class-name">IActivityManager</span><span class="token punctuation">)</span>obj<span class="token punctuation">.</span><span class="token function">queryLocalInterface</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>in <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> in<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// \u5728\u8FD9\u91CC</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ActivityManagerProxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7EC8\u4E8E\u627E\u5230\u4E86\u5176\u5B9E\u5C31\u662F<code>ActivityManagerProxy</code>\u7C7B\uFF0C\u521A\u624D\u6211\u4EEC\u627E\u5230<code>IActivityManager</code>\u63A5\u53E3\u7684<code>startActivity()</code> \u65B9\u6CD5\uFF0C\u73B0\u5728\u7EC8\u4E8E\u627E\u5230\u4E86\u5728\u8FD9\u91CC\u4F7F\u7528\u7684\u662F<code>IActivityManager</code>\u63A5\u53E3\u5B9E\u73B0\u7C7B\u7684 <code>ActivityManagerProxy</code>\u7C7B\uFF0C\u6211\u4EEC\u6765\u770B\u4E00\u4E0B\u8BE5\u7C7B\u5B9E\u73B0\u7684<code>startActivity()</code>\u65B9\u6CD5:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">ActivityManagerProxy</span> <span class="token keyword">implements</span> <span class="token class-name">IActivityManager</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">ActivityManagerProxy</span><span class="token punctuation">(</span><span class="token class-name">IBinder</span> remote<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        mRemote <span class="token operator">=</span> remote<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">IBinder</span> <span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> mRemote<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span> <span class="token class-name">String</span> callingPackage<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span>
			<span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> resultTo<span class="token punctuation">,</span> <span class="token class-name">String</span> resultWho<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span>
			<span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> <span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{</span>
		<span class="token class-name">Parcel</span> data <span class="token operator">=</span> <span class="token class-name">Parcel</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Parcel</span> reply <span class="token operator">=</span> <span class="token class-name">Parcel</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeInterfaceToken</span><span class="token punctuation">(</span><span class="token class-name">IActivityManager</span><span class="token punctuation">.</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeStrongBinder</span><span class="token punctuation">(</span>caller <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> caller<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>callingPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
		intent<span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>resolvedType<span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeStrongBinder</span><span class="token punctuation">(</span>resultTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>resultWho<span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>startFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>profilerInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			data<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			profilerInfo<span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token class-name">Parcelable</span><span class="token punctuation">.</span>PARCELABLE_WRITE_RETURN_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			data<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			data<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			options<span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			data<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		mRemote<span class="token punctuation">.</span><span class="token function">transact</span><span class="token punctuation">(</span>START_ACTIVITY_TRANSACTION<span class="token punctuation">,</span> data<span class="token punctuation">,</span> reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		reply<span class="token punctuation">.</span><span class="token function">readException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> result <span class="token operator">=</span> reply<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		reply<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> result<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>	
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u518D\u7EE7\u7EED\u6211\u5C31\u4E0D\u77E5\u9053\u8D70\u5230\u54EA\u91CC\u4E86.... \u8FD9\u4E00\u5757\u5176\u5B9E\u662F\u7528\u4E86<code>Binder</code>\u673A\u5236\uFF0C\u4E0A\u9762\u7684<code>IActivityManager.getDefault()</code>\u65B9\u6CD5\u8FD4\u56DE\u7684\u662F<code>ActivityManagerService</code>\u7684\u8FDC\u7A0B\u63A5\u53E3\uFF0C\u6240\u4EE5\u63A5\u4E0B\u6765 \u6211\u4EEC\u5E94\u8BE5\u770B\u4E00\u4E0B<code>ActivityManagerService.startActivity()</code>\u7C7B\u3002(\u5177\u4F53<code>Binder</code>\u673A\u5236\u6211\u4EEC\u540E\u7EED\u4F1A\u4E13\u95E8\u5199\u4E00\u7BC7\u6587\u7AE0\uFF0C\u8FD9\u91CC\u5C31\u4E0D\u8BF4\u4E86\uFF0C\u4E0D\u7136\u5C31\u8BF4\u4E0D\u5B8C\u4E86)</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span> <span class="token class-name">String</span> callingPackage<span class="token punctuation">,</span>
		<span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> resultTo<span class="token punctuation">,</span> <span class="token class-name">String</span> resultWho<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span>
		<span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> <span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">startActivityAsUser</span><span class="token punctuation">(</span>caller<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> resultTo<span class="token punctuation">,</span>
		resultWho<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span> profilerInfo<span class="token punctuation">,</span> options<span class="token punctuation">,</span>
		<span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">getCallingUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7EE7\u7EED\u770B\u4E0B<code>startActivityAsUser()</code>\u65B9\u6CD5:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">startActivityAsUser</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span> <span class="token class-name">String</span> callingPackage<span class="token punctuation">,</span>
		<span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> resultTo<span class="token punctuation">,</span> <span class="token class-name">String</span> resultWho<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span>
		<span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> <span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">enforceNotIsolatedCaller</span><span class="token punctuation">(</span><span class="token string">&quot;startActivity&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	userId <span class="token operator">=</span> <span class="token function">handleIncomingUser</span><span class="token punctuation">(</span><span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span>
			<span class="token boolean">false</span><span class="token punctuation">,</span> ALLOW_FULL_ONLY<span class="token punctuation">,</span> <span class="token string">&quot;startActivity&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// TODO: Switch to user app stacks here.</span>
	<span class="token keyword">return</span> mStackSupervisor<span class="token punctuation">.</span><span class="token function">startActivityMayWait</span><span class="token punctuation">(</span>caller<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span> intent<span class="token punctuation">,</span>
			resolvedType<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> resultTo<span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span>
			profilerInfo<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7EE7\u7EED\u770B\u4E00\u4E0B<code>mStackSupervisor.startActivityMayWait()</code>\u65B9\u6CD5,\u8FD9\u91CC<code>mStackSupervisor</code>\u662F<code>ActivityStackSupervisor</code>\u7C7B:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">startActivityMayWait</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span> <span class="token keyword">int</span> callingUid<span class="token punctuation">,</span>
		<span class="token class-name">String</span> callingPackage<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span>
		<span class="token class-name">IVoiceInteractionSession</span> voiceSession<span class="token punctuation">,</span> <span class="token class-name">IVoiceInteractor</span> voiceInteractor<span class="token punctuation">,</span>
		<span class="token class-name">IBinder</span> resultTo<span class="token punctuation">,</span> <span class="token class-name">String</span> resultWho<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span>
		<span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">,</span> <span class="token class-name">WaitResult</span> outResult<span class="token punctuation">,</span> <span class="token class-name">Configuration</span> config<span class="token punctuation">,</span>
		<span class="token class-name">Bundle</span> options<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ignoreTargetSecurity<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">,</span>
		<span class="token class-name">IActivityContainer</span> iContainer<span class="token punctuation">,</span> <span class="token class-name">TaskRecord</span> inTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Refuse possible leaked file descriptors</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>intent <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> intent<span class="token punctuation">.</span><span class="token function">hasFileDescriptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;File descriptors passed in Intent&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">boolean</span> componentSpecified <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

	<span class="token comment">// Don&#39;t modify the client&#39;s object!</span>
	intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// \u89E3\u6790\u51FA\u8981\u5F00\u542F\u7684Activity\u7684\u4FE1\u606F\uFF0C\u5305\u540D\u3001\u7C7B\u540D\u3001\u53C2\u6570\u7B49\u3002</span>
	<span class="token comment">// Collect information about the target of the Intent.</span>
	<span class="token class-name">ActivityInfo</span> aInfo <span class="token operator">=</span>
			<span class="token function">resolveActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span> profilerInfo<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token class-name">ActivityContainer</span> container <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ActivityContainer</span><span class="token punctuation">)</span>iContainer<span class="token punctuation">;</span>
	<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>container <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> container<span class="token punctuation">.</span>mParentActivity <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
				container<span class="token punctuation">.</span>mParentActivity<span class="token punctuation">.</span>state <span class="token operator">!=</span> RESUMED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// Cannot start a child activity if the parent is not resumed.</span>
			<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_CANCELED<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">final</span> <span class="token keyword">int</span> realCallingPid <span class="token operator">=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">final</span> <span class="token keyword">int</span> realCallingUid <span class="token operator">=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> callingPid<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>callingUid <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			callingPid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>caller <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			callingPid <span class="token operator">=</span> realCallingPid<span class="token punctuation">;</span>
			callingUid <span class="token operator">=</span> realCallingUid<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			callingPid <span class="token operator">=</span> callingUid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">final</span> <span class="token class-name">ActivityStack</span> stack<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>container <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> container<span class="token punctuation">.</span>mStack<span class="token punctuation">.</span><span class="token function">isOnHomeDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			stack <span class="token operator">=</span> mFocusedStack<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			stack <span class="token operator">=</span> container<span class="token punctuation">.</span>mStack<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		stack<span class="token punctuation">.</span>mConfigWillChange <span class="token operator">=</span> config <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mService<span class="token punctuation">.</span>mConfiguration<span class="token punctuation">.</span><span class="token function">diff</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_CONFIGURATION<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_CONFIGURATION<span class="token punctuation">,</span>
				<span class="token string">&quot;Starting activity when config will change = &quot;</span> <span class="token operator">+</span> stack<span class="token punctuation">.</span>mConfigWillChange<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">final</span> <span class="token keyword">long</span> origId <span class="token operator">=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>aInfo <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
				<span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>privateFlags
						<span class="token operator">&amp;</span><span class="token class-name">ApplicationInfo</span><span class="token punctuation">.</span>PRIVATE_FLAG_CANT_SAVE_STATE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// This may be a heavy-weight process!  Check to see if we already</span>
			<span class="token comment">// have another, different heavy-weight process running.</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>processName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mHeavyWeightProcess <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
						<span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mHeavyWeightProcess<span class="token punctuation">.</span>info<span class="token punctuation">.</span>uid <span class="token operator">!=</span> aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid <span class="token operator">||</span>
						<span class="token operator">!</span>mService<span class="token punctuation">.</span>mHeavyWeightProcess<span class="token punctuation">.</span>processName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">int</span> appCallingUid <span class="token operator">=</span> callingUid<span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>caller <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token class-name">ProcessRecord</span> callerApp <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getRecordForAppLocked</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>callerApp <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							appCallingUid <span class="token operator">=</span> callerApp<span class="token punctuation">.</span>info<span class="token punctuation">.</span>uid<span class="token punctuation">;</span>
						<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
							<span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Unable to find app for caller &quot;</span> <span class="token operator">+</span> caller
								  <span class="token operator">+</span> <span class="token string">&quot; (pid=&quot;</span> <span class="token operator">+</span> callingPid <span class="token operator">+</span> <span class="token string">&quot;) when starting: &quot;</span>
								  <span class="token operator">+</span> intent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token class-name">ActivityOptions</span><span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_PERMISSION_DENIED<span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>

					<span class="token class-name">IIntentSender</span> target <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getIntentSenderLocked</span><span class="token punctuation">(</span>
							<span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>INTENT_SENDER_ACTIVITY<span class="token punctuation">,</span> <span class="token string">&quot;android&quot;</span><span class="token punctuation">,</span>
							appCallingUid<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> intent <span class="token punctuation">}</span><span class="token punctuation">,</span>
							<span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> resolvedType <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">PendingIntent</span><span class="token punctuation">.</span>FLAG_CANCEL_CURRENT
							<span class="token operator">|</span> <span class="token class-name">PendingIntent</span><span class="token punctuation">.</span>FLAG_ONE_SHOT<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token class-name">Intent</span> newIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>requestCode <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token comment">// Caller is requesting a result.</span>
						newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span><span class="token class-name">HeavyWeightSwitcherActivity</span><span class="token punctuation">.</span>KEY_HAS_RESULT<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span><span class="token class-name">HeavyWeightSwitcherActivity</span><span class="token punctuation">.</span>KEY_INTENT<span class="token punctuation">,</span>
							<span class="token keyword">new</span> <span class="token class-name">IntentSender</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mHeavyWeightProcess<span class="token punctuation">.</span>activities<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token class-name">ActivityRecord</span> hist <span class="token operator">=</span> mService<span class="token punctuation">.</span>mHeavyWeightProcess<span class="token punctuation">.</span>activities<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span><span class="token class-name">HeavyWeightSwitcherActivity</span><span class="token punctuation">.</span>KEY_CUR_APP<span class="token punctuation">,</span>
								hist<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
						newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span><span class="token class-name">HeavyWeightSwitcherActivity</span><span class="token punctuation">.</span>KEY_CUR_TASK<span class="token punctuation">,</span>
								hist<span class="token punctuation">.</span>task<span class="token punctuation">.</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span><span class="token class-name">HeavyWeightSwitcherActivity</span><span class="token punctuation">.</span>KEY_NEW_APP<span class="token punctuation">,</span>
							aInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
					newIntent<span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					newIntent<span class="token punctuation">.</span><span class="token function">setClassName</span><span class="token punctuation">(</span><span class="token string">&quot;android&quot;</span><span class="token punctuation">,</span>
							<span class="token class-name">HeavyWeightSwitcherActivity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					intent <span class="token operator">=</span> newIntent<span class="token punctuation">;</span>
					resolvedType <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
					caller <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
					callingUid <span class="token operator">=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					callingPid <span class="token operator">=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					componentSpecified <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
					<span class="token keyword">try</span> <span class="token punctuation">{</span>
						<span class="token class-name">ResolveInfo</span> rInfo <span class="token operator">=</span>
							<span class="token class-name">AppGlobals</span><span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resolveIntent</span><span class="token punctuation">(</span>
									intent<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
									<span class="token class-name">PackageManager</span><span class="token punctuation">.</span>MATCH_DEFAULT_ONLY
									<span class="token operator">|</span> <span class="token class-name">ActivityManagerService</span><span class="token punctuation">.</span>STOCK_PM_FLAGS<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
						aInfo <span class="token operator">=</span> rInfo <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> rInfo<span class="token punctuation">.</span>activityInfo <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
						aInfo <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getActivityInfoForUser</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						aInfo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// \u6839\u636E\u4E0A\u9762\u89E3\u6790\u7684\u5185\u5BB9\u53BB\u5F00\u542F\u4E86\u3002\u3002\u3002</span>
		<span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">startActivityLocked</span><span class="token punctuation">(</span>caller<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> aInfo<span class="token punctuation">,</span>
				voiceSession<span class="token punctuation">,</span> voiceInteractor<span class="token punctuation">,</span> resultTo<span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span>
				requestCode<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span>
				realCallingPid<span class="token punctuation">,</span> realCallingUid<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span> options<span class="token punctuation">,</span> ignoreTargetSecurity<span class="token punctuation">,</span>
				componentSpecified<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> container<span class="token punctuation">,</span> inTask<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>origId<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>stack<span class="token punctuation">.</span>mConfigWillChange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// If the caller also wants to switch to a new configuration,</span>
			<span class="token comment">// do so now.  This allows a clean switch, as we are waiting</span>
			<span class="token comment">// for the current activity to pause (so we will not destroy</span>
			<span class="token comment">// it), and have not yet started the next activity.</span>
			mService<span class="token punctuation">.</span><span class="token function">enforceCallingPermission</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span></span>Manifest</span><span class="token punctuation">.</span>permission<span class="token punctuation">.</span>CHANGE_CONFIGURATION<span class="token punctuation">,</span>
					<span class="token string">&quot;updateConfiguration()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			stack<span class="token punctuation">.</span>mConfigWillChange <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_CONFIGURATION<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_CONFIGURATION<span class="token punctuation">,</span>
					<span class="token string">&quot;Updating to new configuration after starting activity.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			mService<span class="token punctuation">.</span><span class="token function">updateConfigurationLocked</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>outResult <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			outResult<span class="token punctuation">.</span>result <span class="token operator">=</span> res<span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				mWaitingActivityLaunched<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>outResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">do</span> <span class="token punctuation">{</span>
					<span class="token keyword">try</span> <span class="token punctuation">{</span>
						mService<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>outResult<span class="token punctuation">.</span>timeout <span class="token operator">&amp;&amp;</span> outResult<span class="token punctuation">.</span>who <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_TASK_TO_FRONT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">ActivityRecord</span> r <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">topRunningActivityLocked</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>nowVisible <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>state <span class="token operator">==</span> RESUMED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					outResult<span class="token punctuation">.</span>timeout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
					outResult<span class="token punctuation">.</span>who <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
					outResult<span class="token punctuation">.</span>totalTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
					outResult<span class="token punctuation">.</span>thisTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					outResult<span class="token punctuation">.</span>thisTime <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					mWaitingActivityVisible<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>outResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">do</span> <span class="token punctuation">{</span>
						<span class="token keyword">try</span> <span class="token punctuation">{</span>
							mService<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>outResult<span class="token punctuation">.</span>timeout <span class="token operator">&amp;&amp;</span> outResult<span class="token punctuation">.</span>who <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">return</span> res<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u90A3\u5C31\u7EE7\u7EED\u770B\u4E00\u4E0B<code>startActivityLocked()</code>\u65B9\u6CD5:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">startActivityLocked</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span>
		<span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span> <span class="token class-name">ActivityInfo</span> aInfo<span class="token punctuation">,</span>
		<span class="token class-name">IVoiceInteractionSession</span> voiceSession<span class="token punctuation">,</span> <span class="token class-name">IVoiceInteractor</span> voiceInteractor<span class="token punctuation">,</span>
		<span class="token class-name">IBinder</span> resultTo<span class="token punctuation">,</span> <span class="token class-name">String</span> resultWho<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span>
		<span class="token keyword">int</span> callingPid<span class="token punctuation">,</span> <span class="token keyword">int</span> callingUid<span class="token punctuation">,</span> <span class="token class-name">String</span> callingPackage<span class="token punctuation">,</span>
		<span class="token keyword">int</span> realCallingPid<span class="token punctuation">,</span> <span class="token keyword">int</span> realCallingUid<span class="token punctuation">,</span> <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">,</span>
		<span class="token keyword">boolean</span> ignoreTargetSecurity<span class="token punctuation">,</span> <span class="token keyword">boolean</span> componentSpecified<span class="token punctuation">,</span> <span class="token class-name">ActivityRecord</span><span class="token punctuation">[</span><span class="token punctuation">]</span> outActivity<span class="token punctuation">,</span>
		<span class="token class-name">ActivityContainer</span> container<span class="token punctuation">,</span> <span class="token class-name">TaskRecord</span> inTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_SUCCESS<span class="token punctuation">;</span>

	<span class="token class-name">ProcessRecord</span> callerApp <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>caller <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// mService\u5C31\u662FActivityManagerService\u7C7B</span>
		callerApp <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getRecordForAppLocked</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>callerApp <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			callingPid <span class="token operator">=</span> callerApp<span class="token punctuation">.</span>pid<span class="token punctuation">;</span>
			callingUid <span class="token operator">=</span> callerApp<span class="token punctuation">.</span>info<span class="token punctuation">.</span>uid<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Unable to find app for caller &quot;</span> <span class="token operator">+</span> caller
				  <span class="token operator">+</span> <span class="token string">&quot; (pid=&quot;</span> <span class="token operator">+</span> callingPid <span class="token operator">+</span> <span class="token string">&quot;) when starting: &quot;</span>
				  <span class="token operator">+</span> intent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			err <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_PERMISSION_DENIED<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">final</span> <span class="token keyword">int</span> userId <span class="token operator">=</span> aInfo <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;START u&quot;</span> <span class="token operator">+</span> userId <span class="token operator">+</span> <span class="token string">&quot; {&quot;</span> <span class="token operator">+</span> intent<span class="token punctuation">.</span><span class="token function">toShortString</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
				<span class="token operator">+</span> <span class="token string">&quot;} from uid &quot;</span> <span class="token operator">+</span> callingUid
				<span class="token operator">+</span> <span class="token string">&quot; on display &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>container <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token punctuation">(</span>mFocusedStack <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span>
						<span class="token class-name">Display</span><span class="token punctuation">.</span>DEFAULT_DISPLAY <span class="token operator">:</span> mFocusedStack<span class="token punctuation">.</span>mDisplayId<span class="token punctuation">)</span> <span class="token operator">:</span>
						<span class="token punctuation">(</span>container<span class="token punctuation">.</span>mActivityDisplay <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">Display</span><span class="token punctuation">.</span>DEFAULT_DISPLAY <span class="token operator">:</span>
								container<span class="token punctuation">.</span>mActivityDisplay<span class="token punctuation">.</span>mDisplayId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token class-name">ActivityRecord</span> sourceRecord <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token class-name">ActivityRecord</span> resultRecord <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>resultTo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		sourceRecord <span class="token operator">=</span> <span class="token function">isInAnyStackLocked</span><span class="token punctuation">(</span>resultTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_RESULTS<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_RESULTS<span class="token punctuation">,</span>
				<span class="token string">&quot;Will send result to &quot;</span> <span class="token operator">+</span> resultTo <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> sourceRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>sourceRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>requestCode <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>sourceRecord<span class="token punctuation">.</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				resultRecord <span class="token operator">=</span> sourceRecord<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">final</span> <span class="token keyword">int</span> launchFlags <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>launchFlags <span class="token operator">&amp;</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_FORWARD_RESULT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> sourceRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// Transfer the result target from the source activity to the new</span>
		<span class="token comment">// one being started, including any failures.</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>requestCode <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">ActivityOptions</span><span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_FORWARD_AND_REQUEST_CONFLICT<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		resultRecord <span class="token operator">=</span> sourceRecord<span class="token punctuation">.</span>resultTo<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>resultRecord <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>resultRecord<span class="token punctuation">.</span><span class="token function">isInStackLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			resultRecord <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		resultWho <span class="token operator">=</span> sourceRecord<span class="token punctuation">.</span>resultWho<span class="token punctuation">;</span>
		requestCode <span class="token operator">=</span> sourceRecord<span class="token punctuation">.</span>requestCode<span class="token punctuation">;</span>
		sourceRecord<span class="token punctuation">.</span>resultTo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>resultRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			resultRecord<span class="token punctuation">.</span><span class="token function">removeResultsLocked</span><span class="token punctuation">(</span>sourceRecord<span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span> requestCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>sourceRecord<span class="token punctuation">.</span>launchedFromUid <span class="token operator">==</span> callingUid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// The new activity is being launched from the same uid as the previous</span>
			<span class="token comment">// activity in the flow, and asking to forward its result back to the</span>
			<span class="token comment">// previous.  In this case the activity is serving as a trampoline between</span>
			<span class="token comment">// the two, so we also want to update its launchedFromPackage to be the</span>
			<span class="token comment">// same as the previous activity.  Note that this is safe, since we know</span>
			<span class="token comment">// these two packages come from the same uid; the caller could just as</span>
			<span class="token comment">// well have supplied that same package name itself.  This specifially</span>
			<span class="token comment">// deals with the case of an intent picker/chooser being launched in the app</span>
			<span class="token comment">// flow to redirect to an activity picked by the user, where we want the final</span>
			<span class="token comment">// activity to consider it to have been launched by the previous app activity.</span>
			callingPackage <span class="token operator">=</span> sourceRecord<span class="token punctuation">.</span>launchedFromPackage<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_SUCCESS <span class="token operator">&amp;&amp;</span> intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// We couldn&#39;t find a class that can handle the given Intent.</span>
		<span class="token comment">// That&#39;s the end of that!</span>
		err <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_INTENT_NOT_RESOLVED<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_SUCCESS <span class="token operator">&amp;&amp;</span> aInfo <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// We couldn&#39;t find the specific class specified in the Intent.</span>
		<span class="token comment">// Also the end of the line.</span>
		err <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_CLASS_NOT_FOUND<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_SUCCESS
			<span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isCurrentProfileLocked</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span>
			<span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> FLAG_SHOW_FOR_ALL_USERS<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// Trying to launch a background activity that doesn&#39;t show for all users.</span>
		err <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_NOT_CURRENT_USER_ACTIVITY<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_SUCCESS <span class="token operator">&amp;&amp;</span> sourceRecord <span class="token operator">!=</span> <span class="token keyword">null</span>
			<span class="token operator">&amp;&amp;</span> sourceRecord<span class="token punctuation">.</span>task<span class="token punctuation">.</span>voiceSession <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// If this activity is being launched as part of a voice session, we need</span>
		<span class="token comment">// to ensure that it is safe to do so.  If the upcoming activity will also</span>
		<span class="token comment">// be part of the voice session, we can only launch it if it has explicitly</span>
		<span class="token comment">// said it supports the VOICE category, or it is a part of the calling app.</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>launchFlags <span class="token operator">&amp;</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_NEW_TASK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
				<span class="token operator">&amp;&amp;</span> sourceRecord<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid <span class="token operator">!=</span> aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">try</span> <span class="token punctuation">{</span>
				intent<span class="token punctuation">.</span><span class="token function">addCategory</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>CATEGORY_VOICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">AppGlobals</span><span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">activitySupportsIntent</span><span class="token punctuation">(</span>
						intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span>
							<span class="token string">&quot;Activity being started in current voice task does not support voice: &quot;</span>
							<span class="token operator">+</span> intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
					err <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_NOT_VOICE_COMPATIBLE<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Failure checking voice capabilities&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
				err <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_NOT_VOICE_COMPATIBLE<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_SUCCESS <span class="token operator">&amp;&amp;</span> voiceSession <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// If the caller is starting a new voice session, just make sure the target</span>
		<span class="token comment">// is actually allowing it to run this way.</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">AppGlobals</span><span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">activitySupportsIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span>
						<span class="token string">&quot;Activity being started in new voice task does not support: &quot;</span>
						<span class="token operator">+</span> intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
				err <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_NOT_VOICE_COMPATIBLE<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Failure checking voice capabilities&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
			err <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_NOT_VOICE_COMPATIBLE<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Activity\u6808</span>
	<span class="token keyword">final</span> <span class="token class-name">ActivityStack</span> resultStack <span class="token operator">=</span> resultRecord <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> resultRecord<span class="token punctuation">.</span>task<span class="token punctuation">.</span>stack<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>resultRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			resultStack<span class="token punctuation">.</span><span class="token function">sendActivityResultLocked</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
				resultRecord<span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span>
				<span class="token class-name">Activity</span><span class="token punctuation">.</span>RESULT_CANCELED<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token class-name">ActivityOptions</span><span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> err<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">boolean</span> abort <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

	<span class="token keyword">final</span> <span class="token keyword">int</span> startAnyPerm <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">checkPermission</span><span class="token punctuation">(</span>
			START_ANY_ACTIVITY<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>startAnyPerm <span class="token operator">!=</span> PERMISSION_GRANTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">final</span> <span class="token keyword">int</span> componentRestriction <span class="token operator">=</span> <span class="token function">getComponentRestrictionForCallingPackage</span><span class="token punctuation">(</span>
				aInfo<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> ignoreTargetSecurity<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">final</span> <span class="token keyword">int</span> actionRestriction <span class="token operator">=</span> <span class="token function">getActionRestrictionForCallingPackage</span><span class="token punctuation">(</span>
				intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>componentRestriction <span class="token operator">==</span> ACTIVITY_RESTRICTION_PERMISSION
				<span class="token operator">||</span> actionRestriction <span class="token operator">==</span> ACTIVITY_RESTRICTION_PERMISSION<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>resultRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				resultStack<span class="token punctuation">.</span><span class="token function">sendActivityResultLocked</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
						resultRecord<span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span>
						<span class="token class-name">Activity</span><span class="token punctuation">.</span>RESULT_CANCELED<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token class-name">String</span> msg<span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>actionRestriction <span class="token operator">==</span> ACTIVITY_RESTRICTION_PERMISSION<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				msg <span class="token operator">=</span> <span class="token string">&quot;Permission Denial: starting &quot;</span> <span class="token operator">+</span> intent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
						<span class="token operator">+</span> <span class="token string">&quot; from &quot;</span> <span class="token operator">+</span> callerApp <span class="token operator">+</span> <span class="token string">&quot; (pid=&quot;</span> <span class="token operator">+</span> callingPid
						<span class="token operator">+</span> <span class="token string">&quot;, uid=&quot;</span> <span class="token operator">+</span> callingUid <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span> <span class="token operator">+</span> <span class="token string">&quot; with revoked permission &quot;</span>
						<span class="token operator">+</span> ACTION_TO_RUNTIME_PERMISSION<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>aInfo<span class="token punctuation">.</span>exported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				msg <span class="token operator">=</span> <span class="token string">&quot;Permission Denial: starting &quot;</span> <span class="token operator">+</span> intent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
						<span class="token operator">+</span> <span class="token string">&quot; from &quot;</span> <span class="token operator">+</span> callerApp <span class="token operator">+</span> <span class="token string">&quot; (pid=&quot;</span> <span class="token operator">+</span> callingPid
						<span class="token operator">+</span> <span class="token string">&quot;, uid=&quot;</span> <span class="token operator">+</span> callingUid <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span>
						<span class="token operator">+</span> <span class="token string">&quot; not exported from uid &quot;</span> <span class="token operator">+</span> aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				msg <span class="token operator">=</span> <span class="token string">&quot;Permission Denial: starting &quot;</span> <span class="token operator">+</span> intent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
						<span class="token operator">+</span> <span class="token string">&quot; from &quot;</span> <span class="token operator">+</span> callerApp <span class="token operator">+</span> <span class="token string">&quot; (pid=&quot;</span> <span class="token operator">+</span> callingPid
						<span class="token operator">+</span> <span class="token string">&quot;, uid=&quot;</span> <span class="token operator">+</span> callingUid <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span>
						<span class="token operator">+</span> <span class="token string">&quot; requires &quot;</span> <span class="token operator">+</span> aInfo<span class="token punctuation">.</span>permission<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>actionRestriction <span class="token operator">==</span> ACTIVITY_RESTRICTION_APPOP<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">&quot;Appop Denial: starting &quot;</span> <span class="token operator">+</span> intent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					<span class="token operator">+</span> <span class="token string">&quot; from &quot;</span> <span class="token operator">+</span> callerApp <span class="token operator">+</span> <span class="token string">&quot; (pid=&quot;</span> <span class="token operator">+</span> callingPid
					<span class="token operator">+</span> <span class="token string">&quot;, uid=&quot;</span> <span class="token operator">+</span> callingUid <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span>
					<span class="token operator">+</span> <span class="token string">&quot; requires &quot;</span> <span class="token operator">+</span> <span class="token class-name">AppOpsManager</span><span class="token punctuation">.</span><span class="token function">permissionToOp</span><span class="token punctuation">(</span>
							ACTION_TO_RUNTIME_PERMISSION<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
			abort <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>componentRestriction <span class="token operator">==</span> ACTIVITY_RESTRICTION_APPOP<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">&quot;Appop Denial: starting &quot;</span> <span class="token operator">+</span> intent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					<span class="token operator">+</span> <span class="token string">&quot; from &quot;</span> <span class="token operator">+</span> callerApp <span class="token operator">+</span> <span class="token string">&quot; (pid=&quot;</span> <span class="token operator">+</span> callingPid
					<span class="token operator">+</span> <span class="token string">&quot;, uid=&quot;</span> <span class="token operator">+</span> callingUid <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span>
					<span class="token operator">+</span> <span class="token string">&quot; requires appop &quot;</span> <span class="token operator">+</span> <span class="token class-name">AppOpsManager</span><span class="token punctuation">.</span><span class="token function">permissionToOp</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>permission<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
			abort <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	abort <span class="token operator">|=</span> <span class="token operator">!</span>mService<span class="token punctuation">.</span>mIntentFirewall<span class="token punctuation">.</span><span class="token function">checkStartActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span>
			callingPid<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mController <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token comment">// The Intent we give to the watcher has the extra data</span>
			<span class="token comment">// stripped off, since it can contain private information.</span>
			<span class="token class-name">Intent</span> watchIntent <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">cloneFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			abort <span class="token operator">|=</span> <span class="token operator">!</span>mService<span class="token punctuation">.</span>mController<span class="token punctuation">.</span><span class="token function">activityStarting</span><span class="token punctuation">(</span>watchIntent<span class="token punctuation">,</span>
					aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			mService<span class="token punctuation">.</span>mController <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>abort<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>resultRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			resultStack<span class="token punctuation">.</span><span class="token function">sendActivityResultLocked</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> resultRecord<span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span>
					<span class="token class-name">Activity</span><span class="token punctuation">.</span>RESULT_CANCELED<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// We pretend to the caller that it was really started, but</span>
		<span class="token comment">// they will just get a cancel result.</span>
		<span class="token class-name">ActivityOptions</span><span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_SUCCESS<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// ActivityRecord: An entry in the history stack, representing an activity.</span>
	<span class="token class-name">ActivityRecord</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityRecord</span><span class="token punctuation">(</span>mService<span class="token punctuation">,</span> callerApp<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span>
			intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> aInfo<span class="token punctuation">,</span> mService<span class="token punctuation">.</span>mConfiguration<span class="token punctuation">,</span> resultRecord<span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span>
			requestCode<span class="token punctuation">,</span> componentSpecified<span class="token punctuation">,</span> voiceSession <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> container<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>outActivity <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		outActivity<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> r<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>appTimeTracker <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> sourceRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// If the caller didn&#39;t specify an explicit time tracker, we want to continue</span>
		<span class="token comment">// tracking under any it has.</span>
		r<span class="token punctuation">.</span>appTimeTracker <span class="token operator">=</span> sourceRecord<span class="token punctuation">.</span>appTimeTracker<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">final</span> <span class="token class-name">ActivityStack</span> stack <span class="token operator">=</span> mFocusedStack<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>voiceSession <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>stack<span class="token punctuation">.</span>mResumedActivity <span class="token operator">==</span> <span class="token keyword">null</span>
			<span class="token operator">||</span> stack<span class="token punctuation">.</span>mResumedActivity<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid <span class="token operator">!=</span> callingUid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mService<span class="token punctuation">.</span><span class="token function">checkAppSwitchAllowedLocked</span><span class="token punctuation">(</span>callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span>
				realCallingPid<span class="token punctuation">,</span> realCallingUid<span class="token punctuation">,</span> <span class="token string">&quot;Activity start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">PendingActivityLaunch</span> pal <span class="token operator">=</span>
					<span class="token keyword">new</span> <span class="token class-name">PendingActivityLaunch</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> sourceRecord<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span> stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
			mPendingActivityLaunches<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pal<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">ActivityOptions</span><span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_SWITCHES_CANCELED<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mDidAppSwitch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// This is the second allowed switch since we stopped switches,</span>
		<span class="token comment">// so now just generally allow switches.  Use case: user presses</span>
		<span class="token comment">// home (switches disabled, switch to home, mDidAppSwitch now true);</span>
		<span class="token comment">// user taps a home icon (coming from home so allowed, we hit here</span>
		<span class="token comment">// and now allow anyone to switch again).</span>
		mService<span class="token punctuation">.</span>mAppSwitchesAllowedTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		mService<span class="token punctuation">.</span>mDidAppSwitch <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">doPendingActivityLaunchesLocked</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// \u7EE7\u7EED\u8C03\u7528\u65B9\u6CD5</span>
	err <span class="token operator">=</span> <span class="token function">startActivityUncheckedLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> sourceRecord<span class="token punctuation">,</span> voiceSession<span class="token punctuation">,</span> voiceInteractor<span class="token punctuation">,</span>
			startFlags<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> options<span class="token punctuation">,</span> inTask<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// If someone asked to have the keyguard dismissed on the next</span>
		<span class="token comment">// activity start, but we are not actually doing an activity</span>
		<span class="token comment">// switch...  just dismiss the keyguard now, because we</span>
		<span class="token comment">// probably want to see whatever is behind it.</span>
		<span class="token function">notifyActivityDrawnForKeyguard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u518D\u7EE7\u7EED\u770B<code>startActivityUncheckedLocked</code>\u65B9\u6CD5\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">startActivityUncheckedLocked</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> r<span class="token punctuation">,</span> <span class="token class-name">ActivityRecord</span> sourceRecord<span class="token punctuation">,</span>
		<span class="token class-name">IVoiceInteractionSession</span> voiceSession<span class="token punctuation">,</span> <span class="token class-name">IVoiceInteractor</span> voiceInteractor<span class="token punctuation">,</span> <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span>
		<span class="token keyword">boolean</span> doResume<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">,</span> <span class="token class-name">TaskRecord</span> inTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">final</span> <span class="token class-name">Intent</span> intent <span class="token operator">=</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">;</span>
	<span class="token keyword">final</span> <span class="token keyword">int</span> callingUid <span class="token operator">=</span> r<span class="token punctuation">.</span>launchedFromUid<span class="token punctuation">;</span>

	<span class="token comment">// In some flows in to this function, we retrieve the task record and hold on to it</span>
	<span class="token comment">// without a lock before calling back in to here...  so the task at this point may</span>
	<span class="token comment">// not actually be in recents.  Check for that, and if it isn&#39;t in recents just</span>
	<span class="token comment">// consider it invalid.</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>inTask <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>inTask<span class="token punctuation">.</span>inRecents<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Starting activity in task not in recents: &quot;</span> <span class="token operator">+</span> inTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
		inTask <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// \u5224\u65AD\u4E0D\u540C\u7684\u542F\u52A8\u6A21\u5F0F</span>
	<span class="token keyword">final</span> <span class="token keyword">boolean</span> launchSingleTop <span class="token operator">=</span> r<span class="token punctuation">.</span>launchMode <span class="token operator">==</span> <span class="token class-name">ActivityInfo</span><span class="token punctuation">.</span>LAUNCH_SINGLE_TOP<span class="token punctuation">;</span>
	<span class="token keyword">final</span> <span class="token keyword">boolean</span> launchSingleInstance <span class="token operator">=</span> r<span class="token punctuation">.</span>launchMode <span class="token operator">==</span> <span class="token class-name">ActivityInfo</span><span class="token punctuation">.</span>LAUNCH_SINGLE_INSTANCE<span class="token punctuation">;</span>
	<span class="token keyword">final</span> <span class="token keyword">boolean</span> launchSingleTask <span class="token operator">=</span> r<span class="token punctuation">.</span>launchMode <span class="token operator">==</span> <span class="token class-name">ActivityInfo</span><span class="token punctuation">.</span>LAUNCH_SINGLE_TASK<span class="token punctuation">;</span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token comment">// We may want to try to place the new activity in to an existing task.  We always</span>
	<span class="token comment">// do this if the target activity is singleTask or singleInstance; we will also do</span>
	<span class="token comment">// this if NEW_TASK has been requested, and there is not an additional qualifier telling</span>
	<span class="token comment">// us to still place it in a new task: multi task, always doc mode, or being asked to</span>
	<span class="token comment">// launch this as a new task behind the current one.</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>launchFlags <span class="token operator">&amp;</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_NEW_TASK<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
			<span class="token punctuation">(</span>launchFlags <span class="token operator">&amp;</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_MULTIPLE_TASK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token operator">||</span> launchSingleInstance <span class="token operator">||</span> launchSingleTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// If bring to front is requested, and no result is requested and we have not</span>
		<span class="token comment">// been given an explicit task to launch in to, and</span>
		<span class="token comment">// we can find a task that was started with this same</span>
		<span class="token comment">// component, then instead of launching bring that one to the front.</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>inTask <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>resultTo <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// See if there is a task to bring to the front.  If this is</span>
			<span class="token comment">// a SINGLE_INSTANCE activity, there can be one and only one</span>
			<span class="token comment">// instance of it in the history, and it is always in its own</span>
			<span class="token comment">// unique task, so we do a special search.</span>
			<span class="token class-name">ActivityRecord</span> intentActivity <span class="token operator">=</span> <span class="token operator">!</span>launchSingleInstance <span class="token operator">?</span>
					<span class="token function">findTaskLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">findActivityLocked</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> r<span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>intentActivity <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// When the flags NEW_TASK and CLEAR_TASK are set, then the task gets reused</span>
				<span class="token comment">// but still needs to be a lock task mode violation since the task gets</span>
				<span class="token comment">// cleared out and the device would otherwise leave the locked task.</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLockTaskModeViolation</span><span class="token punctuation">(</span>intentActivity<span class="token punctuation">.</span>task<span class="token punctuation">,</span>
						<span class="token punctuation">(</span>launchFlags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>FLAG_ACTIVITY_NEW_TASK <span class="token operator">|</span> FLAG_ACTIVITY_CLEAR_TASK<span class="token punctuation">)</span><span class="token punctuation">)</span>
						<span class="token operator">==</span> <span class="token punctuation">(</span>FLAG_ACTIVITY_NEW_TASK <span class="token operator">|</span> FLAG_ACTIVITY_CLEAR_TASK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token function">showLockTaskToast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;startActivityUnchecked: Attempt to violate Lock Task Mode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_RETURN_LOCK_TASK_MODE_VIOLATION<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>task <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					r<span class="token punctuation">.</span>task <span class="token operator">=</span> intentActivity<span class="token punctuation">.</span>task<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>intentActivity<span class="token punctuation">.</span>task<span class="token punctuation">.</span>intent <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">// This task was started because of movement of</span>
					<span class="token comment">// the activity based on affinity...  now that we</span>
					<span class="token comment">// are actually launching it, we can assign the</span>
					<span class="token comment">// base intent.</span>
					intentActivity<span class="token punctuation">.</span>task<span class="token punctuation">.</span><span class="token function">setIntent</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				targetStack <span class="token operator">=</span> intentActivity<span class="token punctuation">.</span>task<span class="token punctuation">.</span>stack<span class="token punctuation">;</span>
				targetStack<span class="token punctuation">.</span>mLastPausedActivity <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
				<span class="token comment">// If the target task is not in the front, then we need</span>
				<span class="token comment">// to bring it to the front...  except...  well, with</span>
				<span class="token comment">// SINGLE_TASK_LAUNCH it&#39;s not entirely clear.  We&#39;d like</span>
				<span class="token comment">// to have the same behavior as if a new instance was</span>
				<span class="token comment">// being started, which means not bringing it to the front</span>
				<span class="token comment">// if the caller is not itself in the front.</span>
				<span class="token keyword">final</span> <span class="token class-name">ActivityStack</span> focusStack <span class="token operator">=</span> <span class="token function">getFocusedStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">ActivityRecord</span> curTop <span class="token operator">=</span> <span class="token punctuation">(</span>focusStack <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
						<span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> focusStack<span class="token punctuation">.</span><span class="token function">topRunningNonDelayedActivityLocked</span><span class="token punctuation">(</span>notTop<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">boolean</span> movedToFront <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>curTop <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>curTop<span class="token punctuation">.</span>task <span class="token operator">!=</span> intentActivity<span class="token punctuation">.</span>task <span class="token operator">||</span>
						curTop<span class="token punctuation">.</span>task <span class="token operator">!=</span> focusStack<span class="token punctuation">.</span><span class="token function">topTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_BROUGHT_TO_FRONT<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>sourceRecord <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>sourceStack<span class="token punctuation">.</span><span class="token function">topActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
							sourceStack<span class="token punctuation">.</span><span class="token function">topActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>task <span class="token operator">==</span> sourceRecord<span class="token punctuation">.</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token comment">// We really do want to push this one into the user&#39;s face, right now.</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>launchTaskBehind <span class="token operator">&amp;&amp;</span> sourceRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							intentActivity<span class="token punctuation">.</span><span class="token function">setTaskToAffiliateWith</span><span class="token punctuation">(</span>sourceRecord<span class="token punctuation">.</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						movedHome <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
						targetStack<span class="token punctuation">.</span><span class="token function">moveTaskToFrontLocked</span><span class="token punctuation">(</span>intentActivity<span class="token punctuation">.</span>task<span class="token punctuation">,</span> noAnimation<span class="token punctuation">,</span>
								options<span class="token punctuation">,</span> r<span class="token punctuation">.</span>appTimeTracker<span class="token punctuation">,</span> <span class="token string">&quot;bringingFoundTaskToFront&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						movedToFront <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>launchFlags <span class="token operator">&amp;</span>
								<span class="token punctuation">(</span>FLAG_ACTIVITY_NEW_TASK <span class="token operator">|</span> FLAG_ACTIVITY_TASK_ON_HOME<span class="token punctuation">)</span><span class="token punctuation">)</span>
								<span class="token operator">==</span> <span class="token punctuation">(</span>FLAG_ACTIVITY_NEW_TASK <span class="token operator">|</span> FLAG_ACTIVITY_TASK_ON_HOME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token comment">// Caller wants to appear on home activity.</span>
							intentActivity<span class="token punctuation">.</span>task<span class="token punctuation">.</span><span class="token function">setTaskToReturnTo</span><span class="token punctuation">(</span>HOME_ACTIVITY_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						options <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>movedToFront<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_TASKS<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG_TASKS<span class="token punctuation">,</span> <span class="token string">&quot;Bring to front target: &quot;</span> <span class="token operator">+</span> targetStack
							<span class="token operator">+</span> <span class="token string">&quot; from &quot;</span> <span class="token operator">+</span> intentActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
					targetStack<span class="token punctuation">.</span><span class="token function">moveToFront</span><span class="token punctuation">(</span><span class="token string">&quot;intentActivityFound&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				<span class="token comment">// If the caller has requested that the target task be</span>
				<span class="token comment">// reset, then do so.</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>launchFlags<span class="token operator">&amp;</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_RESET_TASK_IF_NEEDED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					intentActivity <span class="token operator">=</span> targetStack<span class="token punctuation">.</span><span class="token function">resetTaskIfNeededLocked</span><span class="token punctuation">(</span>intentActivity<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>startFlags <span class="token operator">&amp;</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_FLAG_ONLY_IF_NEEDED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">// We don&#39;t need to start a new activity, and</span>
					<span class="token comment">// the client said not to do anything if that</span>
					<span class="token comment">// is the case, so this is it!  And for paranoia, make</span>
					<span class="token comment">// sure we have correctly resumed the top activity.</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>doResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token function">resumeTopActivitiesLocked</span><span class="token punctuation">(</span>targetStack<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>

						<span class="token comment">// Make sure to notify Keyguard as well if we are not running an app</span>
						<span class="token comment">// transition later.</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>movedToFront<span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token function">notifyActivityDrawnForKeyguard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
						<span class="token class-name">ActivityOptions</span><span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_RETURN_INTENT_TO_CALLER<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>launchFlags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>FLAG_ACTIVITY_NEW_TASK <span class="token operator">|</span> FLAG_ACTIVITY_CLEAR_TASK<span class="token punctuation">)</span><span class="token punctuation">)</span>
						<span class="token operator">==</span> <span class="token punctuation">(</span>FLAG_ACTIVITY_NEW_TASK <span class="token operator">|</span> FLAG_ACTIVITY_CLEAR_TASK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">// The caller has requested to completely replace any</span>
					<span class="token comment">// existing task with its new activity.  Well that should</span>
					<span class="token comment">// not be too hard...</span>
					reuseTask <span class="token operator">=</span> intentActivity<span class="token punctuation">.</span>task<span class="token punctuation">;</span>
					reuseTask<span class="token punctuation">.</span><span class="token function">performClearTaskLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					reuseTask<span class="token punctuation">.</span><span class="token function">setIntent</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>launchFlags <span class="token operator">&amp;</span> FLAG_ACTIVITY_CLEAR_TOP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
						<span class="token operator">||</span> launchSingleInstance <span class="token operator">||</span> launchSingleTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">// In this situation we want to remove all activities</span>
					<span class="token comment">// from the task up to the one being started.  In most</span>
					<span class="token comment">// cases this means we are resetting the task to its</span>
					<span class="token comment">// initial state.</span>
					<span class="token class-name">ActivityRecord</span> top <span class="token operator">=</span>
							intentActivity<span class="token punctuation">.</span>task<span class="token punctuation">.</span><span class="token function">performClearTaskLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> launchFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>top <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>top<span class="token punctuation">.</span>frontOfTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token comment">// Activity aliases may mean we use different</span>
							<span class="token comment">// intents for the top activity, so make sure</span>
							<span class="token comment">// the task now has the identity of the new</span>
							<span class="token comment">// intent.</span>
							top<span class="token punctuation">.</span>task<span class="token punctuation">.</span><span class="token function">setIntent</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						<span class="token class-name">ActivityStack</span><span class="token punctuation">.</span><span class="token function">logStartActivity</span><span class="token punctuation">(</span><span class="token class-name">EventLogTags</span><span class="token punctuation">.</span>AM_NEW_INTENT<span class="token punctuation">,</span>
								r<span class="token punctuation">,</span> top<span class="token punctuation">.</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
						top<span class="token punctuation">.</span><span class="token function">deliverNewIntentLocked</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> r<span class="token punctuation">.</span>launchedFromPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
						<span class="token comment">// A special case: we need to start the activity because it is not</span>
						<span class="token comment">// currently running, and the caller has asked to clear the current</span>
						<span class="token comment">// task to have this activity at the top.</span>
						addingToTask <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
						<span class="token comment">// Now pretend like this activity is being started by the top of its</span>
						<span class="token comment">// task, so it is put in the right place.</span>
						sourceRecord <span class="token operator">=</span> intentActivity<span class="token punctuation">;</span>
						<span class="token class-name">TaskRecord</span> task <span class="token operator">=</span> sourceRecord<span class="token punctuation">.</span>task<span class="token punctuation">;</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> task<span class="token punctuation">.</span>stack <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token comment">// Target stack got cleared when we all activities were removed</span>
							<span class="token comment">// above. Go ahead and reset it.</span>
							targetStack <span class="token operator">=</span> <span class="token function">computeStackFocus</span><span class="token punctuation">(</span>sourceRecord<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* newTask */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							targetStack<span class="token punctuation">.</span><span class="token function">addTask</span><span class="token punctuation">(</span>
									task<span class="token punctuation">,</span> <span class="token operator">!</span>launchTaskBehind <span class="token comment">/* toTop */</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* moving */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>

					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>realActivity<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intentActivity<span class="token punctuation">.</span>task<span class="token punctuation">.</span>realActivity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">// In this case the top activity on the task is the</span>
					<span class="token comment">// same as the one being launched, so we take that</span>
					<span class="token comment">// as a request to bring the task to the foreground.</span>
					<span class="token comment">// If the top activity in the task is the root</span>
					<span class="token comment">// activity, deliver this new intent to it if it</span>
					<span class="token comment">// desires.</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>launchFlags<span class="token operator">&amp;</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_SINGLE_TOP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> launchSingleTop<span class="token punctuation">)</span>
							<span class="token operator">&amp;&amp;</span> intentActivity<span class="token punctuation">.</span>realActivity<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>realActivity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token class-name">ActivityStack</span><span class="token punctuation">.</span><span class="token function">logStartActivity</span><span class="token punctuation">(</span><span class="token class-name">EventLogTags</span><span class="token punctuation">.</span>AM_NEW_INTENT<span class="token punctuation">,</span> r<span class="token punctuation">,</span>
								intentActivity<span class="token punctuation">.</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>intentActivity<span class="token punctuation">.</span>frontOfTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
							intentActivity<span class="token punctuation">.</span>task<span class="token punctuation">.</span><span class="token function">setIntent</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						intentActivity<span class="token punctuation">.</span><span class="token function">deliverNewIntentLocked</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">,</span>
								r<span class="token punctuation">.</span>launchedFromPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">filterEquals</span><span class="token punctuation">(</span>intentActivity<span class="token punctuation">.</span>task<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token comment">// In this case we are launching the root activity</span>
						<span class="token comment">// of the task, but with a different intent.  We</span>
						<span class="token comment">// should start a new instance on top.</span>
						addingToTask <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
						sourceRecord <span class="token operator">=</span> intentActivity<span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>launchFlags<span class="token operator">&amp;</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_RESET_TASK_IF_NEEDED<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">// In this case an activity is being launched in to an</span>
					<span class="token comment">// existing task, without resetting that task.  This</span>
					<span class="token comment">// is typically the situation of launching an activity</span>
					<span class="token comment">// from a notification or shortcut.  We want to place</span>
					<span class="token comment">// the new activity on top of the current task.</span>
					addingToTask <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
					sourceRecord <span class="token operator">=</span> intentActivity<span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>intentActivity<span class="token punctuation">.</span>task<span class="token punctuation">.</span>rootWasReset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">// In this case we are launching in to an existing task</span>
					<span class="token comment">// that has not yet been started from its front door.</span>
					<span class="token comment">// The current task has been brought to the front.</span>
					<span class="token comment">// Ideally, we&#39;d probably like to place this new task</span>
					<span class="token comment">// at the bottom of its stack, but that&#39;s a little hard</span>
					<span class="token comment">// to do with the current organization of the code so</span>
					<span class="token comment">// for now we&#39;ll just drop it.</span>
					intentActivity<span class="token punctuation">.</span>task<span class="token punctuation">.</span><span class="token function">setIntent</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>addingToTask <span class="token operator">&amp;&amp;</span> reuseTask <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">// We didn&#39;t do anything...  but it was needed (a.k.a., client</span>
					<span class="token comment">// don&#39;t use that intent!)  And for paranoia, make</span>
					<span class="token comment">// sure we have correctly resumed the top activity.</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>doResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						targetStack<span class="token punctuation">.</span><span class="token function">resumeTopActivityLocked</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>movedToFront<span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token comment">// Make sure to notify Keyguard as well if we are not running an app</span>
							<span class="token comment">// transition later.</span>
							<span class="token function">notifyActivityDrawnForKeyguard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
						<span class="token class-name">ActivityOptions</span><span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_TASK_TO_FRONT<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//String uri = r.intent.toURI();</span>
	<span class="token comment">//Intent intent2 = new Intent(uri);</span>
	<span class="token comment">//Slog.i(TAG, &quot;Given intent: &quot; + r.intent);</span>
	<span class="token comment">//Slog.i(TAG, &quot;URI is: &quot; + uri);</span>
	<span class="token comment">//Slog.i(TAG, &quot;To intent: &quot; + intent2);</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>packageName <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// If the activity being launched is the same as the one currently</span>
		<span class="token comment">// at the top, then we need to check if it should only be launched</span>
		<span class="token comment">// once.</span>
		<span class="token class-name">ActivityStack</span> topStack <span class="token operator">=</span> mFocusedStack<span class="token punctuation">;</span>
		<span class="token class-name">ActivityRecord</span> top <span class="token operator">=</span> topStack<span class="token punctuation">.</span><span class="token function">topRunningNonDelayedActivityLocked</span><span class="token punctuation">(</span>notTop<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>top <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>resultTo <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>top<span class="token punctuation">.</span>realActivity<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>realActivity<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> top<span class="token punctuation">.</span>userId <span class="token operator">==</span> r<span class="token punctuation">.</span>userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>top<span class="token punctuation">.</span>app <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> top<span class="token punctuation">.</span>app<span class="token punctuation">.</span>thread <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>launchFlags <span class="token operator">&amp;</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_SINGLE_TOP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
						<span class="token operator">||</span> launchSingleTop <span class="token operator">||</span> launchSingleTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token class-name">ActivityStack</span><span class="token punctuation">.</span><span class="token function">logStartActivity</span><span class="token punctuation">(</span><span class="token class-name">EventLogTags</span><span class="token punctuation">.</span>AM_NEW_INTENT<span class="token punctuation">,</span> top<span class="token punctuation">,</span>
								top<span class="token punctuation">.</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token comment">// For paranoia, make sure we have correctly</span>
						<span class="token comment">// resumed the top activity.</span>
						topStack<span class="token punctuation">.</span>mLastPausedActivity <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>doResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token function">resumeTopActivitiesLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						<span class="token class-name">ActivityOptions</span><span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>startFlags<span class="token operator">&amp;</span><span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_FLAG_ONLY_IF_NEEDED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token comment">// We don&#39;t need to start a new activity, and</span>
							<span class="token comment">// the client said not to do anything if that</span>
							<span class="token comment">// is the case, so this is it!</span>
							<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_RETURN_INTENT_TO_CALLER<span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						top<span class="token punctuation">.</span><span class="token function">deliverNewIntentLocked</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> r<span class="token punctuation">.</span>launchedFromPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_DELIVERED_TO_TOP<span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>resultTo <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>resultTo<span class="token punctuation">.</span>task<span class="token punctuation">.</span>stack <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			r<span class="token punctuation">.</span>resultTo<span class="token punctuation">.</span>task<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">sendActivityResultLocked</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultTo<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultWho<span class="token punctuation">,</span>
					r<span class="token punctuation">.</span>requestCode<span class="token punctuation">,</span> <span class="token class-name">Activity</span><span class="token punctuation">.</span>RESULT_CANCELED<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token class-name">ActivityOptions</span><span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_CLASS_NOT_FOUND<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">boolean</span> newTask <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token keyword">boolean</span> keepCurTransition <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

	<span class="token class-name">TaskRecord</span> taskToAffiliate <span class="token operator">=</span> launchTaskBehind <span class="token operator">&amp;&amp;</span> sourceRecord <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span>
			sourceRecord<span class="token punctuation">.</span>task <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

	<span class="token comment">// Should this be considered a new task?</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>resultTo <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> inTask <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>addingToTask
			<span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>launchFlags <span class="token operator">&amp;</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_NEW_TASK<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		newTask <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		targetStack <span class="token operator">=</span> <span class="token function">computeStackFocus</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> newTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
		targetStack<span class="token punctuation">.</span><span class="token function">moveToFront</span><span class="token punctuation">(</span><span class="token string">&quot;startingNewTask&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>reuseTask <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			r<span class="token punctuation">.</span><span class="token function">setTask</span><span class="token punctuation">(</span>targetStack<span class="token punctuation">.</span><span class="token function">createTaskRecord</span><span class="token punctuation">(</span><span class="token function">getNextTaskId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					newTaskInfo <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> newTaskInfo <span class="token operator">:</span> r<span class="token punctuation">.</span>info<span class="token punctuation">,</span>
					newTaskIntent <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> newTaskIntent <span class="token operator">:</span> intent<span class="token punctuation">,</span>
					voiceSession<span class="token punctuation">,</span> voiceInteractor<span class="token punctuation">,</span> <span class="token operator">!</span>launchTaskBehind <span class="token comment">/* toTop */</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					taskToAffiliate<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_TASKS<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_TASKS<span class="token punctuation">,</span>
					<span class="token string">&quot;Starting new activity &quot;</span> <span class="token operator">+</span> r <span class="token operator">+</span> <span class="token string">&quot; in new task &quot;</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			r<span class="token punctuation">.</span><span class="token function">setTask</span><span class="token punctuation">(</span>reuseTask<span class="token punctuation">,</span> taskToAffiliate<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLockTaskModeViolation</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Attempted Lock Task Mode violation r=&quot;</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_RETURN_LOCK_TASK_MODE_VIOLATION<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>movedHome<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>launchFlags <span class="token operator">&amp;</span>
					<span class="token punctuation">(</span>FLAG_ACTIVITY_NEW_TASK <span class="token operator">|</span> FLAG_ACTIVITY_TASK_ON_HOME<span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token operator">==</span> <span class="token punctuation">(</span>FLAG_ACTIVITY_NEW_TASK <span class="token operator">|</span> FLAG_ACTIVITY_TASK_ON_HOME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// Caller wants to appear on home activity, so before starting</span>
				<span class="token comment">// their own activity we will bring home to the front.</span>
				r<span class="token punctuation">.</span>task<span class="token punctuation">.</span><span class="token function">setTaskToReturnTo</span><span class="token punctuation">(</span>HOME_ACTIVITY_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sourceRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">final</span> <span class="token class-name">TaskRecord</span> sourceTask <span class="token operator">=</span> sourceRecord<span class="token punctuation">.</span>task<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLockTaskModeViolation</span><span class="token punctuation">(</span>sourceTask<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Attempted Lock Task Mode violation r=&quot;</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_RETURN_LOCK_TASK_MODE_VIOLATION<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		targetStack <span class="token operator">=</span> sourceTask<span class="token punctuation">.</span>stack<span class="token punctuation">;</span>
		targetStack<span class="token punctuation">.</span><span class="token function">moveToFront</span><span class="token punctuation">(</span><span class="token string">&quot;sourceStackToFront&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">final</span> <span class="token class-name">TaskRecord</span> topTask <span class="token operator">=</span> targetStack<span class="token punctuation">.</span><span class="token function">topTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>topTask <span class="token operator">!=</span> sourceTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			targetStack<span class="token punctuation">.</span><span class="token function">moveTaskToFrontLocked</span><span class="token punctuation">(</span>sourceTask<span class="token punctuation">,</span> noAnimation<span class="token punctuation">,</span> options<span class="token punctuation">,</span>
					r<span class="token punctuation">.</span>appTimeTracker<span class="token punctuation">,</span> <span class="token string">&quot;sourceTaskToFront&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>addingToTask <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>launchFlags<span class="token operator">&amp;</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_CLEAR_TOP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// In this case, we are adding the activity to an existing</span>
			<span class="token comment">// task, but the caller has asked to clear that task if the</span>
			<span class="token comment">// activity is already running.</span>
			<span class="token class-name">ActivityRecord</span> top <span class="token operator">=</span> sourceTask<span class="token punctuation">.</span><span class="token function">performClearTaskLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> launchFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
			keepCurTransition <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>top <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">ActivityStack</span><span class="token punctuation">.</span><span class="token function">logStartActivity</span><span class="token punctuation">(</span><span class="token class-name">EventLogTags</span><span class="token punctuation">.</span>AM_NEW_INTENT<span class="token punctuation">,</span> r<span class="token punctuation">,</span> top<span class="token punctuation">.</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
				top<span class="token punctuation">.</span><span class="token function">deliverNewIntentLocked</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> r<span class="token punctuation">.</span>launchedFromPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">// For paranoia, make sure we have correctly</span>
				<span class="token comment">// resumed the top activity.</span>
				targetStack<span class="token punctuation">.</span>mLastPausedActivity <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>doResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					targetStack<span class="token punctuation">.</span><span class="token function">resumeTopActivityLocked</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token class-name">ActivityOptions</span><span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_DELIVERED_TO_TOP<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>addingToTask <span class="token operator">&amp;&amp;</span>
				<span class="token punctuation">(</span>launchFlags<span class="token operator">&amp;</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_REORDER_TO_FRONT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// In this case, we are launching an activity in our own task</span>
			<span class="token comment">// that may already be running somewhere in the history, and</span>
			<span class="token comment">// we want to shuffle it to the front of the stack if so.</span>
			<span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> top <span class="token operator">=</span> sourceTask<span class="token punctuation">.</span><span class="token function">findActivityInHistoryLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>top <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">final</span> <span class="token class-name">TaskRecord</span> task <span class="token operator">=</span> top<span class="token punctuation">.</span>task<span class="token punctuation">;</span>
				task<span class="token punctuation">.</span><span class="token function">moveActivityToFrontLocked</span><span class="token punctuation">(</span>top<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">ActivityStack</span><span class="token punctuation">.</span><span class="token function">logStartActivity</span><span class="token punctuation">(</span><span class="token class-name">EventLogTags</span><span class="token punctuation">.</span>AM_NEW_INTENT<span class="token punctuation">,</span> r<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
				top<span class="token punctuation">.</span><span class="token function">updateOptionsLocked</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
				top<span class="token punctuation">.</span><span class="token function">deliverNewIntentLocked</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> r<span class="token punctuation">.</span>launchedFromPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
				targetStack<span class="token punctuation">.</span>mLastPausedActivity <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>doResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					targetStack<span class="token punctuation">.</span><span class="token function">resumeTopActivityLocked</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_DELIVERED_TO_TOP<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// An existing activity is starting this new activity, so we want</span>
		<span class="token comment">// to keep the new one in the same task as the one that is starting</span>
		<span class="token comment">// it.</span>
		r<span class="token punctuation">.</span><span class="token function">setTask</span><span class="token punctuation">(</span>sourceTask<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_TASKS<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_TASKS<span class="token punctuation">,</span> <span class="token string">&quot;Starting new activity &quot;</span> <span class="token operator">+</span> r
				<span class="token operator">+</span> <span class="token string">&quot; in existing task &quot;</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>task <span class="token operator">+</span> <span class="token string">&quot; from source &quot;</span> <span class="token operator">+</span> sourceRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>inTask <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// The caller is asking that the new activity be started in an explicit</span>
		<span class="token comment">// task it has provided to us.</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLockTaskModeViolation</span><span class="token punctuation">(</span>inTask<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Attempted Lock Task Mode violation r=&quot;</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_RETURN_LOCK_TASK_MODE_VIOLATION<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		targetStack <span class="token operator">=</span> inTask<span class="token punctuation">.</span>stack<span class="token punctuation">;</span>
		targetStack<span class="token punctuation">.</span><span class="token function">moveTaskToFrontLocked</span><span class="token punctuation">(</span>inTask<span class="token punctuation">,</span> noAnimation<span class="token punctuation">,</span> options<span class="token punctuation">,</span> r<span class="token punctuation">.</span>appTimeTracker<span class="token punctuation">,</span>
				<span class="token string">&quot;inTaskToFront&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Check whether we should actually launch the new activity in to the task,</span>
		<span class="token comment">// or just reuse the current activity on top.</span>
		<span class="token class-name">ActivityRecord</span> top <span class="token operator">=</span> inTask<span class="token punctuation">.</span><span class="token function">getTopActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>top <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> top<span class="token punctuation">.</span>realActivity<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>realActivity<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> top<span class="token punctuation">.</span>userId <span class="token operator">==</span> r<span class="token punctuation">.</span>userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>launchFlags <span class="token operator">&amp;</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_SINGLE_TOP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
					<span class="token operator">||</span> launchSingleTop <span class="token operator">||</span> launchSingleTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">ActivityStack</span><span class="token punctuation">.</span><span class="token function">logStartActivity</span><span class="token punctuation">(</span><span class="token class-name">EventLogTags</span><span class="token punctuation">.</span>AM_NEW_INTENT<span class="token punctuation">,</span> top<span class="token punctuation">,</span> top<span class="token punctuation">.</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>startFlags<span class="token operator">&amp;</span><span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_FLAG_ONLY_IF_NEEDED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">// We don&#39;t need to start a new activity, and</span>
					<span class="token comment">// the client said not to do anything if that</span>
					<span class="token comment">// is the case, so this is it!</span>
					<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_RETURN_INTENT_TO_CALLER<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				top<span class="token punctuation">.</span><span class="token function">deliverNewIntentLocked</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> r<span class="token punctuation">.</span>launchedFromPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_DELIVERED_TO_TOP<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>addingToTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// We don&#39;t actually want to have this activity added to the task, so just</span>
			<span class="token comment">// stop here but still tell the caller that we consumed the intent.</span>
			<span class="token class-name">ActivityOptions</span><span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_TASK_TO_FRONT<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		r<span class="token punctuation">.</span><span class="token function">setTask</span><span class="token punctuation">(</span>inTask<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_TASKS<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_TASKS<span class="token punctuation">,</span> <span class="token string">&quot;Starting new activity &quot;</span> <span class="token operator">+</span> r
				<span class="token operator">+</span> <span class="token string">&quot; in explicit task &quot;</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">// This not being started from an existing activity, and not part</span>
		<span class="token comment">// of a new task...  just put it in the top task, though these days</span>
		<span class="token comment">// this case should never happen.</span>
		targetStack <span class="token operator">=</span> <span class="token function">computeStackFocus</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> newTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
		targetStack<span class="token punctuation">.</span><span class="token function">moveToFront</span><span class="token punctuation">(</span><span class="token string">&quot;addingToTopTask&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">ActivityRecord</span> prev <span class="token operator">=</span> targetStack<span class="token punctuation">.</span><span class="token function">topActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		r<span class="token punctuation">.</span><span class="token function">setTask</span><span class="token punctuation">(</span>prev <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> prev<span class="token punctuation">.</span>task <span class="token operator">:</span> targetStack<span class="token punctuation">.</span><span class="token function">createTaskRecord</span><span class="token punctuation">(</span><span class="token function">getNextTaskId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
						r<span class="token punctuation">.</span>info<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		mWindowManager<span class="token punctuation">.</span><span class="token function">moveTaskToTop</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>task<span class="token punctuation">.</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_TASKS<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_TASKS<span class="token punctuation">,</span> <span class="token string">&quot;Starting new activity &quot;</span> <span class="token operator">+</span> r
				<span class="token operator">+</span> <span class="token string">&quot; in new guessed &quot;</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	mService<span class="token punctuation">.</span><span class="token function">grantUriPermissionFromIntentLocked</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">,</span> r<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
			intent<span class="token punctuation">,</span> r<span class="token punctuation">.</span><span class="token function">getUriPermissionsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>sourceRecord <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> sourceRecord<span class="token punctuation">.</span><span class="token function">isRecentsActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		r<span class="token punctuation">.</span>task<span class="token punctuation">.</span><span class="token function">setTaskToReturnTo</span><span class="token punctuation">(</span>RECENTS_ACTIVITY_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>newTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">EventLog</span><span class="token punctuation">.</span><span class="token function">writeEvent</span><span class="token punctuation">(</span><span class="token class-name">EventLogTags</span><span class="token punctuation">.</span>AM_CREATE_TASK<span class="token punctuation">,</span> r<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> r<span class="token punctuation">.</span>task<span class="token punctuation">.</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token class-name">ActivityStack</span><span class="token punctuation">.</span><span class="token function">logStartActivity</span><span class="token punctuation">(</span><span class="token class-name">EventLogTags</span><span class="token punctuation">.</span>AM_CREATE_ACTIVITY<span class="token punctuation">,</span> r<span class="token punctuation">,</span> r<span class="token punctuation">.</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
	targetStack<span class="token punctuation">.</span>mLastPausedActivity <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	
	<span class="token comment">// \u4E0A\u9762\u8FD9\u90E8\u5206\u4EE3\u7801\u5F88\u591A\uFF0C\u5404\u79CD\u542F\u52A8\u6A21\u5F0F\u3001\u6808\u7684\u5904\u7406\u554A\uFF0C\u6211\u4EEC\u5C31\u4E0D\u7EE7\u7EED\u770B\u4E86\uFF0C\u63A5\u7740\u770B\u4E0B\u9762\u7684\u542F\u52A8\u3002</span>
	targetStack<span class="token punctuation">.</span><span class="token function">startActivityLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> newTask<span class="token punctuation">,</span> doResume<span class="token punctuation">,</span> keepCurTransition<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>launchTaskBehind<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// Don&#39;t set focus on an activity that&#39;s going to the back.</span>
		mService<span class="token punctuation">.</span><span class="token function">setFocusedActivityLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token string">&quot;startedActivity&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7EE7\u7EED\u770B<code>targetStack.startActivityLocked()</code>\u65B9\u6CD5,\u8FD9\u91CC<code>targetStack</code>\u5C31\u662F<code>ActivityStack</code>\u7C7B:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">startActivityLocked</span><span class="token punctuation">(</span><span class="token class-name">ActivityRecord</span> r<span class="token punctuation">,</span> <span class="token keyword">boolean</span> newTask<span class="token punctuation">,</span>
		<span class="token keyword">boolean</span> doResume<span class="token punctuation">,</span> <span class="token keyword">boolean</span> keepCurTransition<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">TaskRecord</span> rTask <span class="token operator">=</span> r<span class="token punctuation">.</span>task<span class="token punctuation">;</span>
	<span class="token keyword">final</span> <span class="token keyword">int</span> taskId <span class="token operator">=</span> rTask<span class="token punctuation">.</span>taskId<span class="token punctuation">;</span>
	<span class="token comment">// mLaunchTaskBehind tasks get placed at the back of the task stack.</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span>mLaunchTaskBehind <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">taskForIdLocked</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> newTask<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// Last activity in task had been removed or ActivityManagerService is reusing task.</span>
		<span class="token comment">// Insert or replace.</span>
		<span class="token comment">// Might not even be in.</span>
		<span class="token function">insertTaskAtTop</span><span class="token punctuation">(</span>rTask<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
		mWindowManager<span class="token punctuation">.</span><span class="token function">moveTaskToTop</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token class-name">TaskRecord</span> task <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// If starting in an existing task, find where that is...</span>
		<span class="token keyword">boolean</span> startIt <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> taskNdx <span class="token operator">=</span> mTaskHistory<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> taskNdx <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>taskNdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			task <span class="token operator">=</span> mTaskHistory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>taskNdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getTopActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// All activities in task are finishing.</span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">==</span> r<span class="token punctuation">.</span>task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// Here it is!  Now, if this is not yet visible to the</span>
				<span class="token comment">// user, then just add it without starting; it will</span>
				<span class="token comment">// get started when the user navigates back to it.</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>startIt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_ADD_REMOVE<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Adding activity &quot;</span> <span class="token operator">+</span> r <span class="token operator">+</span> <span class="token string">&quot; to task &quot;</span>
							<span class="token operator">+</span> task<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;here&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fillInStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					task<span class="token punctuation">.</span><span class="token function">addActivityToTop</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
					r<span class="token punctuation">.</span><span class="token function">putInHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					mWindowManager<span class="token punctuation">.</span><span class="token function">addAppToken</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>mActivities<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>appToken<span class="token punctuation">,</span>
							r<span class="token punctuation">.</span>task<span class="token punctuation">.</span>taskId<span class="token punctuation">,</span> mStackId<span class="token punctuation">,</span> r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>screenOrientation<span class="token punctuation">,</span> r<span class="token punctuation">.</span>fullscreen<span class="token punctuation">,</span>
							<span class="token punctuation">(</span>r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token class-name">ActivityInfo</span><span class="token punctuation">.</span>FLAG_SHOW_FOR_ALL_USERS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span>
							r<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>configChanges<span class="token punctuation">,</span> task<span class="token punctuation">.</span>voiceSession <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
							r<span class="token punctuation">.</span>mLaunchTaskBehind<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>VALIDATE_TOKENS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token function">validateAppTokensLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token class-name">ActivityOptions</span><span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">return</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>numFullscreen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				startIt <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Place a new activity at top of stack, so it is next to interact</span>
	<span class="token comment">// with the user.</span>

	<span class="token comment">// If we are not placing the new activity frontmost, we do not want</span>
	<span class="token comment">// to deliver the onUserLeaving callback to the actual frontmost</span>
	<span class="token comment">// activity</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">==</span> r<span class="token punctuation">.</span>task <span class="token operator">&amp;&amp;</span> mTaskHistory<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span>mTaskHistory<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		mStackSupervisor<span class="token punctuation">.</span>mUserLeaving <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_USER_LEAVING<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_USER_LEAVING<span class="token punctuation">,</span>
				<span class="token string">&quot;startActivity() behind front, mUserLeaving=false&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	task <span class="token operator">=</span> r<span class="token punctuation">.</span>task<span class="token punctuation">;</span>

	<span class="token comment">// Slot the activity into the history stack and proceed</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_ADD_REMOVE<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Adding activity &quot;</span> <span class="token operator">+</span> r <span class="token operator">+</span> <span class="token string">&quot; to stack to task &quot;</span> <span class="token operator">+</span> task<span class="token punctuation">,</span>
			<span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;here&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fillInStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	task<span class="token punctuation">.</span><span class="token function">addActivityToTop</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
	task<span class="token punctuation">.</span><span class="token function">setFrontOfTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	r<span class="token punctuation">.</span><span class="token function">putInHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isHomeStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">numActivities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// We want to show the starting preview window if we are</span>
		<span class="token comment">// switching to a new task, or the next activity&#39;s process is</span>
		<span class="token comment">// not currently running.</span>
		<span class="token keyword">boolean</span> showStartingIcon <span class="token operator">=</span> newTask<span class="token punctuation">;</span>
		<span class="token class-name">ProcessRecord</span> proc <span class="token operator">=</span> r<span class="token punctuation">.</span>app<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>proc <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			proc <span class="token operator">=</span> mService<span class="token punctuation">.</span>mProcessNames<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>proc <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> proc<span class="token punctuation">.</span>thread <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			showStartingIcon <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_TRANSITION<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_TRANSITION<span class="token punctuation">,</span>
				<span class="token string">&quot;Prepare open transition: starting &quot;</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_NO_ANIMATION<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			mWindowManager<span class="token punctuation">.</span><span class="token function">prepareAppTransition</span><span class="token punctuation">(</span><span class="token class-name">AppTransition</span><span class="token punctuation">.</span>TRANSIT_NONE<span class="token punctuation">,</span> keepCurTransition<span class="token punctuation">)</span><span class="token punctuation">;</span>
			mNoAnimActivities<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			mWindowManager<span class="token punctuation">.</span><span class="token function">prepareAppTransition</span><span class="token punctuation">(</span>newTask
					<span class="token operator">?</span> r<span class="token punctuation">.</span>mLaunchTaskBehind
							<span class="token operator">?</span> <span class="token class-name">AppTransition</span><span class="token punctuation">.</span>TRANSIT_TASK_OPEN_BEHIND
							<span class="token operator">:</span> <span class="token class-name">AppTransition</span><span class="token punctuation">.</span>TRANSIT_TASK_OPEN
					<span class="token operator">:</span> <span class="token class-name">AppTransition</span><span class="token punctuation">.</span>TRANSIT_ACTIVITY_OPEN<span class="token punctuation">,</span> keepCurTransition<span class="token punctuation">)</span><span class="token punctuation">;</span>
			mNoAnimActivities<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		mWindowManager<span class="token punctuation">.</span><span class="token function">addAppToken</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>mActivities<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span>
				r<span class="token punctuation">.</span>appToken<span class="token punctuation">,</span> r<span class="token punctuation">.</span>task<span class="token punctuation">.</span>taskId<span class="token punctuation">,</span> mStackId<span class="token punctuation">,</span> r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>screenOrientation<span class="token punctuation">,</span> r<span class="token punctuation">.</span>fullscreen<span class="token punctuation">,</span>
				<span class="token punctuation">(</span>r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token class-name">ActivityInfo</span><span class="token punctuation">.</span>FLAG_SHOW_FOR_ALL_USERS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>userId<span class="token punctuation">,</span>
				r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>configChanges<span class="token punctuation">,</span> task<span class="token punctuation">.</span>voiceSession <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>mLaunchTaskBehind<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">boolean</span> doShow <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>newTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// Even though this activity is starting fresh, we still need</span>
			<span class="token comment">// to reset it to make sure we apply affinities to move any</span>
			<span class="token comment">// existing activities from other tasks in to it.</span>
			<span class="token comment">// If the caller has requested that the target task be</span>
			<span class="token comment">// reset, then do so.</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_RESET_TASK_IF_NEEDED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">resetTaskIfNeededLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
				doShow <span class="token operator">=</span> <span class="token function">topRunningNonDelayedActivityLocked</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">==</span> r<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">new</span> <span class="token class-name">ActivityOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAnimationType</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token operator">==</span> <span class="token class-name">ActivityOptions</span><span class="token punctuation">.</span>ANIM_SCENE_TRANSITION<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			doShow <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>mLaunchTaskBehind<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// Don&#39;t do a starting window for mLaunchTaskBehind. More importantly make sure we</span>
			<span class="token comment">// tell WindowManager that r is visible even though it is at the back of the stack.</span>
			mWindowManager<span class="token punctuation">.</span><span class="token function">setAppVisibility</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>appToken<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">ensureActivitiesVisibleLocked</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>SHOW_APP_STARTING_PREVIEW <span class="token operator">&amp;&amp;</span> doShow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// Figure out if we are transitioning from another activity that is</span>
			<span class="token comment">// &quot;has the same starting icon&quot; as the next one.  This allows the</span>
			<span class="token comment">// window manager to keep the previous window it had previously</span>
			<span class="token comment">// created, if it still had one.</span>
			<span class="token class-name">ActivityRecord</span> prev <span class="token operator">=</span> mResumedActivity<span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>prev <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// We don&#39;t want to reuse the previous starting preview if:</span>
				<span class="token comment">// (1) The current activity is in a different task.</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>prev<span class="token punctuation">.</span>task <span class="token operator">!=</span> r<span class="token punctuation">.</span>task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					prev <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token comment">// (2) The current activity is already displayed.</span>
				<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>prev<span class="token punctuation">.</span>nowVisible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					prev <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			mWindowManager<span class="token punctuation">.</span><span class="token function">setAppStartingWindow</span><span class="token punctuation">(</span>
					r<span class="token punctuation">.</span>appToken<span class="token punctuation">,</span> r<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> r<span class="token punctuation">.</span>theme<span class="token punctuation">,</span>
					mService<span class="token punctuation">.</span><span class="token function">compatibilityInfoForPackageLocked</span><span class="token punctuation">(</span>
							r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>nonLocalizedLabel<span class="token punctuation">,</span>
					r<span class="token punctuation">.</span>labelRes<span class="token punctuation">,</span> r<span class="token punctuation">.</span>icon<span class="token punctuation">,</span> r<span class="token punctuation">.</span>logo<span class="token punctuation">,</span> r<span class="token punctuation">.</span>windowFlags<span class="token punctuation">,</span>
					prev <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> prev<span class="token punctuation">.</span>appToken <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> showStartingIcon<span class="token punctuation">)</span><span class="token punctuation">;</span>
			r<span class="token punctuation">.</span>mStartingWindowShown <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">// If this is the first activity, don&#39;t do any fancy animations,</span>
		<span class="token comment">// because there is nothing for it to animate on top of.</span>
		mWindowManager<span class="token punctuation">.</span><span class="token function">addAppToken</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>mActivities<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>appToken<span class="token punctuation">,</span>
				r<span class="token punctuation">.</span>task<span class="token punctuation">.</span>taskId<span class="token punctuation">,</span> mStackId<span class="token punctuation">,</span> r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>screenOrientation<span class="token punctuation">,</span> r<span class="token punctuation">.</span>fullscreen<span class="token punctuation">,</span>
				<span class="token punctuation">(</span>r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token class-name">ActivityInfo</span><span class="token punctuation">.</span>FLAG_SHOW_FOR_ALL_USERS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>userId<span class="token punctuation">,</span>
				r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>configChanges<span class="token punctuation">,</span> task<span class="token punctuation">.</span>voiceSession <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>mLaunchTaskBehind<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">ActivityOptions</span><span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		options <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>VALIDATE_TOKENS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">validateAppTokensLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>doResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		mStackSupervisor<span class="token punctuation">.</span><span class="token function">resumeTopActivitiesLocked</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> r<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728Android\u5E94\u7528\u7A0B\u5E8F\u6846\u67B6\u5C42\u4E2D\uFF0C\u662F\u7531ActivityManagerService\u7EC4\u4EF6\u8D1F\u8D23\u4E3AAndroid\u5E94\u7528\u7A0B\u5E8F\u521B\u5EFA\u65B0\u7684\u8FDB\u7A0B\u7684\uFF0C\u5B83\u672C\u6765\u4E5F\u662F\u8FD0\u884C\u5728\u4E00\u4E2A\u72EC\u7ACB\u7684\u8FDB\u7A0B\u4E4B\u4E2D\uFF0C\u4E0D\u8FC7\u8FD9\u4E2A\u8FDB\u7A0B\u662F\u5728\u7CFB\u7EDF\u542F\u52A8\u7684\u8FC7\u7A0B\u4E2D\u521B\u5EFA\u7684\u3002 ActivityManagerService\u7EC4\u4EF6\u4E00\u822C\u4F1A\u5728\u4EC0\u4E48\u60C5\u51B5\u4E0B\u4F1A\u4E3A\u5E94\u7528\u7A0B\u5E8F\u521B\u5EFA\u4E00\u4E2A\u65B0\u7684\u8FDB\u7A0B\u5462\uFF1F\u5F53\u7CFB\u7EDF\u51B3\u5B9A\u8981\u5728\u4E00\u4E2A\u65B0\u7684\u8FDB\u7A0B\u4E2D\u542F\u52A8\u4E00\u4E2AActivity\u6216\u8005Service\u65F6\uFF0C\u5B83\u5C31\u4F1A\u521B\u5EFA\u4E00\u4E2A\u65B0\u7684\u8FDB\u7A0B\u4E86\uFF0C \u7136\u540E\u5728\u8FD9\u4E2A\u65B0\u7684\u8FDB\u7A0B\u4E2D\u542F\u52A8\u8FD9\u4E2AActivity\u6216\u8005Service</p><hr><ul><li>\u90AE\u7BB1 \uFF1Acharon.chui@gmail.com</li><li>Good Luck!</li></ul>`,44),o=[e];function c(i,l){return s(),a("div",null,o)}var k=n(p,[["render",c],["__file","Activity\u542F\u52A8\u8FC7\u7A0B.html.vue"]]);export{k as default};
