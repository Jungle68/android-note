<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.47">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>Android Notes</title><meta name="description" content="一个 Android 技术记录文档">
    <link rel="modulepreload" href="/android-note/assets/app.e2a3b496.js"><link rel="modulepreload" href="/android-note/assets/HttpURLConnection详解.html.88c6186b.js"><link rel="modulepreload" href="/android-note/assets/HttpURLConnection详解.html.67635b46.js"><link rel="prefetch" href="/android-note/assets/index.html.fff2aa76.js"><link rel="prefetch" href="/android-note/assets/ART与Dalvik.html.261ddca4.js"><link rel="prefetch" href="/android-note/assets/Android6.0权限系统.html.518850bc.js"><link rel="prefetch" href="/android-note/assets/Android卸载反馈.html.d9910bec.js"><link rel="prefetch" href="/android-note/assets/Android启动模式详解.html.dff63630.js"><link rel="prefetch" href="/android-note/assets/Android开发不申请权限来使用对应功能.html.f29a403a.js"><link rel="prefetch" href="/android-note/assets/Android开发中的MVP模式详解.html.dc69d7fd.js"><link rel="prefetch" href="/android-note/assets/ApplicationId vs PackageName.html.7be45349.js"><link rel="prefetch" href="/android-note/assets/BroadcastReceiver安全问题.html.d78f651d.js"><link rel="prefetch" href="/android-note/assets/Handler导致内存泄露分析.html.a07e9d8a.js"><link rel="prefetch" href="/android-note/assets/Library项目中资源id使用case时报错.html.75fdf471.js"><link rel="prefetch" href="/android-note/assets/Mac下配置adb及Android命令.html.7e81f1f2.js"><link rel="prefetch" href="/android-note/assets/MaterialDesign使用.html.103e5176.js"><link rel="prefetch" href="/android-note/assets/RecyclerView专题.html.6e607fde.js"><link rel="prefetch" href="/android-note/assets/如何让Service常驻内存.html.29df35d8.js"><link rel="prefetch" href="/android-note/assets/屏幕适配之百分比方案详解.html.6014594b.js"><link rel="prefetch" href="/android-note/assets/布局优化.html.2a53d290.js"><link rel="prefetch" href="/android-note/assets/性能优化.html.d19ee784.js"><link rel="prefetch" href="/android-note/assets/注解使用.html.43ec2966.js"><link rel="prefetch" href="/android-note/assets/热修复实现.html.0afb9bec.js"><link rel="prefetch" href="/android-note/assets/通过Hardware Layer提高动画性能.html.7b3bfc5f.js"><link rel="prefetch" href="/android-note/assets/Android Studio你可能不知道的操作.html.b99bf27c.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio中进行ndk开发.html.c8895c23.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio使用教程(第一弹).html.3fdb02c5.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio使用教程(第七弹).html.f0becde3.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio使用教程(第三弹).html.8ca1aed1.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio使用教程(第二弹).html.eb73aa59.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio使用教程(第五弹).html.6799221d.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio使用教程(第六弹).html.9f737361.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio使用教程(第四弹).html.eab7452f.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio提高Build速度.html.82e665f3.js"><link rel="prefetch" href="/android-note/assets/Android应用发布.html.659d7444.js"><link rel="prefetch" href="/android-note/assets/Zipalign优化.html.26e47455.js"><link rel="prefetch" href="/android-note/assets/Android入门介绍.html.cbf93a65.js"><link rel="prefetch" href="/android-note/assets/Android动画.html.7c42765a.js"><link rel="prefetch" href="/android-note/assets/Android四大组件之ContentProvider.html.696ea85d.js"><link rel="prefetch" href="/android-note/assets/Android四大组件之Service.html.ae3ef80a.js"><link rel="prefetch" href="/android-note/assets/Android基础面试题.html.186ba84a.js"><link rel="prefetch" href="/android-note/assets/Android编码规范.html.0a30a4bc.js"><link rel="prefetch" href="/android-note/assets/Ant打包.html.161eb2a1.js"><link rel="prefetch" href="/android-note/assets/Bitmap优化.html.42e7fa9a.js"><link rel="prefetch" href="/android-note/assets/Fragment专题.html.02a55fca.js"><link rel="prefetch" href="/android-note/assets/Home键监听.html.025745a3.js"><link rel="prefetch" href="/android-note/assets/HttpClient执行Get和Post请求.html.9e95d7d7.js"><link rel="prefetch" href="/android-note/assets/JNI_C语言基础.html.1d87d268.js"><link rel="prefetch" href="/android-note/assets/JNI基础.html.3e311c7b.js"><link rel="prefetch" href="/android-note/assets/ListView专题.html.1396114e.js"><link rel="prefetch" href="/android-note/assets/Parcelable及Serializable.html.0b924706.js"><link rel="prefetch" href="/android-note/assets/PopupWindow细节.html.1b6d020f.js"><link rel="prefetch" href="/android-note/assets/SDK Manager无法更新的问题.html.da94471c.js"><link rel="prefetch" href="/android-note/assets/Scroller简介.html.4322b77a.js"><link rel="prefetch" href="/android-note/assets/ScrollingTabs.html.a580533a.js"><link rel="prefetch" href="/android-note/assets/Selector使用.html.0d501025.js"><link rel="prefetch" href="/android-note/assets/SlidingMenu.html.c374045d.js"><link rel="prefetch" href="/android-note/assets/String格式化.html.3691aec0.js"><link rel="prefetch" href="/android-note/assets/TextView跑马灯效果.html.c2883070.js"><link rel="prefetch" href="/android-note/assets/WebView总结.html.bb92c86c.js"><link rel="prefetch" href="/android-note/assets/Widget(窗口小部件).html.05a63ed7.js"><link rel="prefetch" href="/android-note/assets/Wifi状态监听.html.3f42e962.js"><link rel="prefetch" href="/android-note/assets/XmlPullParser.html.3d385a0b.js"><link rel="prefetch" href="/android-note/assets/adb logcat使用简介.html.0b6f4401.js"><link rel="prefetch" href="/android-note/assets/下拉刷新ListView.html.f2310aae.js"><link rel="prefetch" href="/android-note/assets/代码混淆.html.6a7abbed.js"><link rel="prefetch" href="/android-note/assets/任务管理器(ActivityManager).html.8dd2e53f.js"><link rel="prefetch" href="/android-note/assets/修改系统组件样式.html.bf36afb3.js"><link rel="prefetch" href="/android-note/assets/内存泄漏.html.99106e24.js"><link rel="prefetch" href="/android-note/assets/多线程断点下载.html.1f642fe4.js"><link rel="prefetch" href="/android-note/assets/安全退出应用程序.html.75bf928e.js"><link rel="prefetch" href="/android-note/assets/屏幕适配.html.e4ee636e.js"><link rel="prefetch" href="/android-note/assets/应用后台唤醒后数据的刷新.html.7bfa0f27.js"><link rel="prefetch" href="/android-note/assets/应用安装.html.3cd85193.js"><link rel="prefetch" href="/android-note/assets/开发中Log的管理.html.4653eac1.js"><link rel="prefetch" href="/android-note/assets/开发中异常的处理.html.5baf68fb.js"><link rel="prefetch" href="/android-note/assets/快捷方式工具类.html.67f51c74.js"><link rel="prefetch" href="/android-note/assets/手机摇晃.html.46b3e9fe.js"><link rel="prefetch" href="/android-note/assets/搜索框.html.072d0f77.js"><link rel="prefetch" href="/android-note/assets/数据存储.html.64e84f7f.js"><link rel="prefetch" href="/android-note/assets/文件上传.html.6aca8bc8.js"><link rel="prefetch" href="/android-note/assets/来电号码归属地提示框.html.e628cefe.js"><link rel="prefetch" href="/android-note/assets/来电监听及录音.html.d5eb1b47.js"><link rel="prefetch" href="/android-note/assets/横向ListView.html.e063f731.js"><link rel="prefetch" href="/android-note/assets/滑动切换Activity(GestureDetector).html.d48d5aed.js"><link rel="prefetch" href="/android-note/assets/病毒.html.5c217cee.js"><link rel="prefetch" href="/android-note/assets/知识大杂烩.html.31f82ea1.js"><link rel="prefetch" href="/android-note/assets/短信广播接收者.html.ffc29463.js"><link rel="prefetch" href="/android-note/assets/程序的启动、卸载和分享.html.fb6b9fb3.js"><link rel="prefetch" href="/android-note/assets/竖着的Seekbar.html.b0ad1ca1.js"><link rel="prefetch" href="/android-note/assets/自定义Toast.html.24e72ac9.js"><link rel="prefetch" href="/android-note/assets/自定义控件.html.396f8926.js"><link rel="prefetch" href="/android-note/assets/自定义状态栏通知.html.6e7387ea.js"><link rel="prefetch" href="/android-note/assets/自定义背景.html.48ca2361.js"><link rel="prefetch" href="/android-note/assets/获取位置(LocationManager).html.92583f07.js"><link rel="prefetch" href="/android-note/assets/获取应用程序缓存及一键清理.html.b42b2b32.js"><link rel="prefetch" href="/android-note/assets/获取手机中所有安装的程序.html.9735c882.js"><link rel="prefetch" href="/android-note/assets/获取手机及SD卡可用存储空间.html.b7572111.js"><link rel="prefetch" href="/android-note/assets/获取联系人.html.6aeb286a.js"><link rel="prefetch" href="/android-note/assets/读取用户logcat日志.html.4be18e44.js"><link rel="prefetch" href="/android-note/assets/资源文件拷贝的三种方式.html.1b6d8302.js"><link rel="prefetch" href="/android-note/assets/超级管理员(DevicePoliceManager).html.7072c065.js"><link rel="prefetch" href="/android-note/assets/锁屏以及解锁监听.html.28e1d009.js"><link rel="prefetch" href="/android-note/assets/零权限上传数据.html.562e3ff3.js"><link rel="prefetch" href="/android-note/assets/音量及屏幕亮度调节.html.adf99661.js"><link rel="prefetch" href="/android-note/assets/黑名单挂断电话及删除电话记录.html.701b6583.js"><link rel="prefetch" href="/android-note/assets/Gradle专题.html.8e9c74db.js"><link rel="prefetch" href="/android-note/assets/发布library到Maven仓库.html.a390a303.js"><link rel="prefetch" href="/android-note/assets/Glide简介(上).html.9316ab84.js"><link rel="prefetch" href="/android-note/assets/Glide简介(下).html.d24d23a1.js"><link rel="prefetch" href="/android-note/assets/图片加载库比较.html.f8555457.js"><link rel="prefetch" href="/android-note/assets/Base64加密.html.d207af8e.js"><link rel="prefetch" href="/android-note/assets/Git命令.html.a69a3d66.js"><link rel="prefetch" href="/android-note/assets/HashMap实现原理分析.html.48d0886d.js"><link rel="prefetch" href="/android-note/assets/JVM垃圾回收机制.html.5f2d4f42.js"><link rel="prefetch" href="/android-note/assets/Java基础面试题.html.39e89308.js"><link rel="prefetch" href="/android-note/assets/MD5加密.html.9b0ff02d.js"><link rel="prefetch" href="/android-note/assets/MVC与MVP及MVVM.html.f7c14739.js"><link rel="prefetch" href="/android-note/assets/RMB大小写转换.html.3d5cdd7a.js"><link rel="prefetch" href="/android-note/assets/Vim使用教程.html.522bbd31.js"><link rel="prefetch" href="/android-note/assets/hashCode与equals.html.79e59d3a.js"><link rel="prefetch" href="/android-note/assets/volatile和Synchronized区别.html.0c16f110.js"><link rel="prefetch" href="/android-note/assets/剑指Offer(上).html.fe56a9af.js"><link rel="prefetch" href="/android-note/assets/剑指Offer(下).html.d4f1aed1.js"><link rel="prefetch" href="/android-note/assets/单例的最佳实现方式.html.20acb3b8.js"><link rel="prefetch" href="/android-note/assets/单链表.html.bf62db54.js"><link rel="prefetch" href="/android-note/assets/原子性、可见性以及有序性.html.6deb38fc.js"><link rel="prefetch" href="/android-note/assets/常用命令行大全.html.b46be9ac.js"><link rel="prefetch" href="/android-note/assets/强引用、软引用、弱引用、虚引用.html.513c7a20.js"><link rel="prefetch" href="/android-note/assets/数据加密及解密.html.c4c4dcc3.js"><link rel="prefetch" href="/android-note/assets/死锁.html.99ba4a89.js"><link rel="prefetch" href="/android-note/assets/生产者消费者.html.1b7c653d.js"><link rel="prefetch" href="/android-note/assets/算法.html.9d4e0aef.js"><link rel="prefetch" href="/android-note/assets/线程池的原理.html.537ece5d.js"><link rel="prefetch" href="/android-note/assets/网络请求相关内容总结.html.d6be503e.js"><link rel="prefetch" href="/android-note/assets/获取今后多少天后的日期.html.90a2793b.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(一).html.7d77fbc3.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(七).html.b1be9fff.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(三).html.e19fc3f0.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(九).html.605ed319.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(二).html.a5a68958.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(五).html.011717f3.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(八).html.ef802fd5.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(六).html.f1520e1f.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(四).html.3f7548ca.js"><link rel="prefetch" href="/android-note/assets/RxJava系列全家桶.html.766c9e14.js"><link rel="prefetch" href="/android-note/assets/RxJava详解(上).html.e37403f2.js"><link rel="prefetch" href="/android-note/assets/RxJava详解(下).html.86d3c34a.js"><link rel="prefetch" href="/android-note/assets/RxJava详解(中).html.8b7d82ae.js"><link rel="prefetch" href="/android-note/assets/Activity启动过程.html.14c41b41.js"><link rel="prefetch" href="/android-note/assets/Activity界面绘制过程详解.html.7939bdd8.js"><link rel="prefetch" href="/android-note/assets/Android Touch事件分发详解.html.6e0ecf53.js"><link rel="prefetch" href="/android-note/assets/AsyncTask详解.html.ee42d351.js"><link rel="prefetch" href="/android-note/assets/InstantRun详解.html.50780cae.js"><link rel="prefetch" href="/android-note/assets/ListView源码分析.html.6f55660e.js"><link rel="prefetch" href="/android-note/assets/VideoView源码分析.html.45a2578f.js"><link rel="prefetch" href="/android-note/assets/View绘制过程详解.html.8a6fec11.js"><link rel="prefetch" href="/android-note/assets/butterknife源码详解.html.dc751b15.js"><link rel="prefetch" href="/android-note/assets/自定义View详解.html.3b0d9330.js"><link rel="prefetch" href="/android-note/assets/Android开发工具及类库.html.9e48a859.js"><link rel="prefetch" href="/android-note/assets/Github个人主页绑定域名.html.1c2bdb90.js"><link rel="prefetch" href="/android-note/assets/MAT内存分析.html.967a0203.js"><link rel="prefetch" href="/android-note/assets/Markdown学习手册.html.f37c7aff.js"><link rel="prefetch" href="/android-note/assets/性能优化相关工具.html.49b62c31.js"><link rel="prefetch" href="/android-note/assets/目前流行的开发组合.html.0e2aaf0e.js"><link rel="prefetch" href="/android-note/assets/Android WebRTC简介.html.9fd639b3.js"><link rel="prefetch" href="/android-note/assets/Android音视频开发.html.55bd9526.js"><link rel="prefetch" href="/android-note/assets/DLNA简介.html.2a20a491.js"><link rel="prefetch" href="/android-note/assets/搭建nginx_rtmp服务器.html.f03f6006.js"><link rel="prefetch" href="/android-note/assets/视频播放相关内容总结.html.baa87ac6.js"><link rel="prefetch" href="/android-note/assets/视频解码之软解与硬解.html.d2862232.js"><link rel="prefetch" href="/android-note/assets/音视频基础知识.html.5bef6c29.js"><link rel="prefetch" href="/android-note/assets/HttpURLConnection与HttpClient.html.e75759f0.js"><link rel="prefetch" href="/android-note/assets/Retrofit详解(上).html.b4b4741f.js"><link rel="prefetch" href="/android-note/assets/Retrofit详解(下).html.84ce4ed4.js"><link rel="prefetch" href="/android-note/assets/Volley源码分析.html.96115c87.js"><link rel="prefetch" href="/android-note/assets/volley-retrofit-okhttp之我们该如何选择网路框架.html.37e80618.js"><link rel="prefetch" href="/android-note/assets/404.html.93146c89.js"><link rel="prefetch" href="/android-note/assets/index.html.a3b2c356.js"><link rel="prefetch" href="/android-note/assets/ART与Dalvik.html.593d518f.js"><link rel="prefetch" href="/android-note/assets/Android6.0权限系统.html.1f126c97.js"><link rel="prefetch" href="/android-note/assets/Android卸载反馈.html.a5ba8c6b.js"><link rel="prefetch" href="/android-note/assets/Android启动模式详解.html.ca8b1ccd.js"><link rel="prefetch" href="/android-note/assets/Android开发不申请权限来使用对应功能.html.d0272eba.js"><link rel="prefetch" href="/android-note/assets/Android开发中的MVP模式详解.html.187c5ed4.js"><link rel="prefetch" href="/android-note/assets/ApplicationId vs PackageName.html.56b02a10.js"><link rel="prefetch" href="/android-note/assets/BroadcastReceiver安全问题.html.64aef548.js"><link rel="prefetch" href="/android-note/assets/Handler导致内存泄露分析.html.164306fd.js"><link rel="prefetch" href="/android-note/assets/Library项目中资源id使用case时报错.html.3f4b1857.js"><link rel="prefetch" href="/android-note/assets/Mac下配置adb及Android命令.html.22df54ee.js"><link rel="prefetch" href="/android-note/assets/MaterialDesign使用.html.649f129f.js"><link rel="prefetch" href="/android-note/assets/RecyclerView专题.html.fa20e530.js"><link rel="prefetch" href="/android-note/assets/如何让Service常驻内存.html.a1a10337.js"><link rel="prefetch" href="/android-note/assets/屏幕适配之百分比方案详解.html.e761907d.js"><link rel="prefetch" href="/android-note/assets/布局优化.html.48720165.js"><link rel="prefetch" href="/android-note/assets/性能优化.html.be35e4a9.js"><link rel="prefetch" href="/android-note/assets/注解使用.html.2ba5a7aa.js"><link rel="prefetch" href="/android-note/assets/热修复实现.html.58919723.js"><link rel="prefetch" href="/android-note/assets/通过Hardware Layer提高动画性能.html.6ddb95e6.js"><link rel="prefetch" href="/android-note/assets/Android Studio你可能不知道的操作.html.fdf20e86.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio中进行ndk开发.html.8e054392.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio使用教程(第一弹).html.414cb35a.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio使用教程(第七弹).html.13675508.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio使用教程(第三弹).html.d6d4b951.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio使用教程(第二弹).html.b98f8285.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio使用教程(第五弹).html.5346a958.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio使用教程(第六弹).html.1b23c403.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio使用教程(第四弹).html.48bf4f17.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio提高Build速度.html.00c828d1.js"><link rel="prefetch" href="/android-note/assets/Android应用发布.html.f1757cb9.js"><link rel="prefetch" href="/android-note/assets/Zipalign优化.html.8521978d.js"><link rel="prefetch" href="/android-note/assets/Android入门介绍.html.b1900bf7.js"><link rel="prefetch" href="/android-note/assets/Android动画.html.b0686769.js"><link rel="prefetch" href="/android-note/assets/Android四大组件之ContentProvider.html.5283befd.js"><link rel="prefetch" href="/android-note/assets/Android四大组件之Service.html.c819f916.js"><link rel="prefetch" href="/android-note/assets/Android基础面试题.html.ff577025.js"><link rel="prefetch" href="/android-note/assets/Android编码规范.html.5636ef45.js"><link rel="prefetch" href="/android-note/assets/Ant打包.html.ef8a6333.js"><link rel="prefetch" href="/android-note/assets/Bitmap优化.html.c749c345.js"><link rel="prefetch" href="/android-note/assets/Fragment专题.html.44210aa0.js"><link rel="prefetch" href="/android-note/assets/Home键监听.html.31cc83ad.js"><link rel="prefetch" href="/android-note/assets/HttpClient执行Get和Post请求.html.9dfecddb.js"><link rel="prefetch" href="/android-note/assets/JNI_C语言基础.html.acf1dc16.js"><link rel="prefetch" href="/android-note/assets/JNI基础.html.b863d19a.js"><link rel="prefetch" href="/android-note/assets/ListView专题.html.ccbe3768.js"><link rel="prefetch" href="/android-note/assets/Parcelable及Serializable.html.d7a77f6f.js"><link rel="prefetch" href="/android-note/assets/PopupWindow细节.html.e345b3a9.js"><link rel="prefetch" href="/android-note/assets/SDK Manager无法更新的问题.html.1c81b7f8.js"><link rel="prefetch" href="/android-note/assets/Scroller简介.html.c35eb2fc.js"><link rel="prefetch" href="/android-note/assets/ScrollingTabs.html.6c7ff613.js"><link rel="prefetch" href="/android-note/assets/Selector使用.html.3ae6b882.js"><link rel="prefetch" href="/android-note/assets/SlidingMenu.html.5ff8b11c.js"><link rel="prefetch" href="/android-note/assets/String格式化.html.8bb54a97.js"><link rel="prefetch" href="/android-note/assets/TextView跑马灯效果.html.a6164902.js"><link rel="prefetch" href="/android-note/assets/WebView总结.html.09ce9c48.js"><link rel="prefetch" href="/android-note/assets/Widget(窗口小部件).html.665dba40.js"><link rel="prefetch" href="/android-note/assets/Wifi状态监听.html.33108888.js"><link rel="prefetch" href="/android-note/assets/XmlPullParser.html.562c0f22.js"><link rel="prefetch" href="/android-note/assets/adb logcat使用简介.html.7e555978.js"><link rel="prefetch" href="/android-note/assets/下拉刷新ListView.html.a5b5dc81.js"><link rel="prefetch" href="/android-note/assets/代码混淆.html.6b1638d3.js"><link rel="prefetch" href="/android-note/assets/任务管理器(ActivityManager).html.2b0db888.js"><link rel="prefetch" href="/android-note/assets/修改系统组件样式.html.3988e4e5.js"><link rel="prefetch" href="/android-note/assets/内存泄漏.html.a958fc42.js"><link rel="prefetch" href="/android-note/assets/多线程断点下载.html.e34bdbe5.js"><link rel="prefetch" href="/android-note/assets/安全退出应用程序.html.6e540a45.js"><link rel="prefetch" href="/android-note/assets/屏幕适配.html.d2d7c9b1.js"><link rel="prefetch" href="/android-note/assets/应用后台唤醒后数据的刷新.html.674d0b48.js"><link rel="prefetch" href="/android-note/assets/应用安装.html.b6ce9885.js"><link rel="prefetch" href="/android-note/assets/开发中Log的管理.html.f406015e.js"><link rel="prefetch" href="/android-note/assets/开发中异常的处理.html.e717f114.js"><link rel="prefetch" href="/android-note/assets/快捷方式工具类.html.f9420718.js"><link rel="prefetch" href="/android-note/assets/手机摇晃.html.04da3193.js"><link rel="prefetch" href="/android-note/assets/搜索框.html.12db7ee7.js"><link rel="prefetch" href="/android-note/assets/数据存储.html.b25bda0f.js"><link rel="prefetch" href="/android-note/assets/文件上传.html.9e008ea8.js"><link rel="prefetch" href="/android-note/assets/来电号码归属地提示框.html.f34946bf.js"><link rel="prefetch" href="/android-note/assets/来电监听及录音.html.91e7515b.js"><link rel="prefetch" href="/android-note/assets/横向ListView.html.927862c8.js"><link rel="prefetch" href="/android-note/assets/滑动切换Activity(GestureDetector).html.89709d55.js"><link rel="prefetch" href="/android-note/assets/病毒.html.dfdf570b.js"><link rel="prefetch" href="/android-note/assets/知识大杂烩.html.08bb7427.js"><link rel="prefetch" href="/android-note/assets/短信广播接收者.html.0ae81f02.js"><link rel="prefetch" href="/android-note/assets/程序的启动、卸载和分享.html.d3bf5ba6.js"><link rel="prefetch" href="/android-note/assets/竖着的Seekbar.html.958ad9fd.js"><link rel="prefetch" href="/android-note/assets/自定义Toast.html.3d0fcc1c.js"><link rel="prefetch" href="/android-note/assets/自定义控件.html.091df93c.js"><link rel="prefetch" href="/android-note/assets/自定义状态栏通知.html.cb73d038.js"><link rel="prefetch" href="/android-note/assets/自定义背景.html.76947534.js"><link rel="prefetch" href="/android-note/assets/获取位置(LocationManager).html.e776dd24.js"><link rel="prefetch" href="/android-note/assets/获取应用程序缓存及一键清理.html.8c46b7ff.js"><link rel="prefetch" href="/android-note/assets/获取手机中所有安装的程序.html.b9ca8c91.js"><link rel="prefetch" href="/android-note/assets/获取手机及SD卡可用存储空间.html.7b085d61.js"><link rel="prefetch" href="/android-note/assets/获取联系人.html.a597a6b0.js"><link rel="prefetch" href="/android-note/assets/读取用户logcat日志.html.152b4577.js"><link rel="prefetch" href="/android-note/assets/资源文件拷贝的三种方式.html.bbe32974.js"><link rel="prefetch" href="/android-note/assets/超级管理员(DevicePoliceManager).html.82c852a9.js"><link rel="prefetch" href="/android-note/assets/锁屏以及解锁监听.html.4d107d95.js"><link rel="prefetch" href="/android-note/assets/零权限上传数据.html.53598b60.js"><link rel="prefetch" href="/android-note/assets/音量及屏幕亮度调节.html.235979e1.js"><link rel="prefetch" href="/android-note/assets/黑名单挂断电话及删除电话记录.html.c14f1fd9.js"><link rel="prefetch" href="/android-note/assets/Gradle专题.html.79c074c0.js"><link rel="prefetch" href="/android-note/assets/发布library到Maven仓库.html.1e80f727.js"><link rel="prefetch" href="/android-note/assets/Glide简介(上).html.46ff5834.js"><link rel="prefetch" href="/android-note/assets/Glide简介(下).html.4f649ea3.js"><link rel="prefetch" href="/android-note/assets/图片加载库比较.html.1afb41c6.js"><link rel="prefetch" href="/android-note/assets/Base64加密.html.77fd44d2.js"><link rel="prefetch" href="/android-note/assets/Git命令.html.f67e6cf2.js"><link rel="prefetch" href="/android-note/assets/HashMap实现原理分析.html.87e02d9e.js"><link rel="prefetch" href="/android-note/assets/JVM垃圾回收机制.html.dcfdc432.js"><link rel="prefetch" href="/android-note/assets/Java基础面试题.html.924476e1.js"><link rel="prefetch" href="/android-note/assets/MD5加密.html.043d41ed.js"><link rel="prefetch" href="/android-note/assets/MVC与MVP及MVVM.html.56507109.js"><link rel="prefetch" href="/android-note/assets/RMB大小写转换.html.9b64eb77.js"><link rel="prefetch" href="/android-note/assets/Vim使用教程.html.7ea26885.js"><link rel="prefetch" href="/android-note/assets/hashCode与equals.html.182d318a.js"><link rel="prefetch" href="/android-note/assets/volatile和Synchronized区别.html.73b388a2.js"><link rel="prefetch" href="/android-note/assets/剑指Offer(上).html.08ed1a50.js"><link rel="prefetch" href="/android-note/assets/剑指Offer(下).html.02faa77d.js"><link rel="prefetch" href="/android-note/assets/单例的最佳实现方式.html.ff9f67fa.js"><link rel="prefetch" href="/android-note/assets/单链表.html.816ccbf3.js"><link rel="prefetch" href="/android-note/assets/原子性、可见性以及有序性.html.81be9d3a.js"><link rel="prefetch" href="/android-note/assets/常用命令行大全.html.5979ef3a.js"><link rel="prefetch" href="/android-note/assets/强引用、软引用、弱引用、虚引用.html.d3a34d4d.js"><link rel="prefetch" href="/android-note/assets/数据加密及解密.html.f871bc28.js"><link rel="prefetch" href="/android-note/assets/死锁.html.05fcf641.js"><link rel="prefetch" href="/android-note/assets/生产者消费者.html.124be265.js"><link rel="prefetch" href="/android-note/assets/算法.html.a5d32479.js"><link rel="prefetch" href="/android-note/assets/线程池的原理.html.0447b400.js"><link rel="prefetch" href="/android-note/assets/网络请求相关内容总结.html.23d92421.js"><link rel="prefetch" href="/android-note/assets/获取今后多少天后的日期.html.1f70a7af.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(一).html.0aca5205.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(七).html.c64ac1eb.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(三).html.259d5746.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(九).html.2d7e84b0.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(二).html.f80d0190.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(五).html.cb3b0dd9.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(八).html.5eba2fc6.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(六).html.f95797de.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(四).html.af807638.js"><link rel="prefetch" href="/android-note/assets/RxJava系列全家桶.html.af237da0.js"><link rel="prefetch" href="/android-note/assets/RxJava详解(上).html.c7354991.js"><link rel="prefetch" href="/android-note/assets/RxJava详解(下).html.2c386862.js"><link rel="prefetch" href="/android-note/assets/RxJava详解(中).html.502b69b2.js"><link rel="prefetch" href="/android-note/assets/Activity启动过程.html.4cf1fc11.js"><link rel="prefetch" href="/android-note/assets/Activity界面绘制过程详解.html.0d0ec937.js"><link rel="prefetch" href="/android-note/assets/Android Touch事件分发详解.html.1a5daf97.js"><link rel="prefetch" href="/android-note/assets/AsyncTask详解.html.49cca9fa.js"><link rel="prefetch" href="/android-note/assets/InstantRun详解.html.6bf6b961.js"><link rel="prefetch" href="/android-note/assets/ListView源码分析.html.957f7aff.js"><link rel="prefetch" href="/android-note/assets/VideoView源码分析.html.8e6935a4.js"><link rel="prefetch" href="/android-note/assets/View绘制过程详解.html.db0f2341.js"><link rel="prefetch" href="/android-note/assets/butterknife源码详解.html.28394ba6.js"><link rel="prefetch" href="/android-note/assets/自定义View详解.html.e37f15c5.js"><link rel="prefetch" href="/android-note/assets/Android开发工具及类库.html.4900e197.js"><link rel="prefetch" href="/android-note/assets/Github个人主页绑定域名.html.d17a443e.js"><link rel="prefetch" href="/android-note/assets/MAT内存分析.html.6d4b95b6.js"><link rel="prefetch" href="/android-note/assets/Markdown学习手册.html.7617b5a1.js"><link rel="prefetch" href="/android-note/assets/性能优化相关工具.html.ebe8409a.js"><link rel="prefetch" href="/android-note/assets/目前流行的开发组合.html.d8336de6.js"><link rel="prefetch" href="/android-note/assets/Android WebRTC简介.html.51987a1b.js"><link rel="prefetch" href="/android-note/assets/Android音视频开发.html.4040429e.js"><link rel="prefetch" href="/android-note/assets/DLNA简介.html.fc34230c.js"><link rel="prefetch" href="/android-note/assets/搭建nginx_rtmp服务器.html.8310dbe0.js"><link rel="prefetch" href="/android-note/assets/视频播放相关内容总结.html.a609e06b.js"><link rel="prefetch" href="/android-note/assets/视频解码之软解与硬解.html.92fc9cbb.js"><link rel="prefetch" href="/android-note/assets/音视频基础知识.html.6f0bcff8.js"><link rel="prefetch" href="/android-note/assets/HttpURLConnection与HttpClient.html.3d8a0779.js"><link rel="prefetch" href="/android-note/assets/Retrofit详解(上).html.2513ea33.js"><link rel="prefetch" href="/android-note/assets/Retrofit详解(下).html.d0778e46.js"><link rel="prefetch" href="/android-note/assets/Volley源码分析.html.bfc12cf1.js"><link rel="prefetch" href="/android-note/assets/volley-retrofit-okhttp之我们该如何选择网路框架.html.45995d69.js"><link rel="prefetch" href="/android-note/assets/404.html.bf6755d7.js"><link rel="prefetch" href="/android-note/assets/404.0f84ac09.js"><link rel="prefetch" href="/android-note/assets/Layout.c5c30828.js">
    <link rel="stylesheet" href="/android-note/assets/style.1f7fd01d.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/android-note/" class=""><!----><span class="site-name">Android Notes</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><!----><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><!----><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading"> <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/android-note/SourceAnalysis/Netowork/HttpURLConnection%E8%AF%A6%E8%A7%A3.html#android-httpurlconnection源码分析" class="router-link-active router-link-exact-active sidebar-item" aria-label="Android HttpURLConnection源码分析"><!--[--><!--]--> Android HttpURLConnection源码分析 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h2 id="android-httpurlconnection源码分析" tabindex="-1"><a class="header-anchor" href="#android-httpurlconnection源码分析" aria-hidden="true">#</a> Android HttpURLConnection源码分析</h2><p>之前写过HttpURLConnection与HttpClient的区别及选择。后来又分析了Volley的源码。 最近又遇到了问题，想在Volley中针对HttpURLConnection添加连接池的功能，开始有点懵了，不知道HttpURLConnection要怎么加连接池， 虽然感觉这是没必要的，但是心底确拿不出依据。所以研究下HttpURLConnection的源码进行分析。</p><p>在使用的时候都是通过URL.openConnection()来获取<code>HttpURLConnection</code>对象，然后调用其<code>connect</code>方法进行链接，所以先从<code>URL.penConnection()</code>入手:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Returns a new connection to the resource referred to by this URL.
 *
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">IOException</span></span> if an error occurs while opening the connection.
 */</span>
<span class="token keyword">public</span> <span class="token class-name">URLConnection</span> <span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> streamHandler<span class="token punctuation">.</span><span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接下来就要看一下<code>streamHandler</code>究竟是何方神圣？我们搜一下他的赋值，实在<code>setupStreamHandler</code>方法中进行的：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Sets the receiver&#39;s stream handler to one which is appropriate for its
 * protocol.
 *
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Note that this will overwrite any existing stream handler with the new
 * one. Senders must check if the streamHandler is null before calling the
 * method if they do not want this behavior (a speed optimization).
 *
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">MalformedURLException</span></span> if no reasonable handler is available.
 */</span>
<span class="token keyword">void</span> <span class="token function">setupStreamHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Check for a cached (previously looked up) handler for</span>
    <span class="token comment">// the requested protocol.</span>
    streamHandler <span class="token operator">=</span> streamHandlers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>streamHandler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// If there is a stream handler factory, then attempt to</span>
    <span class="token comment">// use it to create the handler.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>streamHandlerFactory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        streamHandler <span class="token operator">=</span> streamHandlerFactory<span class="token punctuation">.</span><span class="token function">createURLStreamHandler</span><span class="token punctuation">(</span>protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>streamHandler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            streamHandlers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>protocol<span class="token punctuation">,</span> streamHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Check if there is a list of packages which can provide handlers.</span>
    <span class="token comment">// If so, then walk this list looking for an applicable one.</span>
    <span class="token class-name">String</span> packageList <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;java.protocol.handler.pkgs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ClassLoader</span> contextClassLoader <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>packageList <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> contextClassLoader <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> packageName <span class="token operator">:</span> packageList<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;\\|&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> className <span class="token operator">=</span> packageName <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> protocol <span class="token operator">+</span> <span class="token string">&quot;.Handler&quot;</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> c <span class="token operator">=</span> contextClassLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
                streamHandler <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">URLStreamHandler</span><span class="token punctuation">)</span> c<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>streamHandler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    streamHandlers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>protocol<span class="token punctuation">,</span> streamHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Fall back to a built-in stream handler if the user didn&#39;t supply one</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>protocol<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;file&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        streamHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>protocol<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;ftp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        streamHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FtpHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>protocol<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 判断一下如果是HTTP协议，就会创建HtppHandler。看到这里明白了，原来使用的是okhttp.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token string">&quot;com.android.okhttp.HttpHandler&quot;</span><span class="token punctuation">;</span>
            streamHandler <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">URLStreamHandler</span><span class="token punctuation">)</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AssertionError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>protocol<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;https&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token string">&quot;com.android.okhttp.HttpsHandler&quot;</span><span class="token punctuation">;</span>
            streamHandler <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">URLStreamHandler</span><span class="token punctuation">)</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AssertionError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>protocol<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;jar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        streamHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JarHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>streamHandler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        streamHandlers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>protocol<span class="token punctuation">,</span> streamHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里我们就以<code>HTTP</code>协议为例说一下所以找到<code>okhttp HttpHandler.openConnection()</code>方法:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/*
 *  Licensed to the Apache Software Foundation (ASF) under one or more
 *  contributor license agreements.  See the NOTICE file distributed with
 *  this work for additional information regarding copyright ownership.
 *  The ASF licenses this file to You under the Apache License, Version 2.0
 *  (the &quot;License&quot;); you may not use this file except in compliance with
 *  the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 */</span>
<span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>squareup<span class="token punctuation">.</span>okhttp</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">Proxy</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">URL</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">URLConnection</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">URLStreamHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HttpHandler</span> <span class="token keyword">extends</span> <span class="token class-name">URLStreamHandler</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span> <span class="token keyword">protected</span> <span class="token class-name">URLConnection</span> <span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 调用了OKHttpClient()的方法</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OkHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span> <span class="token keyword">protected</span> <span class="token class-name">URLConnection</span> <span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">Proxy</span> proxy<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>url <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> proxy <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;url == null || proxy == null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OkHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setProxy</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span> <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">getDefaultPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">80</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接下来就悲剧了，因为我找不到OkHttpClient()类中有<code>open</code>方法。<br> 仔细查看了文档后发现在<code>OKHttp</code>1.6.0的时候该方法就已经已经过时了。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Deprecated</span>
<span class="token keyword">public</span> <span class="token class-name">HttpURLConnection</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span>
<span class="token class-name">Deprecated</span><span class="token punctuation">.</span> moved <span class="token keyword">to</span> <span class="token class-name">OkUrlFactory</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>那我们怎么往下分析呢？很显然<code>Android sdk</code>中使用的<code>OkHttp</code>不是最新版。所以我们可以使用<code>1.5.0</code>版本的<code>OKHttp</code>接着分析。 在项目<code>build.gradle</code>中进行配置 compile &#39;com.squareup.okhttp:okhttp:1.5.0&#39; 然后开始愉快的查看源码。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>squareup<span class="token punctuation">.</span>okhttp</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>squareup<span class="token punctuation">.</span>okhttp<span class="token punctuation">.</span>internal<span class="token punctuation">.</span></span><span class="token class-name">Util</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>squareup<span class="token punctuation">.</span>okhttp<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpAuthenticator</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>squareup<span class="token punctuation">.</span>okhttp<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpURLConnectionImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>squareup<span class="token punctuation">.</span>okhttp<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpsURLConnectionImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>squareup<span class="token punctuation">.</span>okhttp<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">ResponseCacheAdapter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>squareup<span class="token punctuation">.</span>okhttp<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>okio<span class="token punctuation">.</span></span><span class="token class-name">ByteString</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>squareup<span class="token punctuation">.</span>okhttp<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>tls<span class="token punctuation">.</span></span><span class="token class-name">OkHostnameVerifier</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">CookieHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">HttpURLConnection</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">Proxy</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">ProxySelector</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">ResponseCache</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">URL</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">URLConnection</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">URLStreamHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">URLStreamHandlerFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">GeneralSecurityException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span></span><span class="token class-name">HostnameVerifier</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span></span><span class="token class-name">SSLContext</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span></span><span class="token class-name">SSLSocketFactory</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/** Configures and creates HTTP connections. */</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">OkHttpClient</span> <span class="token keyword">implements</span> <span class="token class-name">URLStreamHandlerFactory</span><span class="token punctuation">,</span> <span class="token class-name">Cloneable</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RouteDatabase</span> routeDatabase<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">Proxy</span> proxy<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Protocol</span><span class="token punctuation">&gt;</span></span> protocols<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">ProxySelector</span> proxySelector<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">CookieHandler</span> cookieHandler<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">OkResponseCache</span> responseCache<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">SSLSocketFactory</span> sslSocketFactory<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">HostnameVerifier</span> hostnameVerifier<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">OkAuthenticator</span> authenticator<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">ConnectionPool</span> connectionPool<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> followProtocolRedirects <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> connectTimeout<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> readTimeout<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">OkHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    routeDatabase <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RouteDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * Sets the default connect timeout for new connections. A value of 0 means no timeout.
   *
   * <span class="token keyword">@see</span> <span class="token reference"><span class="token class-name">URLConnection</span><span class="token punctuation">#</span><span class="token function">setConnectTimeout</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span></span>
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setConnectTimeout</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;timeout &lt; 0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>unit <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;unit == null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">long</span> millis <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>millis <span class="token operator">&gt;</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Timeout too large.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    connectTimeout <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> millis<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/** Default connect timeout (in milliseconds). */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getConnectTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> connectTimeout<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * Sets the default read timeout for new connections. A value of 0 means no timeout.
   *
   * <span class="token keyword">@see</span> <span class="token reference"><span class="token class-name">URLConnection</span><span class="token punctuation">#</span><span class="token function">setReadTimeout</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span></span>
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setReadTimeout</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;timeout &lt; 0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>unit <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;unit == null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">long</span> millis <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>millis <span class="token operator">&gt;</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Timeout too large.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    readTimeout <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> millis<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/** Default read timeout (in milliseconds). */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getReadTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> readTimeout<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * Sets the HTTP proxy that will be used by connections created by this
   * client. This takes precedence over <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">setProxySelector</span></span><span class="token punctuation">}</span>, which is
   * only honored when this proxy is null (which it is by default). To disable
   * proxy use completely, call <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token function">setProxy</span><span class="token punctuation">(</span><span class="token class-name">Proxy</span><span class="token punctuation">.</span>NO_PROXY<span class="token punctuation">)</span></span></span><span class="token punctuation">}</span>.
   */</span>
  <span class="token keyword">public</span> <span class="token class-name">OkHttpClient</span> <span class="token function">setProxy</span><span class="token punctuation">(</span><span class="token class-name">Proxy</span> proxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>proxy <span class="token operator">=</span> proxy<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">Proxy</span> <span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> proxy<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * Sets the proxy selection policy to be used if no <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">setProxy</span></span> proxy<span class="token punctuation">}</span>
   * is specified explicitly. The proxy selector may return multiple proxies;
   * in that case they will be tried in sequence until a successful connection
   * is established.
   *
   * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>If unset, the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ProxySelector</span><span class="token punctuation">#</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span> system-wide default<span class="token punctuation">}</span>
   * proxy selector will be used.
   */</span>
  <span class="token keyword">public</span> <span class="token class-name">OkHttpClient</span> <span class="token function">setProxySelector</span><span class="token punctuation">(</span><span class="token class-name">ProxySelector</span> proxySelector<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>proxySelector <span class="token operator">=</span> proxySelector<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">ProxySelector</span> <span class="token function">getProxySelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> proxySelector<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * Sets the cookie handler to be used to read outgoing cookies and write
   * incoming cookies.
   *
   * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>If unset, the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">CookieHandler</span><span class="token punctuation">#</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span> system-wide default<span class="token punctuation">}</span>
   * cookie handler will be used.
   */</span>
  <span class="token keyword">public</span> <span class="token class-name">OkHttpClient</span> <span class="token function">setCookieHandler</span><span class="token punctuation">(</span><span class="token class-name">CookieHandler</span> cookieHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cookieHandler <span class="token operator">=</span> cookieHandler<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">CookieHandler</span> <span class="token function">getCookieHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> cookieHandler<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * Sets the response cache to be used to read and write cached responses.
   */</span>
  <span class="token keyword">public</span> <span class="token class-name">OkHttpClient</span> <span class="token function">setResponseCache</span><span class="token punctuation">(</span><span class="token class-name">ResponseCache</span> responseCache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">setOkResponseCache</span><span class="token punctuation">(</span><span class="token function">toOkResponseCache</span><span class="token punctuation">(</span>responseCache<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">ResponseCache</span> <span class="token function">getResponseCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> responseCache <span class="token keyword">instanceof</span> <span class="token class-name">ResponseCacheAdapter</span>
        <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ResponseCacheAdapter</span><span class="token punctuation">)</span> responseCache<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">OkHttpClient</span> <span class="token function">setOkResponseCache</span><span class="token punctuation">(</span><span class="token class-name">OkResponseCache</span> responseCache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>responseCache <span class="token operator">=</span> responseCache<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">OkResponseCache</span> <span class="token function">getOkResponseCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> responseCache<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * Sets the socket factory used to secure HTTPS connections.
   *
   * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>If unset, a lazily created SSL socket factory will be used.
   */</span>
  <span class="token keyword">public</span> <span class="token class-name">OkHttpClient</span> <span class="token function">setSslSocketFactory</span><span class="token punctuation">(</span><span class="token class-name">SSLSocketFactory</span> sslSocketFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sslSocketFactory <span class="token operator">=</span> sslSocketFactory<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">SSLSocketFactory</span> <span class="token function">getSslSocketFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> sslSocketFactory<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * Sets the verifier used to confirm that response certificates apply to
   * requested hostnames for HTTPS connections.
   *
   * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>If unset, the
   * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">javax<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span></span><span class="token class-name">HttpsURLConnection</span><span class="token punctuation">#</span><span class="token function">getDefaultHostnameVerifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
   * system-wide default<span class="token punctuation">}</span> hostname verifier will be used.
   */</span>
  <span class="token keyword">public</span> <span class="token class-name">OkHttpClient</span> <span class="token function">setHostnameVerifier</span><span class="token punctuation">(</span><span class="token class-name">HostnameVerifier</span> hostnameVerifier<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hostnameVerifier <span class="token operator">=</span> hostnameVerifier<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">HostnameVerifier</span> <span class="token function">getHostnameVerifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> hostnameVerifier<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * Sets the authenticator used to respond to challenges from the remote web
   * server or proxy server.
   *
   * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>If unset, the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">Authenticator</span><span class="token punctuation">#</span><span class="token field">setDefault</span></span> system-wide default<span class="token punctuation">}</span>
   * authenticator will be used.
   */</span>
  <span class="token keyword">public</span> <span class="token class-name">OkHttpClient</span> <span class="token function">setAuthenticator</span><span class="token punctuation">(</span><span class="token class-name">OkAuthenticator</span> authenticator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>authenticator <span class="token operator">=</span> authenticator<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">OkAuthenticator</span> <span class="token function">getAuthenticator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> authenticator<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * Sets the connection pool used to recycle HTTP and HTTPS connections.
   *
   * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>If unset, the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ConnectionPool</span><span class="token punctuation">#</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span> system-wide
   * default<span class="token punctuation">}</span> connection pool will be used.
   */</span>
  <span class="token keyword">public</span> <span class="token class-name">OkHttpClient</span> <span class="token function">setConnectionPool</span><span class="token punctuation">(</span><span class="token class-name">ConnectionPool</span> connectionPool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>connectionPool <span class="token operator">=</span> connectionPool<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">ConnectionPool</span> <span class="token function">getConnectionPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> connectionPool<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * Configure this client to follow redirects from HTTPS to HTTP and from HTTP
   * to HTTPS.
   *
   * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>If unset, protocol redirects will be followed. This is different than
   * the built-in <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token class-name">HttpURLConnection</span></span></span><span class="token punctuation">}</span>&#39;s default.
   */</span>
  <span class="token keyword">public</span> <span class="token class-name">OkHttpClient</span> <span class="token function">setFollowProtocolRedirects</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> followProtocolRedirects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>followProtocolRedirects <span class="token operator">=</span> followProtocolRedirects<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">getFollowProtocolRedirects</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> followProtocolRedirects<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">RouteDatabase</span> <span class="token function">getRoutesDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> routeDatabase<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * <span class="token keyword">@deprecated</span> OkHttp 1.5 enforces an enumeration of <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Protocol</span></span> protocols<span class="token punctuation">}</span>
   * that can be selected. Please switch to <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token punctuation">#</span><span class="token function">setProtocols</span><span class="token punctuation">(</span><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>.
   */</span>
  <span class="token annotation punctuation">@Deprecated</span>
  <span class="token keyword">public</span> <span class="token class-name">OkHttpClient</span> <span class="token function">setTransports</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> transports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Protocol</span><span class="token punctuation">&gt;</span></span> protocols <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Protocol</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>transports<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> size <span class="token operator">=</span> transports<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">Protocol</span> protocol <span class="token operator">=</span> <span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token class-name">ByteString</span><span class="token punctuation">.</span><span class="token function">encodeUtf8</span><span class="token punctuation">(</span>transports<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        protocols<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">setProtocols</span><span class="token punctuation">(</span>protocols<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * Configure the protocols used by this client to communicate with remote
   * servers. By default this client will prefer the most efficient transport
   * available, falling back to more ubiquitous protocols. Applications should
   * only call this method to avoid specific compatibility problems, such as web
   * servers that behave incorrectly when SPDY is enabled.
   *
   * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>The following protocols are currently supported:
   * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
   *   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/Protocols/rfc2616/rfc2616.html<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>http/1.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
   *   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.chromium.org/spdy/spdy-protocol/spdy-protocol-draft3-1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>spdy/3.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
   *   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://tools.ietf.org/html/draft-ietf-httpbis-http2-09<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>HTTP-draft-09/2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
   * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
   *
   * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>This is an evolving set.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span> Future releases may drop
   * support for transitional protocols (like spdy/3.1), in favor of their
   * successors (spdy/4 or http/2.0). The http/1.1 transport will never be
   * dropped.
   *
   * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>If multiple protocols are specified, <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span>
   <span class="token attr-name">*</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://technotes.googlecode.com/git/nextprotoneg.html<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>NPN<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span> will
   * be used to negotiate a transport. Future releases may use another mechanism
   * (such as <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://tools.ietf.org/html/draft-friedl-tls-applayerprotoneg-02<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>ALPN<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>)
   * to negotiate a transport.
   *
   * <span class="token keyword">@param</span> <span class="token parameter">protocols</span> the protocols to use, in order of preference. The list
   *     must contain &quot;http/1.1&quot;. It must not contain null.
   */</span>
  <span class="token keyword">public</span> <span class="token class-name">OkHttpClient</span> <span class="token function">setProtocols</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Protocol</span><span class="token punctuation">&gt;</span></span> protocols<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    protocols <span class="token operator">=</span> <span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">immutableList</span><span class="token punctuation">(</span>protocols<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>protocols<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">Protocol</span><span class="token punctuation">.</span>HTTP_11<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;protocols doesn&#39;t contain http/1.1: &quot;</span> <span class="token operator">+</span> protocols<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>protocols<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;protocols must not contain null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>protocols <span class="token operator">=</span> <span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">immutableList</span><span class="token punctuation">(</span>protocols<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * <span class="token keyword">@deprecated</span> OkHttp 1.5 enforces an enumeration of <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Protocol</span></span>
   *     protocols<span class="token punctuation">}</span> that can be selected. Please switch to <span class="token punctuation">{</span><span class="token keyword">@link</span>
   *     <span class="token reference"><span class="token punctuation">#</span><span class="token function">getProtocols</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>.
   */</span>
  <span class="token annotation punctuation">@Deprecated</span>
  <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getTransports</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> transports <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>protocols<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> size <span class="token operator">=</span> protocols<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      transports<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>protocols<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">utf8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> transports<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Protocol</span><span class="token punctuation">&gt;</span></span> <span class="token function">getProtocols</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> protocols<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">HttpURLConnection</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">open</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">HttpURLConnection</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">Proxy</span> proxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> protocol <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 将该对象clone后设置一些其他的属性返回，里面会设置一个默认的连接池。</span>
    <span class="token class-name">OkHttpClient</span> copy <span class="token operator">=</span> <span class="token function">copyWithDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    copy<span class="token punctuation">.</span>proxy <span class="token operator">=</span> proxy<span class="token punctuation">;</span>
	<span class="token comment">// 返回了HttpURLConnectionImpl，并且把clone后的OKHttpClient对象传递进去。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>protocol<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HttpURLConnectionImpl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> copy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>protocol<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;https&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HttpsURLConnectionImpl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> copy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Unexpected protocol: &quot;</span> <span class="token operator">+</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * Returns a shallow copy of this OkHttpClient that uses the system-wide
   * default for each field that hasn&#39;t been explicitly configured.
   */</span>
  <span class="token class-name">OkHttpClient</span> <span class="token function">copyWithDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">OkHttpClient</span> result <span class="token operator">=</span> <span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>proxySelector <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      result<span class="token punctuation">.</span>proxySelector <span class="token operator">=</span> <span class="token class-name">ProxySelector</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>cookieHandler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      result<span class="token punctuation">.</span>cookieHandler <span class="token operator">=</span> <span class="token class-name">CookieHandler</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>responseCache <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      result<span class="token punctuation">.</span>responseCache <span class="token operator">=</span> <span class="token function">toOkResponseCache</span><span class="token punctuation">(</span><span class="token class-name">ResponseCache</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>sslSocketFactory <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      result<span class="token punctuation">.</span>sslSocketFactory <span class="token operator">=</span> <span class="token function">getDefaultSSLSocketFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>hostnameVerifier <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      result<span class="token punctuation">.</span>hostnameVerifier <span class="token operator">=</span> <span class="token class-name">OkHostnameVerifier</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>authenticator <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      result<span class="token punctuation">.</span>authenticator <span class="token operator">=</span> <span class="token class-name">HttpAuthenticator</span><span class="token punctuation">.</span>SYSTEM_DEFAULT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>connectionPool <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	  <span class="token comment">// 会给OkHttpClient设置一个默认的连接池</span>
      result<span class="token punctuation">.</span>connectionPool <span class="token operator">=</span> <span class="token class-name">ConnectionPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>protocols <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      result<span class="token punctuation">.</span>protocols <span class="token operator">=</span> <span class="token class-name">Util</span><span class="token punctuation">.</span>HTTP2_SPDY3_AND_HTTP<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * Java and Android programs default to using a single global SSL context,
   * accessible to HTTP clients as <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">SSLSocketFactory</span><span class="token punctuation">#</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>. If we
   * used the shared SSL context, when OkHttp enables NPN for its SPDY-related
   * stuff, it would also enable NPN for other usages, which might crash them
   * because NPN is enabled when it isn&#39;t expected to be.
   * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
   * This code avoids that by defaulting to an OkHttp created SSL context. The
   * significant drawback of this approach is that apps that customize the
   * global SSL context will lose these customizations.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">synchronized</span> <span class="token class-name">SSLSocketFactory</span> <span class="token function">getDefaultSSLSocketFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sslSocketFactory <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">SSLContext</span> sslContext <span class="token operator">=</span> <span class="token class-name">SSLContext</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">&quot;TLS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sslContext<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sslSocketFactory <span class="token operator">=</span> sslContext<span class="token punctuation">.</span><span class="token function">getSocketFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">GeneralSecurityException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AssertionError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// The system has no TLS. Just give up.</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> sslSocketFactory<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/** Returns a shallow copy of this OkHttpClient. */</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token class-name">OkHttpClient</span> <span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">OkHttpClient</span><span class="token punctuation">)</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CloneNotSupportedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AssertionError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token class-name">OkResponseCache</span> <span class="token function">toOkResponseCache</span><span class="token punctuation">(</span><span class="token class-name">ResponseCache</span> responseCache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> responseCache <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> responseCache <span class="token keyword">instanceof</span> <span class="token class-name">OkResponseCache</span>
        <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token class-name">OkResponseCache</span><span class="token punctuation">)</span> responseCache
        <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">ResponseCacheAdapter</span><span class="token punctuation">(</span>responseCache<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * Creates a URLStreamHandler as a <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">URL</span><span class="token punctuation">#</span><span class="token field">setURLStreamHandlerFactory</span></span><span class="token punctuation">}</span>.
   *
   * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>This code configures OkHttp to handle all HTTP and HTTPS connections
   * created with <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">URL</span><span class="token punctuation">#</span><span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span><span class="token punctuation">&gt;</span></span>   <span class="token punctuation">{</span><span class="token keyword">@code</span>
   <span class="token code-section">*
   *   <span class="token code language-java"><span class="token class-name">OkHttpClient</span> okHttpClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OkHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
   *   <span class="token code language-java">URL<span class="token punctuation">.</span><span class="token function">setURLStreamHandlerFactory</span><span class="token punctuation">(</span>okHttpClient<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
   *</span> <span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre</span><span class="token punctuation">&gt;</span></span>
   */</span>
  <span class="token keyword">public</span> <span class="token class-name">URLStreamHandler</span> <span class="token function">createURLStreamHandler</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> protocol<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>protocol<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>protocol<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;https&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">URLStreamHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token annotation punctuation">@Override</span> <span class="token keyword">protected</span> <span class="token class-name">URLConnection</span> <span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">open</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token annotation punctuation">@Override</span> <span class="token keyword">protected</span> <span class="token class-name">URLConnection</span> <span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">Proxy</span> proxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">open</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token annotation punctuation">@Override</span> <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">getDefaultPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>protocol<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">80</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>protocol<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;https&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">443</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AssertionError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接着看一下<code>HttpURLConnectionImpl</code>类,它是<code>HttpURLConnection</code>的子类：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HttpURLConnectionImpl</span> <span class="token keyword">extends</span> <span class="token class-name">HttpURLConnection</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>到这里<code>new URL(url).openConnection()</code>方法已经分析完了，其实就是返回了一个HtppURLConnectionImpl对象。</p><p>我们在使用<code>HttpURLConnection</code>都是这样使用：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">&quot;http://www.baidu.com&quot;</span>
<span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">HttpURLConnection</span> connection <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpURLConnection</span><span class="token punctuation">)</span>url<span class="token punctuation">.</span><span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 设置一些请求头等参数</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
connection<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 然后调用一些其他的获取结果或者状态的方法。</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
connection<span class="token punctuation">.</span><span class="token function">getResponseCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
connection<span class="token punctuation">.</span><span class="token function">getOuoputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
connection<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面分析了<code>new URL().openConnection()</code>那我们这里就接着分析第二步了，就是调用<code>connect()</code>方法的处理:<br> 这里看一下<code>HttpURLConnectionImpl.connect()</code>方法：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token function">initHttpEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">boolean</span> success<span class="token punctuation">;</span>
<span class="token keyword">do</span> <span class="token punctuation">{</span>
  success <span class="token operator">=</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接着看一下<code>initHttpEngine()</code>方法的实现:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initHttpEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>httpEngineFailure <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> httpEngineFailure<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>httpEngine <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    connected <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>doOutput<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// they are requesting a stream to write to. This implies a POST method</span>
          method <span class="token operator">=</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token function">hasRequestBody</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// If the request method is neither POST nor PUT nor PATCH, then you&#39;re not writing</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ProtocolException</span><span class="token punctuation">(</span>method <span class="token operator">+</span> <span class="token string">&quot; does not support writing&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 将newHttpEngine方法的返回值赋值给HttpEngine的成员变量。</span>
      httpEngine <span class="token operator">=</span> <span class="token function">newHttpEngine</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      httpEngineFailure <span class="token operator">=</span> e<span class="token punctuation">;</span>
      <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token class-name">HttpEngine</span> <span class="token function">newHttpEngine</span><span class="token punctuation">(</span><span class="token class-name">String</span> method<span class="token punctuation">,</span> <span class="token class-name">Connection</span> connection<span class="token punctuation">,</span>
      <span class="token class-name">RetryableSink</span> requestBody<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Request<span class="token punctuation">.</span>Builder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token function">getURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/* No body; that&#39;s passed separately. */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Headers</span> headers <span class="token operator">=</span> requestHeaders<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> headers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      builder<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span>headers<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> headers<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">boolean</span> bufferRequestBody<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fixedContentLength <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      bufferRequestBody <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      builder<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Length&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>fixedContentLength<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>chunkLength <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      bufferRequestBody <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      builder<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;Transfer-Encoding&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;chunked&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      bufferRequestBody <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Request</span> request <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// If we&#39;re currently not using caches, make sure the engine&#39;s client doesn&#39;t have one.</span>
    <span class="token class-name">OkHttpClient</span> engineClient <span class="token operator">=</span> client<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>engineClient<span class="token punctuation">.</span><span class="token function">getOkResponseCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">getUseCaches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      engineClient <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setOkResponseCache</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 将之前通过构造函数传递进来的OkHttpClient对象clone一份后再传递给HttpEngine</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HttpEngine</span><span class="token punctuation">(</span>engineClient<span class="token punctuation">,</span> request<span class="token punctuation">,</span> bufferRequestBody<span class="token punctuation">,</span> connection<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> requestBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>到这里我们知道他会创建一个<code>HttpEngine</code>类，我们先不管它，接着看一下<code>execute()</code>方法的内部实现：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
* Sends a request and optionally reads a response. Returns true if the
* request was successfully executed, and false if the request can be
* retried. Throws an exception if the request failed permanently.
*/</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> readResponse<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token comment">// 调用了HttpEngine的sendRequest方法。</span>
  httpEngine<span class="token punctuation">.</span><span class="token function">sendRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  route <span class="token operator">=</span> httpEngine<span class="token punctuation">.</span><span class="token function">getRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  handshake <span class="token operator">=</span> httpEngine<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span>
      <span class="token operator">?</span> httpEngine<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHandshake</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">// 读取结果，我们先不分析这里，等把sendRequest部分全部分析完成后再回来分析readResponse()部分。</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>readResponse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    httpEngine<span class="token punctuation">.</span><span class="token function">readResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">HttpEngine</span> retryEngine <span class="token operator">=</span> httpEngine<span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>retryEngine <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    httpEngine <span class="token operator">=</span> retryEngine<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Give up; recovery is not possible.</span>
  httpEngineFailure <span class="token operator">=</span> e<span class="token punctuation">;</span>
  <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>到这里，可以大胆的猜测一下了<code>HttpEngine</code>应该就是实际在<code>Socket</code>链接上进行数据收发的类。 当然这只是猜测，接着看一下它的实现:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Handles a single HTTP request/response pair. Each HTTP engine follows this
 * lifecycle:
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ol</span><span class="token punctuation">&gt;</span></span>
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>It is created.
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>The HTTP request message is sent with sendRequest(). Once the request
 * is sent it is an error to modify the request headers. After
 * sendRequest() has been called the request body can be written to if
 * it exists.
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>The HTTP response message is read with readResponse(). After the
 * response has been read the response headers and body can be read.
 * All responses have a response body input stream, though in some
 * instances this stream is empty.
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ol</span><span class="token punctuation">&gt;</span></span>
 *
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>The request and response may be served by the HTTP response cache, by the
 * network, or by both in the event of a conditional GET.
 */</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>文档验证了我们的想法。因为它内部实现代码比较多，所以就不全部贴了，按照重要的一步步分析，既然上面调用了<code>sendRequest()</code>方法，这里就从他入手：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
* Figures out what the response source will be, and opens a socket to that
* source if necessary. Prepares the request headers and gets ready to start
* writing the request body if it exists.
*/</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">sendRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>responseSource <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// Already sent.</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>transport <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 设置一些请求头，正式这个方法内部默认设置了`Keep-Alive`的值，也就是在Android Level 9之前因为Bug，我们需要关闭它的具体处理位置。   </span>
	<span class="token function">prepareRawRequestHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 处理cache</span>
	<span class="token class-name">OkResponseCache</span> responseCache <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getOkResponseCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token class-name">Response</span> cacheResponse <span class="token operator">=</span> responseCache <span class="token operator">!=</span> <span class="token keyword">null</span>
		<span class="token operator">?</span> responseCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
		<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">CacheStrategy</span> cacheStrategy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CacheStrategy<span class="token punctuation">.</span>Factory</span><span class="token punctuation">(</span>now<span class="token punctuation">,</span> request<span class="token punctuation">,</span> cacheResponse<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	responseSource <span class="token operator">=</span> cacheStrategy<span class="token punctuation">.</span>source<span class="token punctuation">;</span>
	request <span class="token operator">=</span> cacheStrategy<span class="token punctuation">.</span>request<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>responseCache <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	  <span class="token comment">// 记录下当前的请求是来自网络请求还是来时缓存中的数据。</span>
	  responseCache<span class="token punctuation">.</span><span class="token function">trackResponse</span><span class="token punctuation">(</span>responseSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>responseSource <span class="token operator">!=</span> <span class="token class-name">ResponseSource</span><span class="token punctuation">.</span>NETWORK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	  validatingResponse <span class="token operator">=</span> cacheStrategy<span class="token punctuation">.</span>response<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>cacheResponse <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>responseSource<span class="token punctuation">.</span><span class="token function">usesCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	  <span class="token function">closeQuietly</span><span class="token punctuation">(</span>cacheResponse<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// We don&#39;t need this cached response. Close it.</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>responseSource<span class="token punctuation">.</span><span class="token function">requiresConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	  <span class="token comment">// Open a connection unless we inherited one from a redirect.</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span>connection <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 调用connect方法，内部会重新创建一个connection，连接到服务器、重定向或者通过代理。</span>
		<span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token punctuation">}</span>
	  <span class="token comment">// 通过Connection创建一个HttpTransport类。这个和后面的connection类一起看， Transport接口提供了一个用户写Request头和数据的输出流。</span>
	  transport <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Transport</span><span class="token punctuation">)</span> connection<span class="token punctuation">.</span><span class="token function">newTransport</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	  <span class="token comment">// Create a request body if we don&#39;t have one already. We&#39;ll already have</span>
	  <span class="token comment">// one if we&#39;re retrying a failed POST.</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasRequestBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> requestBodyOut <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 通过transport创建一个请求体的输出流，requestBodyOut是Sink接口的实现类，其实就是将请求头和请求体发送给服务器。这部分跟下去内容比较多，就不往下跟了。</span>
	　　　　<span class="token comment">// 到这里就已经完成了与服务器的连接功能，并且把请求内容发送给服务器。请求部分就执行完了，可以回去了，还知道开头是哪吗？哈哈。接下来的就是从服务器接口读取返回数据了。  </span>
		requestBodyOut <span class="token operator">=</span> transport<span class="token punctuation">.</span><span class="token function">createRequestBody</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token punctuation">}</span>

	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
	  <span class="token comment">// We&#39;re using a cached response. Recycle a connection we may have inherited from a redirect.</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span>connection <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 回收connection，这里就看到了连接池，这个client就是构造函数中传递进来的OKHttpClient</span>
		client<span class="token punctuation">.</span><span class="token function">getConnectionPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
		connection <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	  <span class="token punctuation">}</span>

	  <span class="token comment">// No need for the network! Promote the cached response immediately.</span>
	  <span class="token keyword">this</span><span class="token punctuation">.</span>response <span class="token operator">=</span> validatingResponse<span class="token punctuation">;</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span>validatingResponse<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">initContentStream</span><span class="token punctuation">(</span>validatingResponse<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接着看一下<code>connect()</code>方法：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/** Connect to the origin server either directly or via a proxy. */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>connection <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>routeSelector <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	  <span class="token class-name">String</span> uriHost <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span>uriHost <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> uriHost<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnknownHostException</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token punctuation">}</span>
	  <span class="token class-name">SSLSocketFactory</span> sslSocketFactory <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	  <span class="token class-name">HostnameVerifier</span> hostnameVerifier <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">isHttps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		sslSocketFactory <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getSslSocketFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		hostnameVerifier <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getHostnameVerifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token punctuation">}</span>
	  <span class="token class-name">Address</span> address <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Address</span><span class="token punctuation">(</span>uriHost<span class="token punctuation">,</span> <span class="token function">getEffectivePort</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sslSocketFactory<span class="token punctuation">,</span>
		  hostnameVerifier<span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">getAuthenticator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">getProtocols</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token comment">// RoteSeclector类介绍. Selects routes to connect to an origin server. Each connection requires a</span>
	  <span class="token comment">// choice of proxy server, IP address, and TLS mode. Connections may also be</span>
	  <span class="token comment">// recycled.注意他把OkHttpClient中的connection pool传递进来了。</span>
	  routeSelector <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RouteSelector</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">getProxySelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		  client<span class="token punctuation">.</span><span class="token function">getConnectionPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Dns</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">getRoutesDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// roteSeclecrot.next()方法的注释Returns the next route address to attempt.这一步非常重要。</span>
	connection <span class="token operator">=</span> routeSelector<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>connection<span class="token punctuation">.</span><span class="token function">isConnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	  <span class="token comment">// connection 进行连接了啊。他里面会用Socket开始连了。。后面我们再细看。简单的说Connection管理了Socket，后面我们要重点看这个类。</span>
	  connection<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getConnectTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">getReadTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getTunnelConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">isSpdy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> client<span class="token punctuation">.</span><span class="token function">getConnectionPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">share</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
	  client<span class="token punctuation">.</span><span class="token function">getRoutesDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">connected</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">getRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>connection<span class="token punctuation">.</span><span class="token function">isSpdy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	  connection<span class="token punctuation">.</span><span class="token function">updateReadTimeout</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getReadTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	route <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">getRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接下来我们要先看一下routeSelector.next()方法如何返回connection对象，然后在看Connection.connect()方法：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
* Returns the next route address to attempt.
*
* <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">NoSuchElementException</span></span> if there are no more routes to attempt.
*/</span>
<span class="token keyword">public</span> <span class="token class-name">Connection</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token class-name">String</span> method<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使用连接池获取Connection的地方。pool就是OkHttpClient中的连接池。</span>
	<span class="token comment">// Always prefer pooled connections over new connections.</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span> pooled<span class="token punctuation">;</span> <span class="token punctuation">(</span>pooled <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
	  <span class="token comment">// 匹配get方法，或者判断是否可读，http1.x是通过判断socket是否关闭来判断是否可读的。</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span> pooled<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> pooled<span class="token punctuation">;</span>
	  <span class="token comment">// 不满足重用，就关闭。</span>
	  pooled<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Compute the next route to attempt.</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasNextTlsMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasNextInetSocketAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasNextProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasNextPostponed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		  <span class="token punctuation">}</span>
		  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Connection</span><span class="token punctuation">(</span>pool<span class="token punctuation">,</span> <span class="token function">nextPostponed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		lastProxy <span class="token operator">=</span> <span class="token function">nextProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">resetNextInetSocketAddress</span><span class="token punctuation">(</span>lastProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token punctuation">}</span>
	  lastInetSocketAddress <span class="token operator">=</span> <span class="token function">nextInetSocketAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token function">resetNextTlsMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">boolean</span> modernTls <span class="token operator">=</span> <span class="token function">nextTlsMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> TLS_MODE_MODERN<span class="token punctuation">;</span>
	<span class="token class-name">Route</span> route <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Route</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> lastProxy<span class="token punctuation">,</span> lastInetSocketAddress<span class="token punctuation">,</span> modernTls<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>routeDatabase<span class="token punctuation">.</span><span class="token function">shouldPostpone</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	  postponedRoutes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token comment">// We will only recurse in order to skip previously failed routes. They will be</span>
	  <span class="token comment">// tried last.</span>
	  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token comment">// 没有的话也会去创建，并把OkHttpClient中的连接池传递进去。</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Connection</span><span class="token punctuation">(</span>pool<span class="token punctuation">,</span> route<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再看一下<code>Connection</code>类的实现以及其<code>connect()</code>方法:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Connection</span> <span class="token keyword">implements</span> <span class="token class-name">Closeable</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConnectionPool</span> pool<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Route</span> route<span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token class-name">Socket</span> socket<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">InputStream</span> in<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">OutputStream</span> out<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">BufferedSource</span> source<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">BufferedSink</span> sink<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> connected <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">HttpConnection</span> httpConnection<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">SpdyConnection</span> spdyConnection<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> httpMinorVersion <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// Assume HTTP/1.1</span>
  <span class="token keyword">private</span> <span class="token keyword">long</span> idleStartTimeNs<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">Handshake</span> handshake<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> recycleCount<span class="token punctuation">;</span>
  <span class="token comment">// 传递进来的连接池。</span>
  <span class="token keyword">public</span> <span class="token class-name">Connection</span><span class="token punctuation">(</span><span class="token class-name">ConnectionPool</span> pool<span class="token punctuation">,</span> <span class="token class-name">Route</span> route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pool <span class="token operator">=</span> pool<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>route <span class="token operator">=</span> route<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">int</span> connectTimeout<span class="token punctuation">,</span> <span class="token keyword">int</span> readTimeout<span class="token punctuation">,</span> <span class="token class-name">TunnelRequest</span> tunnelRequest<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>connected<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;already connected&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    socket <span class="token operator">=</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">Proxy<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span>HTTP<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>proxy<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 连socket了，内部调用了socket.connect()方法。Connects this socket to the given remote host address and port specified</span>
    <span class="token comment">// by the SocketAddress {@code remoteAddr} with the specified timeout. The</span>
    <span class="token comment">// connecting method will block until the connection is established or an</span>
    <span class="token comment">// error occurred.</span>
    <span class="token class-name">Platform</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">connectSocket</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> route<span class="token punctuation">.</span>inetSocketAddress<span class="token punctuation">,</span> connectTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    socket<span class="token punctuation">.</span><span class="token function">setSoTimeout</span><span class="token punctuation">(</span>readTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    in <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    out <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>address<span class="token punctuation">.</span>sslSocketFactory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	  <span class="token comment">// 完成TLS握手和验证</span>
      <span class="token function">upgradeToTls</span><span class="token punctuation">(</span>tunnelRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">initSourceAndSink</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 创建HttpConnection.A socket connection that can be used to send HTTP/1.1 messages. </span>
      <span class="token comment">// 这个HttpConnection有什么用呢？就是下面的newTransport方法中会用。而且还要把连接池传递进去？</span>
      httpConnection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpConnection</span><span class="token punctuation">(</span>pool<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> source<span class="token punctuation">,</span> sink<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 这样就已经连接上了</span>
    connected <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 该方法决定了使用的协议是SPDY还是HTTP</span>
  <span class="token doc-comment comment">/** Returns the transport appropriate for this connection. */</span>
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">newTransport</span><span class="token punctuation">(</span><span class="token class-name">HttpEngine</span> httpEngine<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>spdyConnection <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">SpdyTransport</span><span class="token punctuation">(</span>httpEngine<span class="token punctuation">,</span> spdyConnection<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">HttpTransport</span><span class="token punctuation">(</span>httpEngine<span class="token punctuation">,</span> httpConnection<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>到这里就已经把发送请求到服务器的部分全部分析完了，就想上面所说的我们应该回去了，回去分析发送完请求后的部分。 我们这个分析是在<code>HttpURLConnectionImpl.execute()</code>方法中的<code>HttpEngine.sendRequest()</code>方法开始一直分析下来的， 所以我们还是要回到<code>HttpURLConnectionImpl.execute()</code>方法中.</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> readResponse<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token comment">// 上面已经把sendRequest部分全部分析完了，该方法会与服务器通过Socket建立连接并把请求部分发送给服务器。</span>
  httpEngine<span class="token punctuation">.</span><span class="token function">sendRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  route <span class="token operator">=</span> httpEngine<span class="token punctuation">.</span><span class="token function">getRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  handshake <span class="token operator">=</span> httpEngine<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span>
      <span class="token operator">?</span> httpEngine<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHandshake</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>readResponse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 发送完请求之后该干什么呢？ 当然是读取返回数据了。。。 没错就是它。但是不要忘了在connect()方法传递过来的时候这个值是false。</span>
    <span class="token comment">// 所以这一步在这里是不执行的，但是我们也分析下，方便以后理解。那这个值什么时候是true呢？就是在getResponse()方法中。</span>
    httpEngine<span class="token punctuation">.</span><span class="token function">readResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">HttpEngine</span> retryEngine <span class="token operator">=</span> httpEngine<span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>retryEngine <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    httpEngine <span class="token operator">=</span> retryEngine<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Give up; recovery is not possible.</span>
  httpEngineFailure <span class="token operator">=</span> e<span class="token punctuation">;</span>
  <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接着看<code>HttpEngine.readResponse()</code>方法吧。注释说的非常明白。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
* Flushes the remaining request header and body, parses the HTTP response
* headers and starts reading the HTTP response body if it exists.
*/</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">readResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>response <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>responseSource <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;call sendRequest() first!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>responseSource<span class="token punctuation">.</span><span class="token function">requiresConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

<span class="token comment">// Flush the request body if there&#39;s data outstanding.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>bufferedRequestBody <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> bufferedRequestBody<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  bufferedRequestBody<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>sentRequestMillis <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">OkHeaders</span><span class="token punctuation">.</span><span class="token function">contentLength</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> requestBodyOut <span class="token keyword">instanceof</span> <span class="token class-name">RetryableSink</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// We might not learn the Content-Length until the request body has been buffered.</span>
    <span class="token keyword">long</span> contentLength <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RetryableSink</span><span class="token punctuation">)</span> requestBodyOut<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contentLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    request <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Length&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>contentLength<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  transport<span class="token punctuation">.</span><span class="token function">writeRequestHeaders</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>requestBodyOut <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>bufferedRequestBody <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This also closes the wrapped requestBodyOut.</span>
    bufferedRequestBody<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    requestBodyOut<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>requestBodyOut <span class="token keyword">instanceof</span> <span class="token class-name">RetryableSink</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    transport<span class="token punctuation">.</span><span class="token function">writeRequestBody</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RetryableSink</span><span class="token punctuation">)</span> requestBodyOut<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

transport<span class="token punctuation">.</span><span class="token function">flushRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

response <span class="token operator">=</span> transport<span class="token punctuation">.</span><span class="token function">readResponseHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">handshake</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">getHandshake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token class-name">OkHeaders</span><span class="token punctuation">.</span>SENT_MILLIS<span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>sentRequestMillis<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token class-name">OkHeaders</span><span class="token punctuation">.</span>RECEIVED_MILLIS<span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setResponseSource</span><span class="token punctuation">(</span>responseSource<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
connection<span class="token punctuation">.</span><span class="token function">setHttpMinorVersion</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">httpMinorVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">receiveHeaders</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>responseSource <span class="token operator">==</span> <span class="token class-name">ResponseSource</span><span class="token punctuation">.</span>CONDITIONAL_CACHE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 检查缓存是否可用，如果可用就用当前缓存的response。并且释放该连接。</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>validatingResponse<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    transport<span class="token punctuation">.</span><span class="token function">emptyTransferStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">releaseConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response <span class="token operator">=</span> <span class="token function">combine</span><span class="token punctuation">(</span>validatingResponse<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Update the cache after combining headers but before stripping the</span>
    <span class="token comment">// Content-Encoding header (as performed by initContentStream()).</span>
    <span class="token class-name">OkResponseCache</span> responseCache <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getOkResponseCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    responseCache<span class="token punctuation">.</span><span class="token function">trackConditionalCacheHit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    responseCache<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>validatingResponse<span class="token punctuation">,</span> <span class="token function">cacheableResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>validatingResponse<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">initContentStream</span><span class="token punctuation">(</span>validatingResponse<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">closeQuietly</span><span class="token punctuation">(</span>validatingResponse<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasResponseBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Don&#39;t call initContentStream() when the response doesn&#39;t have any content.</span>
  responseTransferSource <span class="token operator">=</span> transport<span class="token punctuation">.</span><span class="token function">getTransferStream</span><span class="token punctuation">(</span>cacheRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
  responseBody <span class="token operator">=</span> responseTransferSource<span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 设置cacheRequest的值</span>
<span class="token function">maybeCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 设置返回数据了，transport这里也就是HttpTransport。他的getTransferStream返回的是一个Source接口的实现类。也就是返回的数据。</span>
<span class="token function">initContentStream</span><span class="token punctuation">(</span>transport<span class="token punctuation">.</span><span class="token function">getTransferStream</span><span class="token punctuation">(</span>cacheRequest<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>先看一下maybeCache()方法：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">maybeCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token class-name">OkResponseCache</span> responseCache <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getOkResponseCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>responseCache <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

<span class="token comment">// Should we cache this response for this request?</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CacheStrategy</span><span class="token punctuation">.</span><span class="token function">isCacheable</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  responseCache<span class="token punctuation">.</span><span class="token function">maybeRemove</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Offer this request to the cache.</span>
cacheRequest <span class="token operator">=</span> responseCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token function">cacheableResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再看一下<code>initContentStream()</code>方法：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
* Initialize the response content stream from the response transfer source.
* These two sources are the same unless we&#39;re doing transparent gzip, in
* which case the content source is decompressed.
*
* <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Whenever we do transparent gzip we also strip the corresponding headers.
* We strip the Content-Encoding header to prevent the application from
* attempting to double decompress. We strip the Content-Length header because
* it is the length of the compressed content, but the application is only
* interested in the length of the uncompressed content.
*
* <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>This method should only be used for non-empty response bodies. Response
* codes like &quot;304 Not Modified&quot; can include &quot;Content-Encoding: gzip&quot; without
* a response body and we will crash if we attempt to decompress the zero-byte
* source.
*/</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initContentStream</span><span class="token punctuation">(</span><span class="token class-name">Source</span> transferSource<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
responseTransferSource <span class="token operator">=</span> transferSource<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>transparentGzip <span class="token operator">&amp;&amp;</span> <span class="token string">&quot;gzip&quot;</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Encoding&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token comment">// 没有结果时response为null，有结果了就会给他赋值。</span>
  response <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">removeHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Encoding&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">removeHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Length&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  responseBody <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GzipSource</span><span class="token punctuation">(</span>transferSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  responseBody <span class="token operator">=</span> transferSource<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>到这里又执行完了，responseBody已经被赋值了，他是一个Source接口的实现类。也就是说到这里，这次网络请求就完成了，也收到了服务器返回的数据。</p><p>也就是说到这里我们已经分析了:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">HttpURLConnection</span> connection <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpURLConnection</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
connection<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>接下来就是分析<code>connection.getResponseCode()</code>以及<code>connection.getOutputStream()</code>这两个方法了。<br> 先看一下<code>getResponseCode()</code>方法：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getResponseCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token comment">// 看到了吗？这里就是刚才我们说的execute()方法的参数什么时候会为true的地方。</span>
<span class="token keyword">return</span> <span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>那我们接着看一下<code>getResponse()</code>方法，其实就是直接读取响应头的响应值：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
* Aggressively tries to get the final HTTP response, potentially making
* many HTTP requests in the process in order to cope with redirects and
* authentication.
*/</span>
<span class="token keyword">private</span> <span class="token class-name">HttpEngine</span> <span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token function">initHttpEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 如果已经有返回数据了就直接返回</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>httpEngine<span class="token punctuation">.</span><span class="token function">hasResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> httpEngine<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 参数为true了。</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">continue</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">Retry</span> retry <span class="token operator">=</span> <span class="token function">processResponseHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>retry <span class="token operator">==</span> <span class="token class-name">Retry</span><span class="token punctuation">.</span>NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    httpEngine<span class="token punctuation">.</span><span class="token function">releaseConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> httpEngine<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// The first request was insufficient. Prepare for another...</span>
  <span class="token class-name">String</span> retryMethod <span class="token operator">=</span> method<span class="token punctuation">;</span>
  <span class="token class-name">Sink</span> requestBody <span class="token operator">=</span> httpEngine<span class="token punctuation">.</span><span class="token function">getRequestBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Although RFC 2616 10.3.2 specifies that a HTTP_MOVED_PERM</span>
  <span class="token comment">// redirect should keep the same method, Chrome, Firefox and the</span>
  <span class="token comment">// RI all issue GETs when following any redirect.</span>
  <span class="token keyword">int</span> responseCode <span class="token operator">=</span> httpEngine<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>responseCode <span class="token operator">==</span> HTTP_MULT_CHOICE
      <span class="token operator">||</span> responseCode <span class="token operator">==</span> HTTP_MOVED_PERM
      <span class="token operator">||</span> responseCode <span class="token operator">==</span> HTTP_MOVED_TEMP
      <span class="token operator">||</span> responseCode <span class="token operator">==</span> HTTP_SEE_OTHER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    retryMethod <span class="token operator">=</span> <span class="token string">&quot;GET&quot;</span><span class="token punctuation">;</span>
    requestHeaders<span class="token punctuation">.</span><span class="token function">removeAll</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Length&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    requestBody <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>requestBody <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>requestBody <span class="token keyword">instanceof</span> <span class="token class-name">RetryableSink</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">HttpRetryException</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot retry streamed HTTP body&quot;</span><span class="token punctuation">,</span> responseCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>retry <span class="token operator">==</span> <span class="token class-name">Retry</span><span class="token punctuation">.</span>DIFFERENT_CONNECTION<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    httpEngine<span class="token punctuation">.</span><span class="token function">releaseConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">Connection</span> connection <span class="token operator">=</span> httpEngine<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  httpEngine <span class="token operator">=</span> <span class="token function">newHttpEngine</span><span class="token punctuation">(</span>retryMethod<span class="token punctuation">,</span> connection<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">RetryableSink</span><span class="token punctuation">)</span> requestBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接着看一下<code>getOutputStream()</code>的源码：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">OutputStream</span> <span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token comment">// 看到了吗？他内部会先去调用connect()方法</span>
<span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

　  <span class="token comment">// 这里可能有人会有说，getOutputStream和request body有什么关系，应该是response body才对啊。</span>
<span class="token comment">// 不要弄混了啊，getOutputStream是要把post请求的数据输入给请求。</span>
<span class="token class-name">BufferedSink</span> sink <span class="token operator">=</span> httpEngine<span class="token punctuation">.</span><span class="token function">getBufferedRequestBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>sink <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ProtocolException</span><span class="token punctuation">(</span><span class="token string">&quot;method does not support a request body: &quot;</span> <span class="token operator">+</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>httpEngine<span class="token punctuation">.</span><span class="token function">hasResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ProtocolException</span><span class="token punctuation">(</span><span class="token string">&quot;cannot write request body after response has been read&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">return</span> sink<span class="token punctuation">.</span><span class="token function">outputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>顺便再看一下<code>getInputStream()</code>方法：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">InputStream</span> <span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>doInput<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ProtocolException</span><span class="token punctuation">(</span><span class="token string">&quot;This protocol does not support input&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 它也会直接调用getResponse()方法，这个比较好理解。</span>
<span class="token class-name">HttpEngine</span> response <span class="token operator">=</span> <span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// if the requested file does not exist, throw an exception formerly the</span>
<span class="token comment">// Error page from the server was returned if the requested file was</span>
<span class="token comment">// text/html this has changed to return FileNotFoundException for all</span>
<span class="token comment">// file types</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getResponseCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> HTTP_BAD_REQUEST<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">FileNotFoundException</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">InputStream</span> result <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getResponseBodyBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ProtocolException</span><span class="token punctuation">(</span><span class="token string">&quot;No response body exists; responseCode=&quot;</span> <span class="token operator">+</span> <span class="token function">getResponseCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再顺便看一下<code>HttpURLConnection.disconnect()</code>方法，因为这个方法可能很多人不清楚该不该调用他,不过注释说的很明白了：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Releases this connection so that its resources may be either reused or
 * closed.
 *
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Unlike other Java implementations, this will not necessarily close
 * socket connections that can be reused. You can disable all connection
 * reuse by setting the <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java">http<span class="token punctuation">.</span>keepAlive</span></span><span class="token punctuation">}</span> system property to <span class="token punctuation">{</span><span class="token keyword">@code</span>
 <span class="token code-section">* <span class="token code language-java"><span class="token boolean">false</span></span></span><span class="token punctuation">}</span> before issuing any HTTP requests.
 */</span>
<span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// Calling disconnect() before a connection exists should have no effect.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>httpEngine <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 调用HttpEngine.close()方法</span>
  httpEngine<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>看一下HttpEngine.close()方法:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
* Release any resources held by this engine. If a connection is still held by
* this engine, it is returned.
*/</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">Connection</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>bufferedRequestBody <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// This also closes the wrapped requestBodyOut.</span>
  <span class="token function">closeQuietly</span><span class="token punctuation">(</span>bufferedRequestBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>requestBodyOut <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">closeQuietly</span><span class="token punctuation">(</span>requestBodyOut<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// If this engine never achieved a response body, its connection cannot be reused.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>responseBody <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">closeQuietly</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
  connection <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Close the response body. This will recycle the connection if it is eligible.</span>
<span class="token function">closeQuietly</span><span class="token punctuation">(</span>responseBody<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Clear the buffer held by the response body input stream adapter.</span>
<span class="token function">closeQuietly</span><span class="token punctuation">(</span>responseBodyBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// HttpTransport.canReuseConnection()用于判断该Connection是否可复用</span>
<span class="token comment">// Close the connection if it cannot be reused.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>transport <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>transport<span class="token punctuation">.</span><span class="token function">canReuseConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">closeQuietly</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
  connection <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">Connection</span> result <span class="token operator">=</span> connection<span class="token punctuation">;</span>
connection <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>继续看一下closeQuietly(connection)方法：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
* Closes <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java">closeable</span></span><span class="token punctuation">}</span>, ignoring any checked exceptions. Does nothing
* if <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java">closeable</span></span><span class="token punctuation">}</span> is null.
*/</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">closeQuietly</span><span class="token punctuation">(</span><span class="token class-name">Closeable</span> closeable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>closeable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里也就是Connection的close()方法</span>
    closeable<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> rethrown<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> rethrown<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再接着看一下Connection.close()方法：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token comment">// 直接调用了socket.close()方法。这些socket也关了。</span>
socket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再看Socket.close()方法：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>squareup<span class="token punctuation">.</span>okhttp</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * Closes the socket. It is not possible to reconnect or rebind to this
 * socket thereafter which means a new socket instance has to be created.
 *
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">IOException</span></span>
 *             if an error occurs while closing the socket.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    isClosed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    isConnected <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// RI compatibility: the RI returns the any address (but the original local port) after</span>
    <span class="token comment">// close.</span>
    localAddress <span class="token operator">=</span> <span class="token class-name">Inet4Address</span><span class="token punctuation">.</span>ANY<span class="token punctuation">;</span>
    impl<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>到这里就都看完了，最后我们再看一下上面用到的连接池，也就是<code>ConnectionPool</code>类: 因为在上面的分析中，我们发现此类贯穿了很多类。 它为<code>OkHttpClient</code>中的对象，后贯穿到<code>HttpEngine</code>、<code>Connection</code>、<code>HttpConnection</code>等。所以要分析下。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Manages reuse of HTTP and SPDY connections for reduced network latency. HTTP
 * requests that share the same <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">com<span class="token punctuation">.</span>squareup<span class="token punctuation">.</span>okhttp<span class="token punctuation">.</span></span><span class="token class-name">Address</span></span><span class="token punctuation">}</span> may share a
 * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">com<span class="token punctuation">.</span>squareup<span class="token punctuation">.</span>okhttp<span class="token punctuation">.</span></span><span class="token class-name">Connection</span></span><span class="token punctuation">}</span>. This class implements the policy of
 * which connections to keep open for future use.
 *
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>The <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token punctuation">#</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span> system-wide default<span class="token punctuation">}</span> uses system properties for
 * tuning parameters:
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
 *     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java">http<span class="token punctuation">.</span>keepAlive</span></span><span class="token punctuation">}</span> true if HTTP and SPDY connections should be
 *         pooled at all. Default is true.
 *     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java">http<span class="token punctuation">.</span>maxConnections</span></span><span class="token punctuation">}</span> maximum number of idle connections to
 *         each to keep in the pool. Default is 5.
 *     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java">http<span class="token punctuation">.</span>keepAliveDuration</span></span><span class="token punctuation">}</span> Time in milliseconds to keep the
 *         connection alive in the pool before closing it. Default is 5 minutes.
 *         This property isn&#39;t used by <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token class-name">HttpURLConnection</span></span></span><span class="token punctuation">}</span>.
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
 *
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>The default instance <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span><span class="token punctuation">&gt;</span></span>doesn&#39;t<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span> adjust its configuration as system
 * properties are changed. This assumes that the applications that set these
 * parameters do so before making HTTP connections, and that this class is
 * initialized lazily.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConnectionPool</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAX_CONNECTIONS_TO_CLEANUP <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> DEFAULT_KEEP_ALIVE_DURATION_MS <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token comment">// 5 min</span>

  <span class="token comment">// 这个就是getDefault方法所返回的默认连接池。</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ConnectionPool</span> systemDefault<span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> keepAlive <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;http.keepAlive&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 存活时间</span>
    <span class="token class-name">String</span> keepAliveDuration <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;http.keepAliveDuration&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 最大空闲连接数</span>
    <span class="token class-name">String</span> maxIdleConnections <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;http.maxConnections&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> keepAliveDurationMs <span class="token operator">=</span> keepAliveDuration <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>keepAliveDuration<span class="token punctuation">)</span>
        <span class="token operator">:</span> DEFAULT_KEEP_ALIVE_DURATION_MS<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>keepAlive <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token function">parseBoolean</span><span class="token punctuation">(</span>keepAlive<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      systemDefault <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionPool</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> keepAliveDurationMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>maxIdleConnections <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      systemDefault <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionPool</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>maxIdleConnections<span class="token punctuation">)</span><span class="token punctuation">,</span> keepAliveDurationMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      systemDefault <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionPool</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> keepAliveDurationMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/** The maximum number of idle connections for each address. */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> maxIdleConnections<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> keepAliveDurationNs<span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Connection</span><span class="token punctuation">&gt;</span></span> connections <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Connection</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 连接的有效性检测是所有连接池都面临的一个通用问题，大部分HTTP服务器为了控制资源开销，并不会永久的维护一个长连接，而是一段时间就会关闭该连接。</span>
  <span class="token comment">// 放回连接池的连接，如果在服务器端已经关闭，客户端是无法检测到这个状态变化而及时的关闭Socket的。这就造成了线程从连接池中获取的连接不一定是有效的。</span>
  <span class="token comment">// 这个问题的一个解决方法就是在每次请求之前检查该连接是否已经存在了过长时间，可能已过期。但是这个方法会使得每次请求都增加额外的开销。</span>
  <span class="token comment">// 所以通过下面的任务来执行清理过期的连接。</span>
  <span class="token doc-comment comment">/** We use a single background thread to cleanup expired connections. */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token number">60L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">threadFactory</span><span class="token punctuation">(</span><span class="token string">&quot;OkHttp ConnectionPool&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Runnable</span> connectionsCleanupRunnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Connection</span><span class="token punctuation">&gt;</span></span> expiredConnections <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Connection</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>MAX_CONNECTIONS_TO_CLEANUP<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> idleConnectionCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">ConnectionPool</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ListIterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Connection</span><span class="token punctuation">&gt;</span></span> i <span class="token operator">=</span> connections<span class="token punctuation">.</span><span class="token function">listIterator</span><span class="token punctuation">(</span>connections<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            i<span class="token punctuation">.</span><span class="token function">hasPrevious</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">Connection</span> connection <span class="token operator">=</span> i<span class="token punctuation">.</span><span class="token function">previous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>connection<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> connection<span class="token punctuation">.</span><span class="token function">isExpired</span><span class="token punctuation">(</span>keepAliveDurationNs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            i<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            expiredConnections<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>expiredConnections<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> MAX_CONNECTIONS_TO_CLEANUP<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">isIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            idleConnectionCount<span class="token operator">++</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ListIterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Connection</span><span class="token punctuation">&gt;</span></span> i <span class="token operator">=</span> connections<span class="token punctuation">.</span><span class="token function">listIterator</span><span class="token punctuation">(</span>connections<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            i<span class="token punctuation">.</span><span class="token function">hasPrevious</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> idleConnectionCount <span class="token operator">&gt;</span> maxIdleConnections<span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">Connection</span> connection <span class="token operator">=</span> i<span class="token punctuation">.</span><span class="token function">previous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">isIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            expiredConnections<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
            i<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">--</span>idleConnectionCount<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span> expiredConnection <span class="token operator">:</span> expiredConnections<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>expiredConnection<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">ConnectionPool</span><span class="token punctuation">(</span><span class="token keyword">int</span> maxIdleConnections<span class="token punctuation">,</span> <span class="token keyword">long</span> keepAliveDurationMs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>maxIdleConnections <span class="token operator">=</span> maxIdleConnections<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>keepAliveDurationNs <span class="token operator">=</span> keepAliveDurationMs <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * Returns a snapshot of the connections in this pool, ordered from newest to
   * oldest. Waits for the cleanup callable to run if it is currently scheduled.
   */</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Connection</span><span class="token punctuation">&gt;</span></span> <span class="token function">getConnections</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">waitForCleanupCallableToRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Connection</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>connections<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * Blocks until the executor service has processed all currently enqueued
   * jobs.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">waitForCleanupCallableToRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      executorService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AssertionError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ConnectionPool</span> <span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> systemDefault<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/** Returns total number of connections in the pool. */</span>
  <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">int</span> <span class="token function">getConnectionCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> connections<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/** Returns total number of spdy connections in the pool. */</span>
  <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">int</span> <span class="token function">getSpdyConnectionCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span> connection <span class="token operator">:</span> connections<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">isSpdy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> total<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> total<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/** Returns total number of http connections in the pool. */</span>
  <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">int</span> <span class="token function">getHttpConnectionCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span> connection <span class="token operator">:</span> connections<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>connection<span class="token punctuation">.</span><span class="token function">isSpdy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> total<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> total<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/** Returns a recycled connection to <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java">address</span></span><span class="token punctuation">}</span>, or null if no such connection exists. */</span>
  <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">Connection</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Address</span> address<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Connection</span> foundConnection <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ListIterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Connection</span><span class="token punctuation">&gt;</span></span> i <span class="token operator">=</span> connections<span class="token punctuation">.</span><span class="token function">listIterator</span><span class="token punctuation">(</span>connections<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        i<span class="token punctuation">.</span><span class="token function">hasPrevious</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Connection</span> connection <span class="token operator">=</span> i<span class="token punctuation">.</span><span class="token function">previous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>connection<span class="token punctuation">.</span><span class="token function">getRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span>
          <span class="token operator">||</span> <span class="token operator">!</span>connection<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token operator">||</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> connection<span class="token punctuation">.</span><span class="token function">getIdleStartTimeNs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> keepAliveDurationNs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      i<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>connection<span class="token punctuation">.</span><span class="token function">isSpdy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token comment">// 不是spdy连接</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
		  <span class="token comment">// Platforml类对当前Android平台做了适配。</span>
          <span class="token class-name">Platform</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tagSocket</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">getSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SocketException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// When unable to tag, skip recycling and close</span>
          <span class="token class-name">Platform</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logW</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to tagSocket(): &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
	  <span class="token comment">// 找到可复用的Connection</span>
      foundConnection <span class="token operator">=</span> connection<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">// 针对spdy连接，添加到连接池中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>foundConnection <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> foundConnection<span class="token punctuation">.</span><span class="token function">isSpdy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      connections<span class="token punctuation">.</span><span class="token function">addFirst</span><span class="token punctuation">(</span>foundConnection<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Add it back after iteration.</span>
    <span class="token punctuation">}</span>

    executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>connectionsCleanupRunnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> foundConnection<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * Gives <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java">connection</span></span><span class="token punctuation">}</span> to the pool. The pool may store the connection,
   * or close it, as its policy describes.
   *
   * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>It is an error to use <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java">connection</span></span><span class="token punctuation">}</span> after calling this method.
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">recycle</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> connection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">isSpdy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>connection<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token class-name">Platform</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">untagSocket</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">getSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SocketException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// When unable to remove tagging, skip recycling and close.</span>
      <span class="token class-name">Platform</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logW</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to untagSocket(): &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      connections<span class="token punctuation">.</span><span class="token function">addFirst</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
      connection<span class="token punctuation">.</span><span class="token function">incrementRecycleCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      connection<span class="token punctuation">.</span><span class="token function">resetIdleStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>connectionsCleanupRunnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * Shares the SPDY connection with the pool. Callers to this method may
   * continue to use <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java">connection</span></span><span class="token punctuation">}</span>.
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">share</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> connection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>connection<span class="token punctuation">.</span><span class="token function">isSpdy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>connectionsCleanupRunnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        connections<span class="token punctuation">.</span><span class="token function">addFirst</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/** Close and remove all connections in the pool. */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">evictAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Connection</span><span class="token punctuation">&gt;</span></span> connections<span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      connections <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Connection</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>connections<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>connections<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> size <span class="token operator">=</span> connections<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>connections<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><ul><li>邮箱 ：charon.chui@gmail.com</li><li>Good Luck!</li></ul></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 335891510@qq.com">Jungle68</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/android-note/assets/app.e2a3b496.js" defer></script>
  </body>
</html>
