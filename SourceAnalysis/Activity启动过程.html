<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.47">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>Activity启动过程 | Android Notes</title><meta name="description" content="一个 Android 技术记录文档">
    <link rel="modulepreload" href="/android-note/assets/app.e2a3b496.js"><link rel="modulepreload" href="/android-note/assets/Activity启动过程.html.4cf1fc11.js"><link rel="modulepreload" href="/android-note/assets/Activity启动过程.html.14c41b41.js"><link rel="prefetch" href="/android-note/assets/index.html.fff2aa76.js"><link rel="prefetch" href="/android-note/assets/ART与Dalvik.html.261ddca4.js"><link rel="prefetch" href="/android-note/assets/Android6.0权限系统.html.518850bc.js"><link rel="prefetch" href="/android-note/assets/Android卸载反馈.html.d9910bec.js"><link rel="prefetch" href="/android-note/assets/Android启动模式详解.html.dff63630.js"><link rel="prefetch" href="/android-note/assets/Android开发不申请权限来使用对应功能.html.f29a403a.js"><link rel="prefetch" href="/android-note/assets/Android开发中的MVP模式详解.html.dc69d7fd.js"><link rel="prefetch" href="/android-note/assets/ApplicationId vs PackageName.html.7be45349.js"><link rel="prefetch" href="/android-note/assets/BroadcastReceiver安全问题.html.d78f651d.js"><link rel="prefetch" href="/android-note/assets/Handler导致内存泄露分析.html.a07e9d8a.js"><link rel="prefetch" href="/android-note/assets/Library项目中资源id使用case时报错.html.75fdf471.js"><link rel="prefetch" href="/android-note/assets/Mac下配置adb及Android命令.html.7e81f1f2.js"><link rel="prefetch" href="/android-note/assets/MaterialDesign使用.html.103e5176.js"><link rel="prefetch" href="/android-note/assets/RecyclerView专题.html.6e607fde.js"><link rel="prefetch" href="/android-note/assets/如何让Service常驻内存.html.29df35d8.js"><link rel="prefetch" href="/android-note/assets/屏幕适配之百分比方案详解.html.6014594b.js"><link rel="prefetch" href="/android-note/assets/布局优化.html.2a53d290.js"><link rel="prefetch" href="/android-note/assets/性能优化.html.d19ee784.js"><link rel="prefetch" href="/android-note/assets/注解使用.html.43ec2966.js"><link rel="prefetch" href="/android-note/assets/热修复实现.html.0afb9bec.js"><link rel="prefetch" href="/android-note/assets/通过Hardware Layer提高动画性能.html.7b3bfc5f.js"><link rel="prefetch" href="/android-note/assets/Android Studio你可能不知道的操作.html.b99bf27c.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio中进行ndk开发.html.c8895c23.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio使用教程(第一弹).html.3fdb02c5.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio使用教程(第七弹).html.f0becde3.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio使用教程(第三弹).html.8ca1aed1.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio使用教程(第二弹).html.eb73aa59.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio使用教程(第五弹).html.6799221d.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio使用教程(第六弹).html.9f737361.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio使用教程(第四弹).html.eab7452f.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio提高Build速度.html.82e665f3.js"><link rel="prefetch" href="/android-note/assets/Android应用发布.html.659d7444.js"><link rel="prefetch" href="/android-note/assets/Zipalign优化.html.26e47455.js"><link rel="prefetch" href="/android-note/assets/Android入门介绍.html.cbf93a65.js"><link rel="prefetch" href="/android-note/assets/Android动画.html.7c42765a.js"><link rel="prefetch" href="/android-note/assets/Android四大组件之ContentProvider.html.696ea85d.js"><link rel="prefetch" href="/android-note/assets/Android四大组件之Service.html.ae3ef80a.js"><link rel="prefetch" href="/android-note/assets/Android基础面试题.html.186ba84a.js"><link rel="prefetch" href="/android-note/assets/Android编码规范.html.0a30a4bc.js"><link rel="prefetch" href="/android-note/assets/Ant打包.html.161eb2a1.js"><link rel="prefetch" href="/android-note/assets/Bitmap优化.html.42e7fa9a.js"><link rel="prefetch" href="/android-note/assets/Fragment专题.html.02a55fca.js"><link rel="prefetch" href="/android-note/assets/Home键监听.html.025745a3.js"><link rel="prefetch" href="/android-note/assets/HttpClient执行Get和Post请求.html.9e95d7d7.js"><link rel="prefetch" href="/android-note/assets/JNI_C语言基础.html.1d87d268.js"><link rel="prefetch" href="/android-note/assets/JNI基础.html.3e311c7b.js"><link rel="prefetch" href="/android-note/assets/ListView专题.html.1396114e.js"><link rel="prefetch" href="/android-note/assets/Parcelable及Serializable.html.0b924706.js"><link rel="prefetch" href="/android-note/assets/PopupWindow细节.html.1b6d020f.js"><link rel="prefetch" href="/android-note/assets/SDK Manager无法更新的问题.html.da94471c.js"><link rel="prefetch" href="/android-note/assets/Scroller简介.html.4322b77a.js"><link rel="prefetch" href="/android-note/assets/ScrollingTabs.html.a580533a.js"><link rel="prefetch" href="/android-note/assets/Selector使用.html.0d501025.js"><link rel="prefetch" href="/android-note/assets/SlidingMenu.html.c374045d.js"><link rel="prefetch" href="/android-note/assets/String格式化.html.3691aec0.js"><link rel="prefetch" href="/android-note/assets/TextView跑马灯效果.html.c2883070.js"><link rel="prefetch" href="/android-note/assets/WebView总结.html.bb92c86c.js"><link rel="prefetch" href="/android-note/assets/Widget(窗口小部件).html.05a63ed7.js"><link rel="prefetch" href="/android-note/assets/Wifi状态监听.html.3f42e962.js"><link rel="prefetch" href="/android-note/assets/XmlPullParser.html.3d385a0b.js"><link rel="prefetch" href="/android-note/assets/adb logcat使用简介.html.0b6f4401.js"><link rel="prefetch" href="/android-note/assets/下拉刷新ListView.html.f2310aae.js"><link rel="prefetch" href="/android-note/assets/代码混淆.html.6a7abbed.js"><link rel="prefetch" href="/android-note/assets/任务管理器(ActivityManager).html.8dd2e53f.js"><link rel="prefetch" href="/android-note/assets/修改系统组件样式.html.bf36afb3.js"><link rel="prefetch" href="/android-note/assets/内存泄漏.html.99106e24.js"><link rel="prefetch" href="/android-note/assets/多线程断点下载.html.1f642fe4.js"><link rel="prefetch" href="/android-note/assets/安全退出应用程序.html.75bf928e.js"><link rel="prefetch" href="/android-note/assets/屏幕适配.html.e4ee636e.js"><link rel="prefetch" href="/android-note/assets/应用后台唤醒后数据的刷新.html.7bfa0f27.js"><link rel="prefetch" href="/android-note/assets/应用安装.html.3cd85193.js"><link rel="prefetch" href="/android-note/assets/开发中Log的管理.html.4653eac1.js"><link rel="prefetch" href="/android-note/assets/开发中异常的处理.html.5baf68fb.js"><link rel="prefetch" href="/android-note/assets/快捷方式工具类.html.67f51c74.js"><link rel="prefetch" href="/android-note/assets/手机摇晃.html.46b3e9fe.js"><link rel="prefetch" href="/android-note/assets/搜索框.html.072d0f77.js"><link rel="prefetch" href="/android-note/assets/数据存储.html.64e84f7f.js"><link rel="prefetch" href="/android-note/assets/文件上传.html.6aca8bc8.js"><link rel="prefetch" href="/android-note/assets/来电号码归属地提示框.html.e628cefe.js"><link rel="prefetch" href="/android-note/assets/来电监听及录音.html.d5eb1b47.js"><link rel="prefetch" href="/android-note/assets/横向ListView.html.e063f731.js"><link rel="prefetch" href="/android-note/assets/滑动切换Activity(GestureDetector).html.d48d5aed.js"><link rel="prefetch" href="/android-note/assets/病毒.html.5c217cee.js"><link rel="prefetch" href="/android-note/assets/知识大杂烩.html.31f82ea1.js"><link rel="prefetch" href="/android-note/assets/短信广播接收者.html.ffc29463.js"><link rel="prefetch" href="/android-note/assets/程序的启动、卸载和分享.html.fb6b9fb3.js"><link rel="prefetch" href="/android-note/assets/竖着的Seekbar.html.b0ad1ca1.js"><link rel="prefetch" href="/android-note/assets/自定义Toast.html.24e72ac9.js"><link rel="prefetch" href="/android-note/assets/自定义控件.html.396f8926.js"><link rel="prefetch" href="/android-note/assets/自定义状态栏通知.html.6e7387ea.js"><link rel="prefetch" href="/android-note/assets/自定义背景.html.48ca2361.js"><link rel="prefetch" href="/android-note/assets/获取位置(LocationManager).html.92583f07.js"><link rel="prefetch" href="/android-note/assets/获取应用程序缓存及一键清理.html.b42b2b32.js"><link rel="prefetch" href="/android-note/assets/获取手机中所有安装的程序.html.9735c882.js"><link rel="prefetch" href="/android-note/assets/获取手机及SD卡可用存储空间.html.b7572111.js"><link rel="prefetch" href="/android-note/assets/获取联系人.html.6aeb286a.js"><link rel="prefetch" href="/android-note/assets/读取用户logcat日志.html.4be18e44.js"><link rel="prefetch" href="/android-note/assets/资源文件拷贝的三种方式.html.1b6d8302.js"><link rel="prefetch" href="/android-note/assets/超级管理员(DevicePoliceManager).html.7072c065.js"><link rel="prefetch" href="/android-note/assets/锁屏以及解锁监听.html.28e1d009.js"><link rel="prefetch" href="/android-note/assets/零权限上传数据.html.562e3ff3.js"><link rel="prefetch" href="/android-note/assets/音量及屏幕亮度调节.html.adf99661.js"><link rel="prefetch" href="/android-note/assets/黑名单挂断电话及删除电话记录.html.701b6583.js"><link rel="prefetch" href="/android-note/assets/Gradle专题.html.8e9c74db.js"><link rel="prefetch" href="/android-note/assets/发布library到Maven仓库.html.a390a303.js"><link rel="prefetch" href="/android-note/assets/Glide简介(上).html.9316ab84.js"><link rel="prefetch" href="/android-note/assets/Glide简介(下).html.d24d23a1.js"><link rel="prefetch" href="/android-note/assets/图片加载库比较.html.f8555457.js"><link rel="prefetch" href="/android-note/assets/Base64加密.html.d207af8e.js"><link rel="prefetch" href="/android-note/assets/Git命令.html.a69a3d66.js"><link rel="prefetch" href="/android-note/assets/HashMap实现原理分析.html.48d0886d.js"><link rel="prefetch" href="/android-note/assets/JVM垃圾回收机制.html.5f2d4f42.js"><link rel="prefetch" href="/android-note/assets/Java基础面试题.html.39e89308.js"><link rel="prefetch" href="/android-note/assets/MD5加密.html.9b0ff02d.js"><link rel="prefetch" href="/android-note/assets/MVC与MVP及MVVM.html.f7c14739.js"><link rel="prefetch" href="/android-note/assets/RMB大小写转换.html.3d5cdd7a.js"><link rel="prefetch" href="/android-note/assets/Vim使用教程.html.522bbd31.js"><link rel="prefetch" href="/android-note/assets/hashCode与equals.html.79e59d3a.js"><link rel="prefetch" href="/android-note/assets/volatile和Synchronized区别.html.0c16f110.js"><link rel="prefetch" href="/android-note/assets/剑指Offer(上).html.fe56a9af.js"><link rel="prefetch" href="/android-note/assets/剑指Offer(下).html.d4f1aed1.js"><link rel="prefetch" href="/android-note/assets/单例的最佳实现方式.html.20acb3b8.js"><link rel="prefetch" href="/android-note/assets/单链表.html.bf62db54.js"><link rel="prefetch" href="/android-note/assets/原子性、可见性以及有序性.html.6deb38fc.js"><link rel="prefetch" href="/android-note/assets/常用命令行大全.html.b46be9ac.js"><link rel="prefetch" href="/android-note/assets/强引用、软引用、弱引用、虚引用.html.513c7a20.js"><link rel="prefetch" href="/android-note/assets/数据加密及解密.html.c4c4dcc3.js"><link rel="prefetch" href="/android-note/assets/死锁.html.99ba4a89.js"><link rel="prefetch" href="/android-note/assets/生产者消费者.html.1b7c653d.js"><link rel="prefetch" href="/android-note/assets/算法.html.9d4e0aef.js"><link rel="prefetch" href="/android-note/assets/线程池的原理.html.537ece5d.js"><link rel="prefetch" href="/android-note/assets/网络请求相关内容总结.html.d6be503e.js"><link rel="prefetch" href="/android-note/assets/获取今后多少天后的日期.html.90a2793b.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(一).html.7d77fbc3.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(七).html.b1be9fff.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(三).html.e19fc3f0.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(九).html.605ed319.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(二).html.a5a68958.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(五).html.011717f3.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(八).html.ef802fd5.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(六).html.f1520e1f.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(四).html.3f7548ca.js"><link rel="prefetch" href="/android-note/assets/RxJava系列全家桶.html.766c9e14.js"><link rel="prefetch" href="/android-note/assets/RxJava详解(上).html.e37403f2.js"><link rel="prefetch" href="/android-note/assets/RxJava详解(下).html.86d3c34a.js"><link rel="prefetch" href="/android-note/assets/RxJava详解(中).html.8b7d82ae.js"><link rel="prefetch" href="/android-note/assets/Activity界面绘制过程详解.html.7939bdd8.js"><link rel="prefetch" href="/android-note/assets/Android Touch事件分发详解.html.6e0ecf53.js"><link rel="prefetch" href="/android-note/assets/AsyncTask详解.html.ee42d351.js"><link rel="prefetch" href="/android-note/assets/InstantRun详解.html.50780cae.js"><link rel="prefetch" href="/android-note/assets/ListView源码分析.html.6f55660e.js"><link rel="prefetch" href="/android-note/assets/VideoView源码分析.html.45a2578f.js"><link rel="prefetch" href="/android-note/assets/View绘制过程详解.html.8a6fec11.js"><link rel="prefetch" href="/android-note/assets/butterknife源码详解.html.dc751b15.js"><link rel="prefetch" href="/android-note/assets/自定义View详解.html.3b0d9330.js"><link rel="prefetch" href="/android-note/assets/Android开发工具及类库.html.9e48a859.js"><link rel="prefetch" href="/android-note/assets/Github个人主页绑定域名.html.1c2bdb90.js"><link rel="prefetch" href="/android-note/assets/MAT内存分析.html.967a0203.js"><link rel="prefetch" href="/android-note/assets/Markdown学习手册.html.f37c7aff.js"><link rel="prefetch" href="/android-note/assets/性能优化相关工具.html.49b62c31.js"><link rel="prefetch" href="/android-note/assets/目前流行的开发组合.html.0e2aaf0e.js"><link rel="prefetch" href="/android-note/assets/Android WebRTC简介.html.9fd639b3.js"><link rel="prefetch" href="/android-note/assets/Android音视频开发.html.55bd9526.js"><link rel="prefetch" href="/android-note/assets/DLNA简介.html.2a20a491.js"><link rel="prefetch" href="/android-note/assets/搭建nginx_rtmp服务器.html.f03f6006.js"><link rel="prefetch" href="/android-note/assets/视频播放相关内容总结.html.baa87ac6.js"><link rel="prefetch" href="/android-note/assets/视频解码之软解与硬解.html.d2862232.js"><link rel="prefetch" href="/android-note/assets/音视频基础知识.html.5bef6c29.js"><link rel="prefetch" href="/android-note/assets/HttpURLConnection与HttpClient.html.e75759f0.js"><link rel="prefetch" href="/android-note/assets/HttpURLConnection详解.html.67635b46.js"><link rel="prefetch" href="/android-note/assets/Retrofit详解(上).html.b4b4741f.js"><link rel="prefetch" href="/android-note/assets/Retrofit详解(下).html.84ce4ed4.js"><link rel="prefetch" href="/android-note/assets/Volley源码分析.html.96115c87.js"><link rel="prefetch" href="/android-note/assets/volley-retrofit-okhttp之我们该如何选择网路框架.html.37e80618.js"><link rel="prefetch" href="/android-note/assets/404.html.93146c89.js"><link rel="prefetch" href="/android-note/assets/index.html.a3b2c356.js"><link rel="prefetch" href="/android-note/assets/ART与Dalvik.html.593d518f.js"><link rel="prefetch" href="/android-note/assets/Android6.0权限系统.html.1f126c97.js"><link rel="prefetch" href="/android-note/assets/Android卸载反馈.html.a5ba8c6b.js"><link rel="prefetch" href="/android-note/assets/Android启动模式详解.html.ca8b1ccd.js"><link rel="prefetch" href="/android-note/assets/Android开发不申请权限来使用对应功能.html.d0272eba.js"><link rel="prefetch" href="/android-note/assets/Android开发中的MVP模式详解.html.187c5ed4.js"><link rel="prefetch" href="/android-note/assets/ApplicationId vs PackageName.html.56b02a10.js"><link rel="prefetch" href="/android-note/assets/BroadcastReceiver安全问题.html.64aef548.js"><link rel="prefetch" href="/android-note/assets/Handler导致内存泄露分析.html.164306fd.js"><link rel="prefetch" href="/android-note/assets/Library项目中资源id使用case时报错.html.3f4b1857.js"><link rel="prefetch" href="/android-note/assets/Mac下配置adb及Android命令.html.22df54ee.js"><link rel="prefetch" href="/android-note/assets/MaterialDesign使用.html.649f129f.js"><link rel="prefetch" href="/android-note/assets/RecyclerView专题.html.fa20e530.js"><link rel="prefetch" href="/android-note/assets/如何让Service常驻内存.html.a1a10337.js"><link rel="prefetch" href="/android-note/assets/屏幕适配之百分比方案详解.html.e761907d.js"><link rel="prefetch" href="/android-note/assets/布局优化.html.48720165.js"><link rel="prefetch" href="/android-note/assets/性能优化.html.be35e4a9.js"><link rel="prefetch" href="/android-note/assets/注解使用.html.2ba5a7aa.js"><link rel="prefetch" href="/android-note/assets/热修复实现.html.58919723.js"><link rel="prefetch" href="/android-note/assets/通过Hardware Layer提高动画性能.html.6ddb95e6.js"><link rel="prefetch" href="/android-note/assets/Android Studio你可能不知道的操作.html.fdf20e86.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio中进行ndk开发.html.8e054392.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio使用教程(第一弹).html.414cb35a.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio使用教程(第七弹).html.13675508.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio使用教程(第三弹).html.d6d4b951.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio使用教程(第二弹).html.b98f8285.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio使用教程(第五弹).html.5346a958.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio使用教程(第六弹).html.1b23c403.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio使用教程(第四弹).html.48bf4f17.js"><link rel="prefetch" href="/android-note/assets/AndroidStudio提高Build速度.html.00c828d1.js"><link rel="prefetch" href="/android-note/assets/Android应用发布.html.f1757cb9.js"><link rel="prefetch" href="/android-note/assets/Zipalign优化.html.8521978d.js"><link rel="prefetch" href="/android-note/assets/Android入门介绍.html.b1900bf7.js"><link rel="prefetch" href="/android-note/assets/Android动画.html.b0686769.js"><link rel="prefetch" href="/android-note/assets/Android四大组件之ContentProvider.html.5283befd.js"><link rel="prefetch" href="/android-note/assets/Android四大组件之Service.html.c819f916.js"><link rel="prefetch" href="/android-note/assets/Android基础面试题.html.ff577025.js"><link rel="prefetch" href="/android-note/assets/Android编码规范.html.5636ef45.js"><link rel="prefetch" href="/android-note/assets/Ant打包.html.ef8a6333.js"><link rel="prefetch" href="/android-note/assets/Bitmap优化.html.c749c345.js"><link rel="prefetch" href="/android-note/assets/Fragment专题.html.44210aa0.js"><link rel="prefetch" href="/android-note/assets/Home键监听.html.31cc83ad.js"><link rel="prefetch" href="/android-note/assets/HttpClient执行Get和Post请求.html.9dfecddb.js"><link rel="prefetch" href="/android-note/assets/JNI_C语言基础.html.acf1dc16.js"><link rel="prefetch" href="/android-note/assets/JNI基础.html.b863d19a.js"><link rel="prefetch" href="/android-note/assets/ListView专题.html.ccbe3768.js"><link rel="prefetch" href="/android-note/assets/Parcelable及Serializable.html.d7a77f6f.js"><link rel="prefetch" href="/android-note/assets/PopupWindow细节.html.e345b3a9.js"><link rel="prefetch" href="/android-note/assets/SDK Manager无法更新的问题.html.1c81b7f8.js"><link rel="prefetch" href="/android-note/assets/Scroller简介.html.c35eb2fc.js"><link rel="prefetch" href="/android-note/assets/ScrollingTabs.html.6c7ff613.js"><link rel="prefetch" href="/android-note/assets/Selector使用.html.3ae6b882.js"><link rel="prefetch" href="/android-note/assets/SlidingMenu.html.5ff8b11c.js"><link rel="prefetch" href="/android-note/assets/String格式化.html.8bb54a97.js"><link rel="prefetch" href="/android-note/assets/TextView跑马灯效果.html.a6164902.js"><link rel="prefetch" href="/android-note/assets/WebView总结.html.09ce9c48.js"><link rel="prefetch" href="/android-note/assets/Widget(窗口小部件).html.665dba40.js"><link rel="prefetch" href="/android-note/assets/Wifi状态监听.html.33108888.js"><link rel="prefetch" href="/android-note/assets/XmlPullParser.html.562c0f22.js"><link rel="prefetch" href="/android-note/assets/adb logcat使用简介.html.7e555978.js"><link rel="prefetch" href="/android-note/assets/下拉刷新ListView.html.a5b5dc81.js"><link rel="prefetch" href="/android-note/assets/代码混淆.html.6b1638d3.js"><link rel="prefetch" href="/android-note/assets/任务管理器(ActivityManager).html.2b0db888.js"><link rel="prefetch" href="/android-note/assets/修改系统组件样式.html.3988e4e5.js"><link rel="prefetch" href="/android-note/assets/内存泄漏.html.a958fc42.js"><link rel="prefetch" href="/android-note/assets/多线程断点下载.html.e34bdbe5.js"><link rel="prefetch" href="/android-note/assets/安全退出应用程序.html.6e540a45.js"><link rel="prefetch" href="/android-note/assets/屏幕适配.html.d2d7c9b1.js"><link rel="prefetch" href="/android-note/assets/应用后台唤醒后数据的刷新.html.674d0b48.js"><link rel="prefetch" href="/android-note/assets/应用安装.html.b6ce9885.js"><link rel="prefetch" href="/android-note/assets/开发中Log的管理.html.f406015e.js"><link rel="prefetch" href="/android-note/assets/开发中异常的处理.html.e717f114.js"><link rel="prefetch" href="/android-note/assets/快捷方式工具类.html.f9420718.js"><link rel="prefetch" href="/android-note/assets/手机摇晃.html.04da3193.js"><link rel="prefetch" href="/android-note/assets/搜索框.html.12db7ee7.js"><link rel="prefetch" href="/android-note/assets/数据存储.html.b25bda0f.js"><link rel="prefetch" href="/android-note/assets/文件上传.html.9e008ea8.js"><link rel="prefetch" href="/android-note/assets/来电号码归属地提示框.html.f34946bf.js"><link rel="prefetch" href="/android-note/assets/来电监听及录音.html.91e7515b.js"><link rel="prefetch" href="/android-note/assets/横向ListView.html.927862c8.js"><link rel="prefetch" href="/android-note/assets/滑动切换Activity(GestureDetector).html.89709d55.js"><link rel="prefetch" href="/android-note/assets/病毒.html.dfdf570b.js"><link rel="prefetch" href="/android-note/assets/知识大杂烩.html.08bb7427.js"><link rel="prefetch" href="/android-note/assets/短信广播接收者.html.0ae81f02.js"><link rel="prefetch" href="/android-note/assets/程序的启动、卸载和分享.html.d3bf5ba6.js"><link rel="prefetch" href="/android-note/assets/竖着的Seekbar.html.958ad9fd.js"><link rel="prefetch" href="/android-note/assets/自定义Toast.html.3d0fcc1c.js"><link rel="prefetch" href="/android-note/assets/自定义控件.html.091df93c.js"><link rel="prefetch" href="/android-note/assets/自定义状态栏通知.html.cb73d038.js"><link rel="prefetch" href="/android-note/assets/自定义背景.html.76947534.js"><link rel="prefetch" href="/android-note/assets/获取位置(LocationManager).html.e776dd24.js"><link rel="prefetch" href="/android-note/assets/获取应用程序缓存及一键清理.html.8c46b7ff.js"><link rel="prefetch" href="/android-note/assets/获取手机中所有安装的程序.html.b9ca8c91.js"><link rel="prefetch" href="/android-note/assets/获取手机及SD卡可用存储空间.html.7b085d61.js"><link rel="prefetch" href="/android-note/assets/获取联系人.html.a597a6b0.js"><link rel="prefetch" href="/android-note/assets/读取用户logcat日志.html.152b4577.js"><link rel="prefetch" href="/android-note/assets/资源文件拷贝的三种方式.html.bbe32974.js"><link rel="prefetch" href="/android-note/assets/超级管理员(DevicePoliceManager).html.82c852a9.js"><link rel="prefetch" href="/android-note/assets/锁屏以及解锁监听.html.4d107d95.js"><link rel="prefetch" href="/android-note/assets/零权限上传数据.html.53598b60.js"><link rel="prefetch" href="/android-note/assets/音量及屏幕亮度调节.html.235979e1.js"><link rel="prefetch" href="/android-note/assets/黑名单挂断电话及删除电话记录.html.c14f1fd9.js"><link rel="prefetch" href="/android-note/assets/Gradle专题.html.79c074c0.js"><link rel="prefetch" href="/android-note/assets/发布library到Maven仓库.html.1e80f727.js"><link rel="prefetch" href="/android-note/assets/Glide简介(上).html.46ff5834.js"><link rel="prefetch" href="/android-note/assets/Glide简介(下).html.4f649ea3.js"><link rel="prefetch" href="/android-note/assets/图片加载库比较.html.1afb41c6.js"><link rel="prefetch" href="/android-note/assets/Base64加密.html.77fd44d2.js"><link rel="prefetch" href="/android-note/assets/Git命令.html.f67e6cf2.js"><link rel="prefetch" href="/android-note/assets/HashMap实现原理分析.html.87e02d9e.js"><link rel="prefetch" href="/android-note/assets/JVM垃圾回收机制.html.dcfdc432.js"><link rel="prefetch" href="/android-note/assets/Java基础面试题.html.924476e1.js"><link rel="prefetch" href="/android-note/assets/MD5加密.html.043d41ed.js"><link rel="prefetch" href="/android-note/assets/MVC与MVP及MVVM.html.56507109.js"><link rel="prefetch" href="/android-note/assets/RMB大小写转换.html.9b64eb77.js"><link rel="prefetch" href="/android-note/assets/Vim使用教程.html.7ea26885.js"><link rel="prefetch" href="/android-note/assets/hashCode与equals.html.182d318a.js"><link rel="prefetch" href="/android-note/assets/volatile和Synchronized区别.html.73b388a2.js"><link rel="prefetch" href="/android-note/assets/剑指Offer(上).html.08ed1a50.js"><link rel="prefetch" href="/android-note/assets/剑指Offer(下).html.02faa77d.js"><link rel="prefetch" href="/android-note/assets/单例的最佳实现方式.html.ff9f67fa.js"><link rel="prefetch" href="/android-note/assets/单链表.html.816ccbf3.js"><link rel="prefetch" href="/android-note/assets/原子性、可见性以及有序性.html.81be9d3a.js"><link rel="prefetch" href="/android-note/assets/常用命令行大全.html.5979ef3a.js"><link rel="prefetch" href="/android-note/assets/强引用、软引用、弱引用、虚引用.html.d3a34d4d.js"><link rel="prefetch" href="/android-note/assets/数据加密及解密.html.f871bc28.js"><link rel="prefetch" href="/android-note/assets/死锁.html.05fcf641.js"><link rel="prefetch" href="/android-note/assets/生产者消费者.html.124be265.js"><link rel="prefetch" href="/android-note/assets/算法.html.a5d32479.js"><link rel="prefetch" href="/android-note/assets/线程池的原理.html.0447b400.js"><link rel="prefetch" href="/android-note/assets/网络请求相关内容总结.html.23d92421.js"><link rel="prefetch" href="/android-note/assets/获取今后多少天后的日期.html.1f70a7af.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(一).html.0aca5205.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(七).html.c64ac1eb.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(三).html.259d5746.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(九).html.2d7e84b0.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(二).html.f80d0190.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(五).html.cb3b0dd9.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(八).html.5eba2fc6.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(六).html.f95797de.js"><link rel="prefetch" href="/android-note/assets/Kotlin学习教程(四).html.af807638.js"><link rel="prefetch" href="/android-note/assets/RxJava系列全家桶.html.af237da0.js"><link rel="prefetch" href="/android-note/assets/RxJava详解(上).html.c7354991.js"><link rel="prefetch" href="/android-note/assets/RxJava详解(下).html.2c386862.js"><link rel="prefetch" href="/android-note/assets/RxJava详解(中).html.502b69b2.js"><link rel="prefetch" href="/android-note/assets/Activity界面绘制过程详解.html.0d0ec937.js"><link rel="prefetch" href="/android-note/assets/Android Touch事件分发详解.html.1a5daf97.js"><link rel="prefetch" href="/android-note/assets/AsyncTask详解.html.49cca9fa.js"><link rel="prefetch" href="/android-note/assets/InstantRun详解.html.6bf6b961.js"><link rel="prefetch" href="/android-note/assets/ListView源码分析.html.957f7aff.js"><link rel="prefetch" href="/android-note/assets/VideoView源码分析.html.8e6935a4.js"><link rel="prefetch" href="/android-note/assets/View绘制过程详解.html.db0f2341.js"><link rel="prefetch" href="/android-note/assets/butterknife源码详解.html.28394ba6.js"><link rel="prefetch" href="/android-note/assets/自定义View详解.html.e37f15c5.js"><link rel="prefetch" href="/android-note/assets/Android开发工具及类库.html.4900e197.js"><link rel="prefetch" href="/android-note/assets/Github个人主页绑定域名.html.d17a443e.js"><link rel="prefetch" href="/android-note/assets/MAT内存分析.html.6d4b95b6.js"><link rel="prefetch" href="/android-note/assets/Markdown学习手册.html.7617b5a1.js"><link rel="prefetch" href="/android-note/assets/性能优化相关工具.html.ebe8409a.js"><link rel="prefetch" href="/android-note/assets/目前流行的开发组合.html.d8336de6.js"><link rel="prefetch" href="/android-note/assets/Android WebRTC简介.html.51987a1b.js"><link rel="prefetch" href="/android-note/assets/Android音视频开发.html.4040429e.js"><link rel="prefetch" href="/android-note/assets/DLNA简介.html.fc34230c.js"><link rel="prefetch" href="/android-note/assets/搭建nginx_rtmp服务器.html.8310dbe0.js"><link rel="prefetch" href="/android-note/assets/视频播放相关内容总结.html.a609e06b.js"><link rel="prefetch" href="/android-note/assets/视频解码之软解与硬解.html.92fc9cbb.js"><link rel="prefetch" href="/android-note/assets/音视频基础知识.html.6f0bcff8.js"><link rel="prefetch" href="/android-note/assets/HttpURLConnection与HttpClient.html.3d8a0779.js"><link rel="prefetch" href="/android-note/assets/HttpURLConnection详解.html.88c6186b.js"><link rel="prefetch" href="/android-note/assets/Retrofit详解(上).html.2513ea33.js"><link rel="prefetch" href="/android-note/assets/Retrofit详解(下).html.d0778e46.js"><link rel="prefetch" href="/android-note/assets/Volley源码分析.html.bfc12cf1.js"><link rel="prefetch" href="/android-note/assets/volley-retrofit-okhttp之我们该如何选择网路框架.html.45995d69.js"><link rel="prefetch" href="/android-note/assets/404.html.bf6755d7.js"><link rel="prefetch" href="/android-note/assets/404.0f84ac09.js"><link rel="prefetch" href="/android-note/assets/Layout.c5c30828.js">
    <link rel="stylesheet" href="/android-note/assets/style.1f7fd01d.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/android-note/" class=""><!----><span class="site-name">Android Notes</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><!----><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><!----><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">Activity启动过程 <!----></p><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="activity启动过程" tabindex="-1"><a class="header-anchor" href="#activity启动过程" aria-hidden="true">#</a> Activity启动过程</h1><p>前两天面试了天猫的开发，被问到了<code>Activity</code>启动过程，不懂啊.... 今天就来分析一下，我们开启<code>Activity</code>主要有两种方式:</p><ul><li>通过桌面图标启动，桌面就是<code>Launcher</code>其实他也是一个应用程序，他也是继承<code>Activity</code>。</li><li>在程序内部调用<code>startActivity()</code>开启。</li></ul><p>而<code>Launcher</code>点击图标其实也是调用了<code>Activity</code>的<code>startActivity()</code>方法，所以我们就从<code>startActivity()</code>方法入手了。<br> 首先看一下<code>Activity</code>类中的<code>startActivity()</code>方法:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">startActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>继续看<code>startActivity(intent, null)</code>:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Launch a new activity.  You will not receive any information about when
 * the activity exits.  This implementation overrides the base version,
 * providing information about
 * the activity performing the launch.  Because of this additional
 * information, the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Intent</span><span class="token punctuation">#</span><span class="token field">FLAG_ACTIVITY_NEW_TASK</span></span><span class="token punctuation">}</span> launch flag is not
 * required; if not specified, the new activity will be added to the
 * task of the caller.
 *
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>This method throws <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">ActivityNotFoundException</span></span><span class="token punctuation">}</span>
 * if there was no Activity found to run the given Intent.
 *
 * <span class="token keyword">@param</span> <span class="token parameter">intent</span> The intent to start.
 * <span class="token keyword">@param</span> <span class="token parameter">options</span> Additional options for how the Activity should be started.
 * See <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">Context</span><span class="token punctuation">#</span><span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">,</span> <span class="token class-name">Bundle</span><span class="token punctuation">)</span></span>
 * Context.startActivity(Intent, Bundle)<span class="token punctuation">}</span> for more details.
 *
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">ActivityNotFoundException</span></span>
 *
 * <span class="token keyword">@see</span> <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token punctuation">#</span><span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
 * <span class="token keyword">@see</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">startActivityForResult</span></span>
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">startActivityForResult</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">// Note we want to go through this call for compatibility with</span>
		<span class="token comment">// applications that may have overridden the method.</span>
		<span class="token function">startActivityForResult</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接下来会调用<code>startActivityForResult()</code>方法(注释也很重要啊，里面也说明了singleTask启动模式时该方法不会走到回调中):</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Launch an activity for which you would like a result when it finished.
 * When this activity exits, your
 * onActivityResult() method will be called with the given requestCode.
 * Using a negative requestCode is the same as calling
 * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">startActivity</span></span><span class="token punctuation">}</span> (the activity is not launched as a sub-activity).
 *
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Note that this method should only be used with Intent protocols
 * that are defined to return a result.  In other protocols (such as
 * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Intent</span><span class="token punctuation">#</span><span class="token field">ACTION_MAIN</span></span><span class="token punctuation">}</span> or <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Intent</span><span class="token punctuation">#</span><span class="token field">ACTION_VIEW</span></span><span class="token punctuation">}</span>), you may
 * not get the result when you expect.  For example, if the activity you
 * are launching uses the singleTask launch mode, it will not run in your
 * task and thus you will immediately receive a cancel result.
 *
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>As a special case, if you call startActivityForResult() with a requestCode
 * &gt;= 0 during the initial onCreate(Bundle savedInstanceState)/onResume() of your
 * activity, then your window will not be displayed until a result is
 * returned back from the started activity.  This is to avoid visible
 * flickering when redirecting to another activity.
 *
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>This method throws <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">ActivityNotFoundException</span></span><span class="token punctuation">}</span>
 * if there was no Activity found to run the given Intent.
 *
 * <span class="token keyword">@param</span> <span class="token parameter">intent</span> The intent to start.
 * <span class="token keyword">@param</span> <span class="token parameter">requestCode</span> If &gt;= 0, this code will be returned in
 *                    onActivityResult() when the activity exits.
 * <span class="token keyword">@param</span> <span class="token parameter">options</span> Additional options for how the Activity should be started.
 * See <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">Context</span><span class="token punctuation">#</span><span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">,</span> <span class="token class-name">Bundle</span><span class="token punctuation">)</span></span>
 * Context.startActivity(Intent, Bundle)<span class="token punctuation">}</span> for more details.
 *
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">ActivityNotFoundException</span></span>
 *
 * <span class="token keyword">@see</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">startActivity</span></span>
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startActivityForResult</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// mParent也是Activity类，通过名字就能看明白了。</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mParent <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 开始了啊</span>
		<span class="token class-name">Instrumentation<span class="token punctuation">.</span>ActivityResult</span> ar <span class="token operator">=</span>
			mInstrumentation<span class="token punctuation">.</span><span class="token function">execStartActivity</span><span class="token punctuation">(</span>
				<span class="token keyword">this</span><span class="token punctuation">,</span> mMainThread<span class="token punctuation">.</span><span class="token function">getApplicationThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mToken<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
				intent<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ar <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			mMainThread<span class="token punctuation">.</span><span class="token function">sendActivityResult</span><span class="token punctuation">(</span>
				mToken<span class="token punctuation">,</span> mEmbeddedID<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> ar<span class="token punctuation">.</span><span class="token function">getResultCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				ar<span class="token punctuation">.</span><span class="token function">getResultData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>requestCode <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// If this start is requesting a result, we can avoid making</span>
			<span class="token comment">// the activity visible until the result is received.  Setting</span>
			<span class="token comment">// this code during onCreate(Bundle savedInstanceState) or onResume() will keep the</span>
			<span class="token comment">// activity hidden during this time, to avoid flickering.</span>
			<span class="token comment">// This can only be done when a result is requested because</span>
			<span class="token comment">// that guarantees we will get information back when the</span>
			<span class="token comment">// activity is finished, no matter what happens to it.</span>
			mStartedActivity <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token function">cancelInputsAndStartExitTransition</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// TODO Consider clearing/flushing other event sources and events for child windows.</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			mParent<span class="token punctuation">.</span><span class="token function">startActivityFromChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token comment">// Note we want to go through this method for compatibility with</span>
			<span class="token comment">// existing applications that may have overridden it.</span>
			mParent<span class="token punctuation">.</span><span class="token function">startActivityFromChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span> requestCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>里面调用了<code>mInstrumentation.execStartActivity</code>这是啥玩意，先看一下<code>mInstrumentation</code>属性，他是<code>Instrumentation</code>类，我们看下文档</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Base class for implementing application instrumentation code.  When running
 * with instrumentation turned on, this class will be instantiated for you
 * before any of the application code, allowing you to monitor all of the
 * interaction the system has with the application.  An Instrumentation
 * implementation is described to the system through an AndroidManifest.xml&#39;s
 * <span class="token entity named-entity" title="&lt;">&amp;lt;</span>instrumentation<span class="token entity named-entity" title="&gt;">&amp;gt;</span> tag.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Instrumentation</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>放狗查了下<code>Instrumentation</code>的意思是仪器、工具、装置的意思。我就大体翻一下(英语不好- -~，可能不准确)该类是实现应用程序代码的基类，当该类在 启动的状态下运行时，该类会在其他任何应用程序运行前进行初始化，允许你件事所有应用程序与系统的交互。一个<code>Instrumentation</code>实例会通过<code>Manifest</code>文件 中的<code>&lt;instrumenttation</code>标签描述给系统。<br> 所以继续看一下<code>mInstrumentation.execStartActivity()</code>:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
   // 下面的注释说的很明白了默认实现会更新任何活跃的对象并分发给系统的`activity manager`
 * Execute a startActivity call made by the application.  The default 
 * implementation takes care of updating any active <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ActivityMonitor</span></span><span class="token punctuation">}</span>
 * objects and dispatches this call to the system activity manager; you can
 * override this to watch for the application to start an activity, and 
 * modify what happens when it does. 
 *
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>This method returns an <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ActivityResult</span></span><span class="token punctuation">}</span> object, which you can 
 * use when intercepting application calls to avoid performing the start 
 * activity action but still return the result the application is 
 * expecting.  To do this, override this method to catch the call to start 
 * activity so that it returns a new ActivityResult containing the results 
 * you would like the application to see, and don&#39;t call up to the super 
 * class.  Note that an application is only expecting a result if 
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>var</span><span class="token punctuation">&gt;</span></span>requestCode<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>var</span><span class="token punctuation">&gt;</span></span> is <span class="token entity named-entity" title="&gt;">&amp;gt;</span>= 0.
 *
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>This method throws <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">ActivityNotFoundException</span></span><span class="token punctuation">}</span>
 * if there was no Activity found to run the given Intent.
 *
 * <span class="token keyword">@param</span> <span class="token parameter">who</span> The Context from which the activity is being started.
 * <span class="token keyword">@param</span> <span class="token parameter">contextThread</span> The main thread of the Context from which the activity
 *                      is being started.
 * <span class="token keyword">@param</span> <span class="token parameter">token</span> Internal token identifying to the system who is starting 
 *              the activity; may be null.
 * <span class="token keyword">@param</span> <span class="token parameter">target</span> Which activity is performing the start (and thus receiving 
 *               any result); may be null if this call is not being made
 *               from an activity.
 * <span class="token keyword">@param</span> <span class="token parameter">intent</span> The actual Intent to start.
 * <span class="token keyword">@param</span> <span class="token parameter">requestCode</span> Identifier for this request&#39;s result; less than zero 
 *                    if the caller is not expecting a result.
 * <span class="token keyword">@param</span> <span class="token parameter">options</span> Addition options.
 *
 * <span class="token keyword">@return</span> To force the return of a particular result, return an 
 *         ActivityResult object containing the desired data; otherwise
 *         return null.  The default implementation always returns null.
 *
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">ActivityNotFoundException</span></span>
 *
 * <span class="token keyword">@see</span> <span class="token reference"><span class="token class-name">Activity</span><span class="token punctuation">#</span><span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">)</span></span>
 * <span class="token keyword">@see</span> <span class="token reference"><span class="token class-name">Activity</span><span class="token punctuation">#</span><span class="token function">startActivityForResult</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span></span>
 * <span class="token keyword">@see</span> <span class="token reference"><span class="token class-name">Activity</span><span class="token punctuation">#</span><span class="token field">startActivityFromChild</span></span>
 *
 * <span class="token punctuation">{</span><span class="token keyword">@hide</span><span class="token punctuation">}</span>
 */</span>
<span class="token keyword">public</span> <span class="token class-name">ActivityResult</span> <span class="token function">execStartActivity</span><span class="token punctuation">(</span>
		<span class="token class-name">Context</span> who<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> contextThread<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> token<span class="token punctuation">,</span> <span class="token class-name">Activity</span> target<span class="token punctuation">,</span>
		<span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">IApplicationThread</span> whoThread <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span><span class="token punctuation">)</span> contextThread<span class="token punctuation">;</span>
	<span class="token class-name">Uri</span> referrer <span class="token operator">=</span> target <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> target<span class="token punctuation">.</span><span class="token function">onProvideReferrer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>referrer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		intent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>EXTRA_REFERRER<span class="token punctuation">,</span> referrer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mActivityMonitors <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mSync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token class-name">N</span> <span class="token operator">=</span> mActivityMonitors<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token class-name">N</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">final</span> <span class="token class-name">ActivityMonitor</span> am <span class="token operator">=</span> mActivityMonitors<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>am<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>who<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> intent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					am<span class="token punctuation">.</span>mHits<span class="token operator">++</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>am<span class="token punctuation">.</span><span class="token function">isBlocking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token keyword">return</span> requestCode <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">?</span> am<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		intent<span class="token punctuation">.</span><span class="token function">migrateExtraStreamToClipData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		intent<span class="token punctuation">.</span><span class="token function">prepareToLeaveProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 通过注释然后再结合代码一看我们就知道这应该就是分发到系统activity manager的过程</span>
		<span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token class-name">ActivityManagerNative</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">startActivity</span><span class="token punctuation">(</span>whoThread<span class="token punctuation">,</span> who<span class="token punctuation">.</span><span class="token function">getBasePackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span>
					intent<span class="token punctuation">.</span><span class="token function">resolveTypeIfNeeded</span><span class="token punctuation">(</span>who<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					token<span class="token punctuation">,</span> target <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> target<span class="token punctuation">.</span>mEmbeddedID <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
					requestCode<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">checkStartActivityResult</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Failure from system&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>那就直接看下<code>ActivityManagerNative.getDefault().startActivity()</code>方法，看之前我们先看看<code>ActivityManagerNative.getDefault()</code>是什么鬼:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Retrieve the system&#39;s default/global activity manager.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">public</span> <span class="token class-name">IActivityManager</span> <span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> gDefault<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注释说的明白的就是拿到系统默认/全局的<code>activity manager</code>，通过名字也能看出来<code>IActivityManager</code>是个接口，那就继续看<code>IActivityManager.startActivity()</code>方法吧:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span> <span class="token class-name">String</span> callingPackage<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span>
            <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> resultTo<span class="token punctuation">,</span> <span class="token class-name">String</span> resultWho<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span>
            <span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里就顺便看一下<code>IActivityManager</code>接口是神马鬼：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>/**
 * System private API for talking with the activity manager service.  This
 * provides calls from the application back to the activity manager.
 *
 * {@hide}
 */
public interface IActivityManager extends IInterface {
	...
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>但是看到这里我不知道怎么继续往下分析了啊，既然是接口我们要找到实现类啊，又是通过<code>ActivityManagerNative.getDefault()</code>得到的<code>IActivityManager</code>实例， 所以这里我们再看下<code>ActivityManagerNative</code>类。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/** <span class="token punctuation">{</span><span class="token keyword">@hide</span><span class="token punctuation">}</span> */</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ActivityManagerNative</span> <span class="token keyword">extends</span> <span class="token class-name">Binder</span> <span class="token keyword">implements</span> <span class="token class-name">IActivityManager</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>啊！ 隐藏的，连个注释也没有，我拖动了下这个类一看<code>5992</code>行，不知道从哪下手了，还能从哪下手啊，当然是从<code>ActivityManagerNative.getDefault()</code>方法啊</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ActivityManagerNative</span> <span class="token keyword">extends</span> <span class="token class-name">Binder</span> <span class="token keyword">implements</span> <span class="token class-name">IActivityManager</span> <span class="token punctuation">{</span>

	<span class="token comment">// 继承Binder接口，而且asInterFace方法，我好想明白了点什么</span>
    <span class="token doc-comment comment">/**
     * Cast a Binder object into an activity manager interface, generating
     * a proxy if needed.
     */</span>
    <span class="token keyword">static</span> <span class="token keyword">public</span> <span class="token class-name">IActivityManager</span> <span class="token function">asInterface</span><span class="token punctuation">(</span><span class="token class-name">IBinder</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">IActivityManager</span> in <span class="token operator">=</span>
            <span class="token punctuation">(</span><span class="token class-name">IActivityManager</span><span class="token punctuation">)</span>obj<span class="token punctuation">.</span><span class="token function">queryLocalInterface</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>in <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> in<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ActivityManagerProxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * Retrieve the system&#39;s default/global activity manager.
     */</span>
    <span class="token keyword">static</span> <span class="token keyword">public</span> <span class="token class-name">IActivityManager</span> <span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 使用了getDefaule的get方法</span>
        <span class="token keyword">return</span> gDefault<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>	
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>继续看：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Singleton</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IActivityManager</span><span class="token punctuation">&gt;</span></span> gDefault <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IActivityManager</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">protected</span> <span class="token class-name">IActivityManager</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token comment">// 进程间通信了</span>
		<span class="token class-name">IBinder</span> b <span class="token operator">=</span> <span class="token class-name">ServiceManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token string">&quot;activity&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token string">&quot;ActivityManager&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;default service binder = &quot;</span> <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 看到了吗？用到了刚才我们说的asInterface方法</span>
		<span class="token class-name">IActivityManager</span> am <span class="token operator">=</span> <span class="token function">asInterface</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token string">&quot;ActivityManager&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;default service = &quot;</span> <span class="token operator">+</span> am<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> am<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>好了，我们再看下<code>asInterface()</code>方法:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">public</span> <span class="token class-name">IActivityManager</span> <span class="token function">asInterface</span><span class="token punctuation">(</span><span class="token class-name">IBinder</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token class-name">IActivityManager</span> in <span class="token operator">=</span>
		<span class="token punctuation">(</span><span class="token class-name">IActivityManager</span><span class="token punctuation">)</span>obj<span class="token punctuation">.</span><span class="token function">queryLocalInterface</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>in <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> in<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 在这里</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ActivityManagerProxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>终于找到了其实就是<code>ActivityManagerProxy</code>类，刚才我们找到<code>IActivityManager</code>接口的<code>startActivity()</code> 方法，现在终于找到了在这里使用的是<code>IActivityManager</code>接口实现类的 <code>ActivityManagerProxy</code>类，我们来看一下该类实现的<code>startActivity()</code>方法:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">ActivityManagerProxy</span> <span class="token keyword">implements</span> <span class="token class-name">IActivityManager</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">ActivityManagerProxy</span><span class="token punctuation">(</span><span class="token class-name">IBinder</span> remote<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        mRemote <span class="token operator">=</span> remote<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">IBinder</span> <span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> mRemote<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span> <span class="token class-name">String</span> callingPackage<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span>
			<span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> resultTo<span class="token punctuation">,</span> <span class="token class-name">String</span> resultWho<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span>
			<span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> <span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{</span>
		<span class="token class-name">Parcel</span> data <span class="token operator">=</span> <span class="token class-name">Parcel</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Parcel</span> reply <span class="token operator">=</span> <span class="token class-name">Parcel</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeInterfaceToken</span><span class="token punctuation">(</span><span class="token class-name">IActivityManager</span><span class="token punctuation">.</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeStrongBinder</span><span class="token punctuation">(</span>caller <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> caller<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>callingPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
		intent<span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>resolvedType<span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeStrongBinder</span><span class="token punctuation">(</span>resultTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>resultWho<span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>startFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>profilerInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			data<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			profilerInfo<span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token class-name">Parcelable</span><span class="token punctuation">.</span>PARCELABLE_WRITE_RETURN_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			data<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			data<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			options<span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			data<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		mRemote<span class="token punctuation">.</span><span class="token function">transact</span><span class="token punctuation">(</span>START_ACTIVITY_TRANSACTION<span class="token punctuation">,</span> data<span class="token punctuation">,</span> reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		reply<span class="token punctuation">.</span><span class="token function">readException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> result <span class="token operator">=</span> reply<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		reply<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> result<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>	
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再继续我就不知道走到哪里了.... 这一块其实是用了<code>Binder</code>机制，上面的<code>IActivityManager.getDefault()</code>方法返回的是<code>ActivityManagerService</code>的远程接口，所以接下来 我们应该看一下<code>ActivityManagerService.startActivity()</code>类。(具体<code>Binder</code>机制我们后续会专门写一篇文章，这里就不说了，不然就说不完了)</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span> <span class="token class-name">String</span> callingPackage<span class="token punctuation">,</span>
		<span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> resultTo<span class="token punctuation">,</span> <span class="token class-name">String</span> resultWho<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span>
		<span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> <span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">startActivityAsUser</span><span class="token punctuation">(</span>caller<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> resultTo<span class="token punctuation">,</span>
		resultWho<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span> profilerInfo<span class="token punctuation">,</span> options<span class="token punctuation">,</span>
		<span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">getCallingUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>继续看下<code>startActivityAsUser()</code>方法:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">startActivityAsUser</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span> <span class="token class-name">String</span> callingPackage<span class="token punctuation">,</span>
		<span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> resultTo<span class="token punctuation">,</span> <span class="token class-name">String</span> resultWho<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span>
		<span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> <span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">enforceNotIsolatedCaller</span><span class="token punctuation">(</span><span class="token string">&quot;startActivity&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	userId <span class="token operator">=</span> <span class="token function">handleIncomingUser</span><span class="token punctuation">(</span><span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span>
			<span class="token boolean">false</span><span class="token punctuation">,</span> ALLOW_FULL_ONLY<span class="token punctuation">,</span> <span class="token string">&quot;startActivity&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// TODO: Switch to user app stacks here.</span>
	<span class="token keyword">return</span> mStackSupervisor<span class="token punctuation">.</span><span class="token function">startActivityMayWait</span><span class="token punctuation">(</span>caller<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span> intent<span class="token punctuation">,</span>
			resolvedType<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> resultTo<span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span>
			profilerInfo<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>继续看一下<code>mStackSupervisor.startActivityMayWait()</code>方法,这里<code>mStackSupervisor</code>是<code>ActivityStackSupervisor</code>类:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">startActivityMayWait</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span> <span class="token keyword">int</span> callingUid<span class="token punctuation">,</span>
		<span class="token class-name">String</span> callingPackage<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span>
		<span class="token class-name">IVoiceInteractionSession</span> voiceSession<span class="token punctuation">,</span> <span class="token class-name">IVoiceInteractor</span> voiceInteractor<span class="token punctuation">,</span>
		<span class="token class-name">IBinder</span> resultTo<span class="token punctuation">,</span> <span class="token class-name">String</span> resultWho<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span>
		<span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">,</span> <span class="token class-name">WaitResult</span> outResult<span class="token punctuation">,</span> <span class="token class-name">Configuration</span> config<span class="token punctuation">,</span>
		<span class="token class-name">Bundle</span> options<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ignoreTargetSecurity<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">,</span>
		<span class="token class-name">IActivityContainer</span> iContainer<span class="token punctuation">,</span> <span class="token class-name">TaskRecord</span> inTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Refuse possible leaked file descriptors</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>intent <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> intent<span class="token punctuation">.</span><span class="token function">hasFileDescriptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;File descriptors passed in Intent&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">boolean</span> componentSpecified <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

	<span class="token comment">// Don&#39;t modify the client&#39;s object!</span>
	intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 解析出要开启的Activity的信息，包名、类名、参数等。</span>
	<span class="token comment">// Collect information about the target of the Intent.</span>
	<span class="token class-name">ActivityInfo</span> aInfo <span class="token operator">=</span>
			<span class="token function">resolveActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span> profilerInfo<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token class-name">ActivityContainer</span> container <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ActivityContainer</span><span class="token punctuation">)</span>iContainer<span class="token punctuation">;</span>
	<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>container <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> container<span class="token punctuation">.</span>mParentActivity <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
				container<span class="token punctuation">.</span>mParentActivity<span class="token punctuation">.</span>state <span class="token operator">!=</span> RESUMED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// Cannot start a child activity if the parent is not resumed.</span>
			<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_CANCELED<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">final</span> <span class="token keyword">int</span> realCallingPid <span class="token operator">=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">final</span> <span class="token keyword">int</span> realCallingUid <span class="token operator">=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> callingPid<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>callingUid <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			callingPid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>caller <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			callingPid <span class="token operator">=</span> realCallingPid<span class="token punctuation">;</span>
			callingUid <span class="token operator">=</span> realCallingUid<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			callingPid <span class="token operator">=</span> callingUid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">final</span> <span class="token class-name">ActivityStack</span> stack<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>container <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> container<span class="token punctuation">.</span>mStack<span class="token punctuation">.</span><span class="token function">isOnHomeDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			stack <span class="token operator">=</span> mFocusedStack<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			stack <span class="token operator">=</span> container<span class="token punctuation">.</span>mStack<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		stack<span class="token punctuation">.</span>mConfigWillChange <span class="token operator">=</span> config <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mService<span class="token punctuation">.</span>mConfiguration<span class="token punctuation">.</span><span class="token function">diff</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_CONFIGURATION<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_CONFIGURATION<span class="token punctuation">,</span>
				<span class="token string">&quot;Starting activity when config will change = &quot;</span> <span class="token operator">+</span> stack<span class="token punctuation">.</span>mConfigWillChange<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">final</span> <span class="token keyword">long</span> origId <span class="token operator">=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>aInfo <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
				<span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>privateFlags
						<span class="token operator">&amp;</span><span class="token class-name">ApplicationInfo</span><span class="token punctuation">.</span>PRIVATE_FLAG_CANT_SAVE_STATE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// This may be a heavy-weight process!  Check to see if we already</span>
			<span class="token comment">// have another, different heavy-weight process running.</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>processName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mHeavyWeightProcess <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
						<span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mHeavyWeightProcess<span class="token punctuation">.</span>info<span class="token punctuation">.</span>uid <span class="token operator">!=</span> aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid <span class="token operator">||</span>
						<span class="token operator">!</span>mService<span class="token punctuation">.</span>mHeavyWeightProcess<span class="token punctuation">.</span>processName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">int</span> appCallingUid <span class="token operator">=</span> callingUid<span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>caller <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token class-name">ProcessRecord</span> callerApp <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getRecordForAppLocked</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>callerApp <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							appCallingUid <span class="token operator">=</span> callerApp<span class="token punctuation">.</span>info<span class="token punctuation">.</span>uid<span class="token punctuation">;</span>
						<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
							<span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Unable to find app for caller &quot;</span> <span class="token operator">+</span> caller
								  <span class="token operator">+</span> <span class="token string">&quot; (pid=&quot;</span> <span class="token operator">+</span> callingPid <span class="token operator">+</span> <span class="token string">&quot;) when starting: &quot;</span>
								  <span class="token operator">+</span> intent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token class-name">ActivityOptions</span><span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_PERMISSION_DENIED<span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>

					<span class="token class-name">IIntentSender</span> target <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getIntentSenderLocked</span><span class="token punctuation">(</span>
							<span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>INTENT_SENDER_ACTIVITY<span class="token punctuation">,</span> <span class="token string">&quot;android&quot;</span><span class="token punctuation">,</span>
							appCallingUid<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> intent <span class="token punctuation">}</span><span class="token punctuation">,</span>
							<span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> resolvedType <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">PendingIntent</span><span class="token punctuation">.</span>FLAG_CANCEL_CURRENT
							<span class="token operator">|</span> <span class="token class-name">PendingIntent</span><span class="token punctuation">.</span>FLAG_ONE_SHOT<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token class-name">Intent</span> newIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>requestCode <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token comment">// Caller is requesting a result.</span>
						newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span><span class="token class-name">HeavyWeightSwitcherActivity</span><span class="token punctuation">.</span>KEY_HAS_RESULT<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span><span class="token class-name">HeavyWeightSwitcherActivity</span><span class="token punctuation">.</span>KEY_INTENT<span class="token punctuation">,</span>
							<span class="token keyword">new</span> <span class="token class-name">IntentSender</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mHeavyWeightProcess<span class="token punctuation">.</span>activities<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token class-name">ActivityRecord</span> hist <span class="token operator">=</span> mService<span class="token punctuation">.</span>mHeavyWeightProcess<span class="token punctuation">.</span>activities<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span><span class="token class-name">HeavyWeightSwitcherActivity</span><span class="token punctuation">.</span>KEY_CUR_APP<span class="token punctuation">,</span>
								hist<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
						newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span><span class="token class-name">HeavyWeightSwitcherActivity</span><span class="token punctuation">.</span>KEY_CUR_TASK<span class="token punctuation">,</span>
								hist<span class="token punctuation">.</span>task<span class="token punctuation">.</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span><span class="token class-name">HeavyWeightSwitcherActivity</span><span class="token punctuation">.</span>KEY_NEW_APP<span class="token punctuation">,</span>
							aInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
					newIntent<span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					newIntent<span class="token punctuation">.</span><span class="token function">setClassName</span><span class="token punctuation">(</span><span class="token string">&quot;android&quot;</span><span class="token punctuation">,</span>
							<span class="token class-name">HeavyWeightSwitcherActivity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					intent <span class="token operator">=</span> newIntent<span class="token punctuation">;</span>
					resolvedType <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
					caller <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
					callingUid <span class="token operator">=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					callingPid <span class="token operator">=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					componentSpecified <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
					<span class="token keyword">try</span> <span class="token punctuation">{</span>
						<span class="token class-name">ResolveInfo</span> rInfo <span class="token operator">=</span>
							<span class="token class-name">AppGlobals</span><span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resolveIntent</span><span class="token punctuation">(</span>
									intent<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
									<span class="token class-name">PackageManager</span><span class="token punctuation">.</span>MATCH_DEFAULT_ONLY
									<span class="token operator">|</span> <span class="token class-name">ActivityManagerService</span><span class="token punctuation">.</span>STOCK_PM_FLAGS<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
						aInfo <span class="token operator">=</span> rInfo <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> rInfo<span class="token punctuation">.</span>activityInfo <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
						aInfo <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getActivityInfoForUser</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						aInfo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 根据上面解析的内容去开启了。。。</span>
		<span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">startActivityLocked</span><span class="token punctuation">(</span>caller<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> aInfo<span class="token punctuation">,</span>
				voiceSession<span class="token punctuation">,</span> voiceInteractor<span class="token punctuation">,</span> resultTo<span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span>
				requestCode<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span>
				realCallingPid<span class="token punctuation">,</span> realCallingUid<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span> options<span class="token punctuation">,</span> ignoreTargetSecurity<span class="token punctuation">,</span>
				componentSpecified<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> container<span class="token punctuation">,</span> inTask<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>origId<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>stack<span class="token punctuation">.</span>mConfigWillChange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// If the caller also wants to switch to a new configuration,</span>
			<span class="token comment">// do so now.  This allows a clean switch, as we are waiting</span>
			<span class="token comment">// for the current activity to pause (so we will not destroy</span>
			<span class="token comment">// it), and have not yet started the next activity.</span>
			mService<span class="token punctuation">.</span><span class="token function">enforceCallingPermission</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span></span>Manifest</span><span class="token punctuation">.</span>permission<span class="token punctuation">.</span>CHANGE_CONFIGURATION<span class="token punctuation">,</span>
					<span class="token string">&quot;updateConfiguration()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			stack<span class="token punctuation">.</span>mConfigWillChange <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_CONFIGURATION<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_CONFIGURATION<span class="token punctuation">,</span>
					<span class="token string">&quot;Updating to new configuration after starting activity.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			mService<span class="token punctuation">.</span><span class="token function">updateConfigurationLocked</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>outResult <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			outResult<span class="token punctuation">.</span>result <span class="token operator">=</span> res<span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				mWaitingActivityLaunched<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>outResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">do</span> <span class="token punctuation">{</span>
					<span class="token keyword">try</span> <span class="token punctuation">{</span>
						mService<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>outResult<span class="token punctuation">.</span>timeout <span class="token operator">&amp;&amp;</span> outResult<span class="token punctuation">.</span>who <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_TASK_TO_FRONT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">ActivityRecord</span> r <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">topRunningActivityLocked</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>nowVisible <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>state <span class="token operator">==</span> RESUMED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					outResult<span class="token punctuation">.</span>timeout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
					outResult<span class="token punctuation">.</span>who <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
					outResult<span class="token punctuation">.</span>totalTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
					outResult<span class="token punctuation">.</span>thisTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					outResult<span class="token punctuation">.</span>thisTime <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					mWaitingActivityVisible<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>outResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">do</span> <span class="token punctuation">{</span>
						<span class="token keyword">try</span> <span class="token punctuation">{</span>
							mService<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>outResult<span class="token punctuation">.</span>timeout <span class="token operator">&amp;&amp;</span> outResult<span class="token punctuation">.</span>who <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">return</span> res<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>那就继续看一下<code>startActivityLocked()</code>方法:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">startActivityLocked</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span>
		<span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span> <span class="token class-name">ActivityInfo</span> aInfo<span class="token punctuation">,</span>
		<span class="token class-name">IVoiceInteractionSession</span> voiceSession<span class="token punctuation">,</span> <span class="token class-name">IVoiceInteractor</span> voiceInteractor<span class="token punctuation">,</span>
		<span class="token class-name">IBinder</span> resultTo<span class="token punctuation">,</span> <span class="token class-name">String</span> resultWho<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span>
		<span class="token keyword">int</span> callingPid<span class="token punctuation">,</span> <span class="token keyword">int</span> callingUid<span class="token punctuation">,</span> <span class="token class-name">String</span> callingPackage<span class="token punctuation">,</span>
		<span class="token keyword">int</span> realCallingPid<span class="token punctuation">,</span> <span class="token keyword">int</span> realCallingUid<span class="token punctuation">,</span> <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">,</span>
		<span class="token keyword">boolean</span> ignoreTargetSecurity<span class="token punctuation">,</span> <span class="token keyword">boolean</span> componentSpecified<span class="token punctuation">,</span> <span class="token class-name">ActivityRecord</span><span class="token punctuation">[</span><span class="token punctuation">]</span> outActivity<span class="token punctuation">,</span>
		<span class="token class-name">ActivityContainer</span> container<span class="token punctuation">,</span> <span class="token class-name">TaskRecord</span> inTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_SUCCESS<span class="token punctuation">;</span>

	<span class="token class-name">ProcessRecord</span> callerApp <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>caller <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// mService就是ActivityManagerService类</span>
		callerApp <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getRecordForAppLocked</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>callerApp <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			callingPid <span class="token operator">=</span> callerApp<span class="token punctuation">.</span>pid<span class="token punctuation">;</span>
			callingUid <span class="token operator">=</span> callerApp<span class="token punctuation">.</span>info<span class="token punctuation">.</span>uid<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Unable to find app for caller &quot;</span> <span class="token operator">+</span> caller
				  <span class="token operator">+</span> <span class="token string">&quot; (pid=&quot;</span> <span class="token operator">+</span> callingPid <span class="token operator">+</span> <span class="token string">&quot;) when starting: &quot;</span>
				  <span class="token operator">+</span> intent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			err <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_PERMISSION_DENIED<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">final</span> <span class="token keyword">int</span> userId <span class="token operator">=</span> aInfo <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;START u&quot;</span> <span class="token operator">+</span> userId <span class="token operator">+</span> <span class="token string">&quot; {&quot;</span> <span class="token operator">+</span> intent<span class="token punctuation">.</span><span class="token function">toShortString</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
				<span class="token operator">+</span> <span class="token string">&quot;} from uid &quot;</span> <span class="token operator">+</span> callingUid
				<span class="token operator">+</span> <span class="token string">&quot; on display &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>container <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token punctuation">(</span>mFocusedStack <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span>
						<span class="token class-name">Display</span><span class="token punctuation">.</span>DEFAULT_DISPLAY <span class="token operator">:</span> mFocusedStack<span class="token punctuation">.</span>mDisplayId<span class="token punctuation">)</span> <span class="token operator">:</span>
						<span class="token punctuation">(</span>container<span class="token punctuation">.</span>mActivityDisplay <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">Display</span><span class="token punctuation">.</span>DEFAULT_DISPLAY <span class="token operator">:</span>
								container<span class="token punctuation">.</span>mActivityDisplay<span class="token punctuation">.</span>mDisplayId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token class-name">ActivityRecord</span> sourceRecord <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token class-name">ActivityRecord</span> resultRecord <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>resultTo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		sourceRecord <span class="token operator">=</span> <span class="token function">isInAnyStackLocked</span><span class="token punctuation">(</span>resultTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_RESULTS<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_RESULTS<span class="token punctuation">,</span>
				<span class="token string">&quot;Will send result to &quot;</span> <span class="token operator">+</span> resultTo <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> sourceRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>sourceRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>requestCode <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>sourceRecord<span class="token punctuation">.</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				resultRecord <span class="token operator">=</span> sourceRecord<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">final</span> <span class="token keyword">int</span> launchFlags <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>launchFlags <span class="token operator">&amp;</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_FORWARD_RESULT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> sourceRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// Transfer the result target from the source activity to the new</span>
		<span class="token comment">// one being started, including any failures.</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>requestCode <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">ActivityOptions</span><span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_FORWARD_AND_REQUEST_CONFLICT<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		resultRecord <span class="token operator">=</span> sourceRecord<span class="token punctuation">.</span>resultTo<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>resultRecord <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>resultRecord<span class="token punctuation">.</span><span class="token function">isInStackLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			resultRecord <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		resultWho <span class="token operator">=</span> sourceRecord<span class="token punctuation">.</span>resultWho<span class="token punctuation">;</span>
		requestCode <span class="token operator">=</span> sourceRecord<span class="token punctuation">.</span>requestCode<span class="token punctuation">;</span>
		sourceRecord<span class="token punctuation">.</span>resultTo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>resultRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			resultRecord<span class="token punctuation">.</span><span class="token function">removeResultsLocked</span><span class="token punctuation">(</span>sourceRecord<span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span> requestCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>sourceRecord<span class="token punctuation">.</span>launchedFromUid <span class="token operator">==</span> callingUid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// The new activity is being launched from the same uid as the previous</span>
			<span class="token comment">// activity in the flow, and asking to forward its result back to the</span>
			<span class="token comment">// previous.  In this case the activity is serving as a trampoline between</span>
			<span class="token comment">// the two, so we also want to update its launchedFromPackage to be the</span>
			<span class="token comment">// same as the previous activity.  Note that this is safe, since we know</span>
			<span class="token comment">// these two packages come from the same uid; the caller could just as</span>
			<span class="token comment">// well have supplied that same package name itself.  This specifially</span>
			<span class="token comment">// deals with the case of an intent picker/chooser being launched in the app</span>
			<span class="token comment">// flow to redirect to an activity picked by the user, where we want the final</span>
			<span class="token comment">// activity to consider it to have been launched by the previous app activity.</span>
			callingPackage <span class="token operator">=</span> sourceRecord<span class="token punctuation">.</span>launchedFromPackage<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_SUCCESS <span class="token operator">&amp;&amp;</span> intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// We couldn&#39;t find a class that can handle the given Intent.</span>
		<span class="token comment">// That&#39;s the end of that!</span>
		err <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_INTENT_NOT_RESOLVED<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_SUCCESS <span class="token operator">&amp;&amp;</span> aInfo <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// We couldn&#39;t find the specific class specified in the Intent.</span>
		<span class="token comment">// Also the end of the line.</span>
		err <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_CLASS_NOT_FOUND<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_SUCCESS
			<span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isCurrentProfileLocked</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span>
			<span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> FLAG_SHOW_FOR_ALL_USERS<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// Trying to launch a background activity that doesn&#39;t show for all users.</span>
		err <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_NOT_CURRENT_USER_ACTIVITY<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_SUCCESS <span class="token operator">&amp;&amp;</span> sourceRecord <span class="token operator">!=</span> <span class="token keyword">null</span>
			<span class="token operator">&amp;&amp;</span> sourceRecord<span class="token punctuation">.</span>task<span class="token punctuation">.</span>voiceSession <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// If this activity is being launched as part of a voice session, we need</span>
		<span class="token comment">// to ensure that it is safe to do so.  If the upcoming activity will also</span>
		<span class="token comment">// be part of the voice session, we can only launch it if it has explicitly</span>
		<span class="token comment">// said it supports the VOICE category, or it is a part of the calling app.</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>launchFlags <span class="token operator">&amp;</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_NEW_TASK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
				<span class="token operator">&amp;&amp;</span> sourceRecord<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid <span class="token operator">!=</span> aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">try</span> <span class="token punctuation">{</span>
				intent<span class="token punctuation">.</span><span class="token function">addCategory</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>CATEGORY_VOICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">AppGlobals</span><span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">activitySupportsIntent</span><span class="token punctuation">(</span>
						intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span>
							<span class="token string">&quot;Activity being started in current voice task does not support voice: &quot;</span>
							<span class="token operator">+</span> intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
					err <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_NOT_VOICE_COMPATIBLE<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Failure checking voice capabilities&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
				err <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_NOT_VOICE_COMPATIBLE<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_SUCCESS <span class="token operator">&amp;&amp;</span> voiceSession <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// If the caller is starting a new voice session, just make sure the target</span>
		<span class="token comment">// is actually allowing it to run this way.</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">AppGlobals</span><span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">activitySupportsIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span>
						<span class="token string">&quot;Activity being started in new voice task does not support: &quot;</span>
						<span class="token operator">+</span> intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
				err <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_NOT_VOICE_COMPATIBLE<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Failure checking voice capabilities&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
			err <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_NOT_VOICE_COMPATIBLE<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Activity栈</span>
	<span class="token keyword">final</span> <span class="token class-name">ActivityStack</span> resultStack <span class="token operator">=</span> resultRecord <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> resultRecord<span class="token punctuation">.</span>task<span class="token punctuation">.</span>stack<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>resultRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			resultStack<span class="token punctuation">.</span><span class="token function">sendActivityResultLocked</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
				resultRecord<span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span>
				<span class="token class-name">Activity</span><span class="token punctuation">.</span>RESULT_CANCELED<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token class-name">ActivityOptions</span><span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> err<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">boolean</span> abort <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

	<span class="token keyword">final</span> <span class="token keyword">int</span> startAnyPerm <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">checkPermission</span><span class="token punctuation">(</span>
			START_ANY_ACTIVITY<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>startAnyPerm <span class="token operator">!=</span> PERMISSION_GRANTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">final</span> <span class="token keyword">int</span> componentRestriction <span class="token operator">=</span> <span class="token function">getComponentRestrictionForCallingPackage</span><span class="token punctuation">(</span>
				aInfo<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> ignoreTargetSecurity<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">final</span> <span class="token keyword">int</span> actionRestriction <span class="token operator">=</span> <span class="token function">getActionRestrictionForCallingPackage</span><span class="token punctuation">(</span>
				intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>componentRestriction <span class="token operator">==</span> ACTIVITY_RESTRICTION_PERMISSION
				<span class="token operator">||</span> actionRestriction <span class="token operator">==</span> ACTIVITY_RESTRICTION_PERMISSION<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>resultRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				resultStack<span class="token punctuation">.</span><span class="token function">sendActivityResultLocked</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
						resultRecord<span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span>
						<span class="token class-name">Activity</span><span class="token punctuation">.</span>RESULT_CANCELED<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token class-name">String</span> msg<span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>actionRestriction <span class="token operator">==</span> ACTIVITY_RESTRICTION_PERMISSION<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				msg <span class="token operator">=</span> <span class="token string">&quot;Permission Denial: starting &quot;</span> <span class="token operator">+</span> intent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
						<span class="token operator">+</span> <span class="token string">&quot; from &quot;</span> <span class="token operator">+</span> callerApp <span class="token operator">+</span> <span class="token string">&quot; (pid=&quot;</span> <span class="token operator">+</span> callingPid
						<span class="token operator">+</span> <span class="token string">&quot;, uid=&quot;</span> <span class="token operator">+</span> callingUid <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span> <span class="token operator">+</span> <span class="token string">&quot; with revoked permission &quot;</span>
						<span class="token operator">+</span> ACTION_TO_RUNTIME_PERMISSION<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>aInfo<span class="token punctuation">.</span>exported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				msg <span class="token operator">=</span> <span class="token string">&quot;Permission Denial: starting &quot;</span> <span class="token operator">+</span> intent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
						<span class="token operator">+</span> <span class="token string">&quot; from &quot;</span> <span class="token operator">+</span> callerApp <span class="token operator">+</span> <span class="token string">&quot; (pid=&quot;</span> <span class="token operator">+</span> callingPid
						<span class="token operator">+</span> <span class="token string">&quot;, uid=&quot;</span> <span class="token operator">+</span> callingUid <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span>
						<span class="token operator">+</span> <span class="token string">&quot; not exported from uid &quot;</span> <span class="token operator">+</span> aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				msg <span class="token operator">=</span> <span class="token string">&quot;Permission Denial: starting &quot;</span> <span class="token operator">+</span> intent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
						<span class="token operator">+</span> <span class="token string">&quot; from &quot;</span> <span class="token operator">+</span> callerApp <span class="token operator">+</span> <span class="token string">&quot; (pid=&quot;</span> <span class="token operator">+</span> callingPid
						<span class="token operator">+</span> <span class="token string">&quot;, uid=&quot;</span> <span class="token operator">+</span> callingUid <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span>
						<span class="token operator">+</span> <span class="token string">&quot; requires &quot;</span> <span class="token operator">+</span> aInfo<span class="token punctuation">.</span>permission<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>actionRestriction <span class="token operator">==</span> ACTIVITY_RESTRICTION_APPOP<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">&quot;Appop Denial: starting &quot;</span> <span class="token operator">+</span> intent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					<span class="token operator">+</span> <span class="token string">&quot; from &quot;</span> <span class="token operator">+</span> callerApp <span class="token operator">+</span> <span class="token string">&quot; (pid=&quot;</span> <span class="token operator">+</span> callingPid
					<span class="token operator">+</span> <span class="token string">&quot;, uid=&quot;</span> <span class="token operator">+</span> callingUid <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span>
					<span class="token operator">+</span> <span class="token string">&quot; requires &quot;</span> <span class="token operator">+</span> <span class="token class-name">AppOpsManager</span><span class="token punctuation">.</span><span class="token function">permissionToOp</span><span class="token punctuation">(</span>
							ACTION_TO_RUNTIME_PERMISSION<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
			abort <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>componentRestriction <span class="token operator">==</span> ACTIVITY_RESTRICTION_APPOP<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">&quot;Appop Denial: starting &quot;</span> <span class="token operator">+</span> intent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					<span class="token operator">+</span> <span class="token string">&quot; from &quot;</span> <span class="token operator">+</span> callerApp <span class="token operator">+</span> <span class="token string">&quot; (pid=&quot;</span> <span class="token operator">+</span> callingPid
					<span class="token operator">+</span> <span class="token string">&quot;, uid=&quot;</span> <span class="token operator">+</span> callingUid <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span>
					<span class="token operator">+</span> <span class="token string">&quot; requires appop &quot;</span> <span class="token operator">+</span> <span class="token class-name">AppOpsManager</span><span class="token punctuation">.</span><span class="token function">permissionToOp</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>permission<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
			abort <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	abort <span class="token operator">|=</span> <span class="token operator">!</span>mService<span class="token punctuation">.</span>mIntentFirewall<span class="token punctuation">.</span><span class="token function">checkStartActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span>
			callingPid<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mController <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token comment">// The Intent we give to the watcher has the extra data</span>
			<span class="token comment">// stripped off, since it can contain private information.</span>
			<span class="token class-name">Intent</span> watchIntent <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">cloneFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			abort <span class="token operator">|=</span> <span class="token operator">!</span>mService<span class="token punctuation">.</span>mController<span class="token punctuation">.</span><span class="token function">activityStarting</span><span class="token punctuation">(</span>watchIntent<span class="token punctuation">,</span>
					aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			mService<span class="token punctuation">.</span>mController <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>abort<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>resultRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			resultStack<span class="token punctuation">.</span><span class="token function">sendActivityResultLocked</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> resultRecord<span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span>
					<span class="token class-name">Activity</span><span class="token punctuation">.</span>RESULT_CANCELED<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// We pretend to the caller that it was really started, but</span>
		<span class="token comment">// they will just get a cancel result.</span>
		<span class="token class-name">ActivityOptions</span><span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_SUCCESS<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// ActivityRecord: An entry in the history stack, representing an activity.</span>
	<span class="token class-name">ActivityRecord</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityRecord</span><span class="token punctuation">(</span>mService<span class="token punctuation">,</span> callerApp<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span>
			intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> aInfo<span class="token punctuation">,</span> mService<span class="token punctuation">.</span>mConfiguration<span class="token punctuation">,</span> resultRecord<span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span>
			requestCode<span class="token punctuation">,</span> componentSpecified<span class="token punctuation">,</span> voiceSession <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> container<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>outActivity <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		outActivity<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> r<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>appTimeTracker <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> sourceRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// If the caller didn&#39;t specify an explicit time tracker, we want to continue</span>
		<span class="token comment">// tracking under any it has.</span>
		r<span class="token punctuation">.</span>appTimeTracker <span class="token operator">=</span> sourceRecord<span class="token punctuation">.</span>appTimeTracker<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">final</span> <span class="token class-name">ActivityStack</span> stack <span class="token operator">=</span> mFocusedStack<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>voiceSession <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>stack<span class="token punctuation">.</span>mResumedActivity <span class="token operator">==</span> <span class="token keyword">null</span>
			<span class="token operator">||</span> stack<span class="token punctuation">.</span>mResumedActivity<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid <span class="token operator">!=</span> callingUid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mService<span class="token punctuation">.</span><span class="token function">checkAppSwitchAllowedLocked</span><span class="token punctuation">(</span>callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span>
				realCallingPid<span class="token punctuation">,</span> realCallingUid<span class="token punctuation">,</span> <span class="token string">&quot;Activity start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">PendingActivityLaunch</span> pal <span class="token operator">=</span>
					<span class="token keyword">new</span> <span class="token class-name">PendingActivityLaunch</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> sourceRecord<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span> stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
			mPendingActivityLaunches<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pal<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">ActivityOptions</span><span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_SWITCHES_CANCELED<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mDidAppSwitch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// This is the second allowed switch since we stopped switches,</span>
		<span class="token comment">// so now just generally allow switches.  Use case: user presses</span>
		<span class="token comment">// home (switches disabled, switch to home, mDidAppSwitch now true);</span>
		<span class="token comment">// user taps a home icon (coming from home so allowed, we hit here</span>
		<span class="token comment">// and now allow anyone to switch again).</span>
		mService<span class="token punctuation">.</span>mAppSwitchesAllowedTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		mService<span class="token punctuation">.</span>mDidAppSwitch <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">doPendingActivityLaunchesLocked</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 继续调用方法</span>
	err <span class="token operator">=</span> <span class="token function">startActivityUncheckedLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> sourceRecord<span class="token punctuation">,</span> voiceSession<span class="token punctuation">,</span> voiceInteractor<span class="token punctuation">,</span>
			startFlags<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> options<span class="token punctuation">,</span> inTask<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// If someone asked to have the keyguard dismissed on the next</span>
		<span class="token comment">// activity start, but we are not actually doing an activity</span>
		<span class="token comment">// switch...  just dismiss the keyguard now, because we</span>
		<span class="token comment">// probably want to see whatever is behind it.</span>
		<span class="token function">notifyActivityDrawnForKeyguard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再继续看<code>startActivityUncheckedLocked</code>方法：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">startActivityUncheckedLocked</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> r<span class="token punctuation">,</span> <span class="token class-name">ActivityRecord</span> sourceRecord<span class="token punctuation">,</span>
		<span class="token class-name">IVoiceInteractionSession</span> voiceSession<span class="token punctuation">,</span> <span class="token class-name">IVoiceInteractor</span> voiceInteractor<span class="token punctuation">,</span> <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span>
		<span class="token keyword">boolean</span> doResume<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">,</span> <span class="token class-name">TaskRecord</span> inTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">final</span> <span class="token class-name">Intent</span> intent <span class="token operator">=</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">;</span>
	<span class="token keyword">final</span> <span class="token keyword">int</span> callingUid <span class="token operator">=</span> r<span class="token punctuation">.</span>launchedFromUid<span class="token punctuation">;</span>

	<span class="token comment">// In some flows in to this function, we retrieve the task record and hold on to it</span>
	<span class="token comment">// without a lock before calling back in to here...  so the task at this point may</span>
	<span class="token comment">// not actually be in recents.  Check for that, and if it isn&#39;t in recents just</span>
	<span class="token comment">// consider it invalid.</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>inTask <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>inTask<span class="token punctuation">.</span>inRecents<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Starting activity in task not in recents: &quot;</span> <span class="token operator">+</span> inTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
		inTask <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 判断不同的启动模式</span>
	<span class="token keyword">final</span> <span class="token keyword">boolean</span> launchSingleTop <span class="token operator">=</span> r<span class="token punctuation">.</span>launchMode <span class="token operator">==</span> <span class="token class-name">ActivityInfo</span><span class="token punctuation">.</span>LAUNCH_SINGLE_TOP<span class="token punctuation">;</span>
	<span class="token keyword">final</span> <span class="token keyword">boolean</span> launchSingleInstance <span class="token operator">=</span> r<span class="token punctuation">.</span>launchMode <span class="token operator">==</span> <span class="token class-name">ActivityInfo</span><span class="token punctuation">.</span>LAUNCH_SINGLE_INSTANCE<span class="token punctuation">;</span>
	<span class="token keyword">final</span> <span class="token keyword">boolean</span> launchSingleTask <span class="token operator">=</span> r<span class="token punctuation">.</span>launchMode <span class="token operator">==</span> <span class="token class-name">ActivityInfo</span><span class="token punctuation">.</span>LAUNCH_SINGLE_TASK<span class="token punctuation">;</span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token comment">// We may want to try to place the new activity in to an existing task.  We always</span>
	<span class="token comment">// do this if the target activity is singleTask or singleInstance; we will also do</span>
	<span class="token comment">// this if NEW_TASK has been requested, and there is not an additional qualifier telling</span>
	<span class="token comment">// us to still place it in a new task: multi task, always doc mode, or being asked to</span>
	<span class="token comment">// launch this as a new task behind the current one.</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>launchFlags <span class="token operator">&amp;</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_NEW_TASK<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
			<span class="token punctuation">(</span>launchFlags <span class="token operator">&amp;</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_MULTIPLE_TASK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token operator">||</span> launchSingleInstance <span class="token operator">||</span> launchSingleTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// If bring to front is requested, and no result is requested and we have not</span>
		<span class="token comment">// been given an explicit task to launch in to, and</span>
		<span class="token comment">// we can find a task that was started with this same</span>
		<span class="token comment">// component, then instead of launching bring that one to the front.</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>inTask <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>resultTo <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// See if there is a task to bring to the front.  If this is</span>
			<span class="token comment">// a SINGLE_INSTANCE activity, there can be one and only one</span>
			<span class="token comment">// instance of it in the history, and it is always in its own</span>
			<span class="token comment">// unique task, so we do a special search.</span>
			<span class="token class-name">ActivityRecord</span> intentActivity <span class="token operator">=</span> <span class="token operator">!</span>launchSingleInstance <span class="token operator">?</span>
					<span class="token function">findTaskLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">findActivityLocked</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> r<span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>intentActivity <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// When the flags NEW_TASK and CLEAR_TASK are set, then the task gets reused</span>
				<span class="token comment">// but still needs to be a lock task mode violation since the task gets</span>
				<span class="token comment">// cleared out and the device would otherwise leave the locked task.</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLockTaskModeViolation</span><span class="token punctuation">(</span>intentActivity<span class="token punctuation">.</span>task<span class="token punctuation">,</span>
						<span class="token punctuation">(</span>launchFlags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>FLAG_ACTIVITY_NEW_TASK <span class="token operator">|</span> FLAG_ACTIVITY_CLEAR_TASK<span class="token punctuation">)</span><span class="token punctuation">)</span>
						<span class="token operator">==</span> <span class="token punctuation">(</span>FLAG_ACTIVITY_NEW_TASK <span class="token operator">|</span> FLAG_ACTIVITY_CLEAR_TASK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token function">showLockTaskToast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;startActivityUnchecked: Attempt to violate Lock Task Mode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_RETURN_LOCK_TASK_MODE_VIOLATION<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>task <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					r<span class="token punctuation">.</span>task <span class="token operator">=</span> intentActivity<span class="token punctuation">.</span>task<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>intentActivity<span class="token punctuation">.</span>task<span class="token punctuation">.</span>intent <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">// This task was started because of movement of</span>
					<span class="token comment">// the activity based on affinity...  now that we</span>
					<span class="token comment">// are actually launching it, we can assign the</span>
					<span class="token comment">// base intent.</span>
					intentActivity<span class="token punctuation">.</span>task<span class="token punctuation">.</span><span class="token function">setIntent</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				targetStack <span class="token operator">=</span> intentActivity<span class="token punctuation">.</span>task<span class="token punctuation">.</span>stack<span class="token punctuation">;</span>
				targetStack<span class="token punctuation">.</span>mLastPausedActivity <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
				<span class="token comment">// If the target task is not in the front, then we need</span>
				<span class="token comment">// to bring it to the front...  except...  well, with</span>
				<span class="token comment">// SINGLE_TASK_LAUNCH it&#39;s not entirely clear.  We&#39;d like</span>
				<span class="token comment">// to have the same behavior as if a new instance was</span>
				<span class="token comment">// being started, which means not bringing it to the front</span>
				<span class="token comment">// if the caller is not itself in the front.</span>
				<span class="token keyword">final</span> <span class="token class-name">ActivityStack</span> focusStack <span class="token operator">=</span> <span class="token function">getFocusedStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">ActivityRecord</span> curTop <span class="token operator">=</span> <span class="token punctuation">(</span>focusStack <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
						<span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> focusStack<span class="token punctuation">.</span><span class="token function">topRunningNonDelayedActivityLocked</span><span class="token punctuation">(</span>notTop<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">boolean</span> movedToFront <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>curTop <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>curTop<span class="token punctuation">.</span>task <span class="token operator">!=</span> intentActivity<span class="token punctuation">.</span>task <span class="token operator">||</span>
						curTop<span class="token punctuation">.</span>task <span class="token operator">!=</span> focusStack<span class="token punctuation">.</span><span class="token function">topTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_BROUGHT_TO_FRONT<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>sourceRecord <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>sourceStack<span class="token punctuation">.</span><span class="token function">topActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
							sourceStack<span class="token punctuation">.</span><span class="token function">topActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>task <span class="token operator">==</span> sourceRecord<span class="token punctuation">.</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token comment">// We really do want to push this one into the user&#39;s face, right now.</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>launchTaskBehind <span class="token operator">&amp;&amp;</span> sourceRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							intentActivity<span class="token punctuation">.</span><span class="token function">setTaskToAffiliateWith</span><span class="token punctuation">(</span>sourceRecord<span class="token punctuation">.</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						movedHome <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
						targetStack<span class="token punctuation">.</span><span class="token function">moveTaskToFrontLocked</span><span class="token punctuation">(</span>intentActivity<span class="token punctuation">.</span>task<span class="token punctuation">,</span> noAnimation<span class="token punctuation">,</span>
								options<span class="token punctuation">,</span> r<span class="token punctuation">.</span>appTimeTracker<span class="token punctuation">,</span> <span class="token string">&quot;bringingFoundTaskToFront&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						movedToFront <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>launchFlags <span class="token operator">&amp;</span>
								<span class="token punctuation">(</span>FLAG_ACTIVITY_NEW_TASK <span class="token operator">|</span> FLAG_ACTIVITY_TASK_ON_HOME<span class="token punctuation">)</span><span class="token punctuation">)</span>
								<span class="token operator">==</span> <span class="token punctuation">(</span>FLAG_ACTIVITY_NEW_TASK <span class="token operator">|</span> FLAG_ACTIVITY_TASK_ON_HOME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token comment">// Caller wants to appear on home activity.</span>
							intentActivity<span class="token punctuation">.</span>task<span class="token punctuation">.</span><span class="token function">setTaskToReturnTo</span><span class="token punctuation">(</span>HOME_ACTIVITY_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						options <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>movedToFront<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_TASKS<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG_TASKS<span class="token punctuation">,</span> <span class="token string">&quot;Bring to front target: &quot;</span> <span class="token operator">+</span> targetStack
							<span class="token operator">+</span> <span class="token string">&quot; from &quot;</span> <span class="token operator">+</span> intentActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
					targetStack<span class="token punctuation">.</span><span class="token function">moveToFront</span><span class="token punctuation">(</span><span class="token string">&quot;intentActivityFound&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				<span class="token comment">// If the caller has requested that the target task be</span>
				<span class="token comment">// reset, then do so.</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>launchFlags<span class="token operator">&amp;</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_RESET_TASK_IF_NEEDED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					intentActivity <span class="token operator">=</span> targetStack<span class="token punctuation">.</span><span class="token function">resetTaskIfNeededLocked</span><span class="token punctuation">(</span>intentActivity<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>startFlags <span class="token operator">&amp;</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_FLAG_ONLY_IF_NEEDED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">// We don&#39;t need to start a new activity, and</span>
					<span class="token comment">// the client said not to do anything if that</span>
					<span class="token comment">// is the case, so this is it!  And for paranoia, make</span>
					<span class="token comment">// sure we have correctly resumed the top activity.</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>doResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token function">resumeTopActivitiesLocked</span><span class="token punctuation">(</span>targetStack<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>

						<span class="token comment">// Make sure to notify Keyguard as well if we are not running an app</span>
						<span class="token comment">// transition later.</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>movedToFront<span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token function">notifyActivityDrawnForKeyguard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
						<span class="token class-name">ActivityOptions</span><span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_RETURN_INTENT_TO_CALLER<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>launchFlags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>FLAG_ACTIVITY_NEW_TASK <span class="token operator">|</span> FLAG_ACTIVITY_CLEAR_TASK<span class="token punctuation">)</span><span class="token punctuation">)</span>
						<span class="token operator">==</span> <span class="token punctuation">(</span>FLAG_ACTIVITY_NEW_TASK <span class="token operator">|</span> FLAG_ACTIVITY_CLEAR_TASK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">// The caller has requested to completely replace any</span>
					<span class="token comment">// existing task with its new activity.  Well that should</span>
					<span class="token comment">// not be too hard...</span>
					reuseTask <span class="token operator">=</span> intentActivity<span class="token punctuation">.</span>task<span class="token punctuation">;</span>
					reuseTask<span class="token punctuation">.</span><span class="token function">performClearTaskLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					reuseTask<span class="token punctuation">.</span><span class="token function">setIntent</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>launchFlags <span class="token operator">&amp;</span> FLAG_ACTIVITY_CLEAR_TOP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
						<span class="token operator">||</span> launchSingleInstance <span class="token operator">||</span> launchSingleTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">// In this situation we want to remove all activities</span>
					<span class="token comment">// from the task up to the one being started.  In most</span>
					<span class="token comment">// cases this means we are resetting the task to its</span>
					<span class="token comment">// initial state.</span>
					<span class="token class-name">ActivityRecord</span> top <span class="token operator">=</span>
							intentActivity<span class="token punctuation">.</span>task<span class="token punctuation">.</span><span class="token function">performClearTaskLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> launchFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>top <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>top<span class="token punctuation">.</span>frontOfTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token comment">// Activity aliases may mean we use different</span>
							<span class="token comment">// intents for the top activity, so make sure</span>
							<span class="token comment">// the task now has the identity of the new</span>
							<span class="token comment">// intent.</span>
							top<span class="token punctuation">.</span>task<span class="token punctuation">.</span><span class="token function">setIntent</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						<span class="token class-name">ActivityStack</span><span class="token punctuation">.</span><span class="token function">logStartActivity</span><span class="token punctuation">(</span><span class="token class-name">EventLogTags</span><span class="token punctuation">.</span>AM_NEW_INTENT<span class="token punctuation">,</span>
								r<span class="token punctuation">,</span> top<span class="token punctuation">.</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
						top<span class="token punctuation">.</span><span class="token function">deliverNewIntentLocked</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> r<span class="token punctuation">.</span>launchedFromPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
						<span class="token comment">// A special case: we need to start the activity because it is not</span>
						<span class="token comment">// currently running, and the caller has asked to clear the current</span>
						<span class="token comment">// task to have this activity at the top.</span>
						addingToTask <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
						<span class="token comment">// Now pretend like this activity is being started by the top of its</span>
						<span class="token comment">// task, so it is put in the right place.</span>
						sourceRecord <span class="token operator">=</span> intentActivity<span class="token punctuation">;</span>
						<span class="token class-name">TaskRecord</span> task <span class="token operator">=</span> sourceRecord<span class="token punctuation">.</span>task<span class="token punctuation">;</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> task<span class="token punctuation">.</span>stack <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token comment">// Target stack got cleared when we all activities were removed</span>
							<span class="token comment">// above. Go ahead and reset it.</span>
							targetStack <span class="token operator">=</span> <span class="token function">computeStackFocus</span><span class="token punctuation">(</span>sourceRecord<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* newTask */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							targetStack<span class="token punctuation">.</span><span class="token function">addTask</span><span class="token punctuation">(</span>
									task<span class="token punctuation">,</span> <span class="token operator">!</span>launchTaskBehind <span class="token comment">/* toTop */</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* moving */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>

					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>realActivity<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intentActivity<span class="token punctuation">.</span>task<span class="token punctuation">.</span>realActivity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">// In this case the top activity on the task is the</span>
					<span class="token comment">// same as the one being launched, so we take that</span>
					<span class="token comment">// as a request to bring the task to the foreground.</span>
					<span class="token comment">// If the top activity in the task is the root</span>
					<span class="token comment">// activity, deliver this new intent to it if it</span>
					<span class="token comment">// desires.</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>launchFlags<span class="token operator">&amp;</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_SINGLE_TOP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> launchSingleTop<span class="token punctuation">)</span>
							<span class="token operator">&amp;&amp;</span> intentActivity<span class="token punctuation">.</span>realActivity<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>realActivity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token class-name">ActivityStack</span><span class="token punctuation">.</span><span class="token function">logStartActivity</span><span class="token punctuation">(</span><span class="token class-name">EventLogTags</span><span class="token punctuation">.</span>AM_NEW_INTENT<span class="token punctuation">,</span> r<span class="token punctuation">,</span>
								intentActivity<span class="token punctuation">.</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>intentActivity<span class="token punctuation">.</span>frontOfTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
							intentActivity<span class="token punctuation">.</span>task<span class="token punctuation">.</span><span class="token function">setIntent</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						intentActivity<span class="token punctuation">.</span><span class="token function">deliverNewIntentLocked</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">,</span>
								r<span class="token punctuation">.</span>launchedFromPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">filterEquals</span><span class="token punctuation">(</span>intentActivity<span class="token punctuation">.</span>task<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token comment">// In this case we are launching the root activity</span>
						<span class="token comment">// of the task, but with a different intent.  We</span>
						<span class="token comment">// should start a new instance on top.</span>
						addingToTask <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
						sourceRecord <span class="token operator">=</span> intentActivity<span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>launchFlags<span class="token operator">&amp;</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_RESET_TASK_IF_NEEDED<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">// In this case an activity is being launched in to an</span>
					<span class="token comment">// existing task, without resetting that task.  This</span>
					<span class="token comment">// is typically the situation of launching an activity</span>
					<span class="token comment">// from a notification or shortcut.  We want to place</span>
					<span class="token comment">// the new activity on top of the current task.</span>
					addingToTask <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
					sourceRecord <span class="token operator">=</span> intentActivity<span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>intentActivity<span class="token punctuation">.</span>task<span class="token punctuation">.</span>rootWasReset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">// In this case we are launching in to an existing task</span>
					<span class="token comment">// that has not yet been started from its front door.</span>
					<span class="token comment">// The current task has been brought to the front.</span>
					<span class="token comment">// Ideally, we&#39;d probably like to place this new task</span>
					<span class="token comment">// at the bottom of its stack, but that&#39;s a little hard</span>
					<span class="token comment">// to do with the current organization of the code so</span>
					<span class="token comment">// for now we&#39;ll just drop it.</span>
					intentActivity<span class="token punctuation">.</span>task<span class="token punctuation">.</span><span class="token function">setIntent</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>addingToTask <span class="token operator">&amp;&amp;</span> reuseTask <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">// We didn&#39;t do anything...  but it was needed (a.k.a., client</span>
					<span class="token comment">// don&#39;t use that intent!)  And for paranoia, make</span>
					<span class="token comment">// sure we have correctly resumed the top activity.</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>doResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						targetStack<span class="token punctuation">.</span><span class="token function">resumeTopActivityLocked</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>movedToFront<span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token comment">// Make sure to notify Keyguard as well if we are not running an app</span>
							<span class="token comment">// transition later.</span>
							<span class="token function">notifyActivityDrawnForKeyguard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
						<span class="token class-name">ActivityOptions</span><span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_TASK_TO_FRONT<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//String uri = r.intent.toURI();</span>
	<span class="token comment">//Intent intent2 = new Intent(uri);</span>
	<span class="token comment">//Slog.i(TAG, &quot;Given intent: &quot; + r.intent);</span>
	<span class="token comment">//Slog.i(TAG, &quot;URI is: &quot; + uri);</span>
	<span class="token comment">//Slog.i(TAG, &quot;To intent: &quot; + intent2);</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>packageName <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// If the activity being launched is the same as the one currently</span>
		<span class="token comment">// at the top, then we need to check if it should only be launched</span>
		<span class="token comment">// once.</span>
		<span class="token class-name">ActivityStack</span> topStack <span class="token operator">=</span> mFocusedStack<span class="token punctuation">;</span>
		<span class="token class-name">ActivityRecord</span> top <span class="token operator">=</span> topStack<span class="token punctuation">.</span><span class="token function">topRunningNonDelayedActivityLocked</span><span class="token punctuation">(</span>notTop<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>top <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>resultTo <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>top<span class="token punctuation">.</span>realActivity<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>realActivity<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> top<span class="token punctuation">.</span>userId <span class="token operator">==</span> r<span class="token punctuation">.</span>userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>top<span class="token punctuation">.</span>app <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> top<span class="token punctuation">.</span>app<span class="token punctuation">.</span>thread <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>launchFlags <span class="token operator">&amp;</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_SINGLE_TOP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
						<span class="token operator">||</span> launchSingleTop <span class="token operator">||</span> launchSingleTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token class-name">ActivityStack</span><span class="token punctuation">.</span><span class="token function">logStartActivity</span><span class="token punctuation">(</span><span class="token class-name">EventLogTags</span><span class="token punctuation">.</span>AM_NEW_INTENT<span class="token punctuation">,</span> top<span class="token punctuation">,</span>
								top<span class="token punctuation">.</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token comment">// For paranoia, make sure we have correctly</span>
						<span class="token comment">// resumed the top activity.</span>
						topStack<span class="token punctuation">.</span>mLastPausedActivity <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>doResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token function">resumeTopActivitiesLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						<span class="token class-name">ActivityOptions</span><span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>startFlags<span class="token operator">&amp;</span><span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_FLAG_ONLY_IF_NEEDED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token comment">// We don&#39;t need to start a new activity, and</span>
							<span class="token comment">// the client said not to do anything if that</span>
							<span class="token comment">// is the case, so this is it!</span>
							<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_RETURN_INTENT_TO_CALLER<span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						top<span class="token punctuation">.</span><span class="token function">deliverNewIntentLocked</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> r<span class="token punctuation">.</span>launchedFromPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_DELIVERED_TO_TOP<span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>resultTo <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>resultTo<span class="token punctuation">.</span>task<span class="token punctuation">.</span>stack <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			r<span class="token punctuation">.</span>resultTo<span class="token punctuation">.</span>task<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">sendActivityResultLocked</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultTo<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultWho<span class="token punctuation">,</span>
					r<span class="token punctuation">.</span>requestCode<span class="token punctuation">,</span> <span class="token class-name">Activity</span><span class="token punctuation">.</span>RESULT_CANCELED<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token class-name">ActivityOptions</span><span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_CLASS_NOT_FOUND<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">boolean</span> newTask <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token keyword">boolean</span> keepCurTransition <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

	<span class="token class-name">TaskRecord</span> taskToAffiliate <span class="token operator">=</span> launchTaskBehind <span class="token operator">&amp;&amp;</span> sourceRecord <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span>
			sourceRecord<span class="token punctuation">.</span>task <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

	<span class="token comment">// Should this be considered a new task?</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>resultTo <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> inTask <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>addingToTask
			<span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>launchFlags <span class="token operator">&amp;</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_NEW_TASK<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		newTask <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		targetStack <span class="token operator">=</span> <span class="token function">computeStackFocus</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> newTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
		targetStack<span class="token punctuation">.</span><span class="token function">moveToFront</span><span class="token punctuation">(</span><span class="token string">&quot;startingNewTask&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>reuseTask <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			r<span class="token punctuation">.</span><span class="token function">setTask</span><span class="token punctuation">(</span>targetStack<span class="token punctuation">.</span><span class="token function">createTaskRecord</span><span class="token punctuation">(</span><span class="token function">getNextTaskId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					newTaskInfo <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> newTaskInfo <span class="token operator">:</span> r<span class="token punctuation">.</span>info<span class="token punctuation">,</span>
					newTaskIntent <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> newTaskIntent <span class="token operator">:</span> intent<span class="token punctuation">,</span>
					voiceSession<span class="token punctuation">,</span> voiceInteractor<span class="token punctuation">,</span> <span class="token operator">!</span>launchTaskBehind <span class="token comment">/* toTop */</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					taskToAffiliate<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_TASKS<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_TASKS<span class="token punctuation">,</span>
					<span class="token string">&quot;Starting new activity &quot;</span> <span class="token operator">+</span> r <span class="token operator">+</span> <span class="token string">&quot; in new task &quot;</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			r<span class="token punctuation">.</span><span class="token function">setTask</span><span class="token punctuation">(</span>reuseTask<span class="token punctuation">,</span> taskToAffiliate<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLockTaskModeViolation</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Attempted Lock Task Mode violation r=&quot;</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_RETURN_LOCK_TASK_MODE_VIOLATION<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>movedHome<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>launchFlags <span class="token operator">&amp;</span>
					<span class="token punctuation">(</span>FLAG_ACTIVITY_NEW_TASK <span class="token operator">|</span> FLAG_ACTIVITY_TASK_ON_HOME<span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token operator">==</span> <span class="token punctuation">(</span>FLAG_ACTIVITY_NEW_TASK <span class="token operator">|</span> FLAG_ACTIVITY_TASK_ON_HOME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// Caller wants to appear on home activity, so before starting</span>
				<span class="token comment">// their own activity we will bring home to the front.</span>
				r<span class="token punctuation">.</span>task<span class="token punctuation">.</span><span class="token function">setTaskToReturnTo</span><span class="token punctuation">(</span>HOME_ACTIVITY_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sourceRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">final</span> <span class="token class-name">TaskRecord</span> sourceTask <span class="token operator">=</span> sourceRecord<span class="token punctuation">.</span>task<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLockTaskModeViolation</span><span class="token punctuation">(</span>sourceTask<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Attempted Lock Task Mode violation r=&quot;</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_RETURN_LOCK_TASK_MODE_VIOLATION<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		targetStack <span class="token operator">=</span> sourceTask<span class="token punctuation">.</span>stack<span class="token punctuation">;</span>
		targetStack<span class="token punctuation">.</span><span class="token function">moveToFront</span><span class="token punctuation">(</span><span class="token string">&quot;sourceStackToFront&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">final</span> <span class="token class-name">TaskRecord</span> topTask <span class="token operator">=</span> targetStack<span class="token punctuation">.</span><span class="token function">topTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>topTask <span class="token operator">!=</span> sourceTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			targetStack<span class="token punctuation">.</span><span class="token function">moveTaskToFrontLocked</span><span class="token punctuation">(</span>sourceTask<span class="token punctuation">,</span> noAnimation<span class="token punctuation">,</span> options<span class="token punctuation">,</span>
					r<span class="token punctuation">.</span>appTimeTracker<span class="token punctuation">,</span> <span class="token string">&quot;sourceTaskToFront&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>addingToTask <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>launchFlags<span class="token operator">&amp;</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_CLEAR_TOP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// In this case, we are adding the activity to an existing</span>
			<span class="token comment">// task, but the caller has asked to clear that task if the</span>
			<span class="token comment">// activity is already running.</span>
			<span class="token class-name">ActivityRecord</span> top <span class="token operator">=</span> sourceTask<span class="token punctuation">.</span><span class="token function">performClearTaskLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> launchFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
			keepCurTransition <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>top <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">ActivityStack</span><span class="token punctuation">.</span><span class="token function">logStartActivity</span><span class="token punctuation">(</span><span class="token class-name">EventLogTags</span><span class="token punctuation">.</span>AM_NEW_INTENT<span class="token punctuation">,</span> r<span class="token punctuation">,</span> top<span class="token punctuation">.</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
				top<span class="token punctuation">.</span><span class="token function">deliverNewIntentLocked</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> r<span class="token punctuation">.</span>launchedFromPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">// For paranoia, make sure we have correctly</span>
				<span class="token comment">// resumed the top activity.</span>
				targetStack<span class="token punctuation">.</span>mLastPausedActivity <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>doResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					targetStack<span class="token punctuation">.</span><span class="token function">resumeTopActivityLocked</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token class-name">ActivityOptions</span><span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_DELIVERED_TO_TOP<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>addingToTask <span class="token operator">&amp;&amp;</span>
				<span class="token punctuation">(</span>launchFlags<span class="token operator">&amp;</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_REORDER_TO_FRONT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// In this case, we are launching an activity in our own task</span>
			<span class="token comment">// that may already be running somewhere in the history, and</span>
			<span class="token comment">// we want to shuffle it to the front of the stack if so.</span>
			<span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> top <span class="token operator">=</span> sourceTask<span class="token punctuation">.</span><span class="token function">findActivityInHistoryLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>top <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">final</span> <span class="token class-name">TaskRecord</span> task <span class="token operator">=</span> top<span class="token punctuation">.</span>task<span class="token punctuation">;</span>
				task<span class="token punctuation">.</span><span class="token function">moveActivityToFrontLocked</span><span class="token punctuation">(</span>top<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">ActivityStack</span><span class="token punctuation">.</span><span class="token function">logStartActivity</span><span class="token punctuation">(</span><span class="token class-name">EventLogTags</span><span class="token punctuation">.</span>AM_NEW_INTENT<span class="token punctuation">,</span> r<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
				top<span class="token punctuation">.</span><span class="token function">updateOptionsLocked</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
				top<span class="token punctuation">.</span><span class="token function">deliverNewIntentLocked</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> r<span class="token punctuation">.</span>launchedFromPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
				targetStack<span class="token punctuation">.</span>mLastPausedActivity <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>doResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					targetStack<span class="token punctuation">.</span><span class="token function">resumeTopActivityLocked</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_DELIVERED_TO_TOP<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// An existing activity is starting this new activity, so we want</span>
		<span class="token comment">// to keep the new one in the same task as the one that is starting</span>
		<span class="token comment">// it.</span>
		r<span class="token punctuation">.</span><span class="token function">setTask</span><span class="token punctuation">(</span>sourceTask<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_TASKS<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_TASKS<span class="token punctuation">,</span> <span class="token string">&quot;Starting new activity &quot;</span> <span class="token operator">+</span> r
				<span class="token operator">+</span> <span class="token string">&quot; in existing task &quot;</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>task <span class="token operator">+</span> <span class="token string">&quot; from source &quot;</span> <span class="token operator">+</span> sourceRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>inTask <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// The caller is asking that the new activity be started in an explicit</span>
		<span class="token comment">// task it has provided to us.</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLockTaskModeViolation</span><span class="token punctuation">(</span>inTask<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Attempted Lock Task Mode violation r=&quot;</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_RETURN_LOCK_TASK_MODE_VIOLATION<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		targetStack <span class="token operator">=</span> inTask<span class="token punctuation">.</span>stack<span class="token punctuation">;</span>
		targetStack<span class="token punctuation">.</span><span class="token function">moveTaskToFrontLocked</span><span class="token punctuation">(</span>inTask<span class="token punctuation">,</span> noAnimation<span class="token punctuation">,</span> options<span class="token punctuation">,</span> r<span class="token punctuation">.</span>appTimeTracker<span class="token punctuation">,</span>
				<span class="token string">&quot;inTaskToFront&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Check whether we should actually launch the new activity in to the task,</span>
		<span class="token comment">// or just reuse the current activity on top.</span>
		<span class="token class-name">ActivityRecord</span> top <span class="token operator">=</span> inTask<span class="token punctuation">.</span><span class="token function">getTopActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>top <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> top<span class="token punctuation">.</span>realActivity<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>realActivity<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> top<span class="token punctuation">.</span>userId <span class="token operator">==</span> r<span class="token punctuation">.</span>userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>launchFlags <span class="token operator">&amp;</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_SINGLE_TOP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
					<span class="token operator">||</span> launchSingleTop <span class="token operator">||</span> launchSingleTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">ActivityStack</span><span class="token punctuation">.</span><span class="token function">logStartActivity</span><span class="token punctuation">(</span><span class="token class-name">EventLogTags</span><span class="token punctuation">.</span>AM_NEW_INTENT<span class="token punctuation">,</span> top<span class="token punctuation">,</span> top<span class="token punctuation">.</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>startFlags<span class="token operator">&amp;</span><span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_FLAG_ONLY_IF_NEEDED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">// We don&#39;t need to start a new activity, and</span>
					<span class="token comment">// the client said not to do anything if that</span>
					<span class="token comment">// is the case, so this is it!</span>
					<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_RETURN_INTENT_TO_CALLER<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				top<span class="token punctuation">.</span><span class="token function">deliverNewIntentLocked</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> r<span class="token punctuation">.</span>launchedFromPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_DELIVERED_TO_TOP<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>addingToTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// We don&#39;t actually want to have this activity added to the task, so just</span>
			<span class="token comment">// stop here but still tell the caller that we consumed the intent.</span>
			<span class="token class-name">ActivityOptions</span><span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_TASK_TO_FRONT<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		r<span class="token punctuation">.</span><span class="token function">setTask</span><span class="token punctuation">(</span>inTask<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_TASKS<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_TASKS<span class="token punctuation">,</span> <span class="token string">&quot;Starting new activity &quot;</span> <span class="token operator">+</span> r
				<span class="token operator">+</span> <span class="token string">&quot; in explicit task &quot;</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">// This not being started from an existing activity, and not part</span>
		<span class="token comment">// of a new task...  just put it in the top task, though these days</span>
		<span class="token comment">// this case should never happen.</span>
		targetStack <span class="token operator">=</span> <span class="token function">computeStackFocus</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> newTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
		targetStack<span class="token punctuation">.</span><span class="token function">moveToFront</span><span class="token punctuation">(</span><span class="token string">&quot;addingToTopTask&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">ActivityRecord</span> prev <span class="token operator">=</span> targetStack<span class="token punctuation">.</span><span class="token function">topActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		r<span class="token punctuation">.</span><span class="token function">setTask</span><span class="token punctuation">(</span>prev <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> prev<span class="token punctuation">.</span>task <span class="token operator">:</span> targetStack<span class="token punctuation">.</span><span class="token function">createTaskRecord</span><span class="token punctuation">(</span><span class="token function">getNextTaskId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
						r<span class="token punctuation">.</span>info<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		mWindowManager<span class="token punctuation">.</span><span class="token function">moveTaskToTop</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>task<span class="token punctuation">.</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_TASKS<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_TASKS<span class="token punctuation">,</span> <span class="token string">&quot;Starting new activity &quot;</span> <span class="token operator">+</span> r
				<span class="token operator">+</span> <span class="token string">&quot; in new guessed &quot;</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	mService<span class="token punctuation">.</span><span class="token function">grantUriPermissionFromIntentLocked</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">,</span> r<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
			intent<span class="token punctuation">,</span> r<span class="token punctuation">.</span><span class="token function">getUriPermissionsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>sourceRecord <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> sourceRecord<span class="token punctuation">.</span><span class="token function">isRecentsActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		r<span class="token punctuation">.</span>task<span class="token punctuation">.</span><span class="token function">setTaskToReturnTo</span><span class="token punctuation">(</span>RECENTS_ACTIVITY_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>newTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">EventLog</span><span class="token punctuation">.</span><span class="token function">writeEvent</span><span class="token punctuation">(</span><span class="token class-name">EventLogTags</span><span class="token punctuation">.</span>AM_CREATE_TASK<span class="token punctuation">,</span> r<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> r<span class="token punctuation">.</span>task<span class="token punctuation">.</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token class-name">ActivityStack</span><span class="token punctuation">.</span><span class="token function">logStartActivity</span><span class="token punctuation">(</span><span class="token class-name">EventLogTags</span><span class="token punctuation">.</span>AM_CREATE_ACTIVITY<span class="token punctuation">,</span> r<span class="token punctuation">,</span> r<span class="token punctuation">.</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
	targetStack<span class="token punctuation">.</span>mLastPausedActivity <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	
	<span class="token comment">// 上面这部分代码很多，各种启动模式、栈的处理啊，我们就不继续看了，接着看下面的启动。</span>
	targetStack<span class="token punctuation">.</span><span class="token function">startActivityLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> newTask<span class="token punctuation">,</span> doResume<span class="token punctuation">,</span> keepCurTransition<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>launchTaskBehind<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// Don&#39;t set focus on an activity that&#39;s going to the back.</span>
		mService<span class="token punctuation">.</span><span class="token function">setFocusedActivityLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token string">&quot;startedActivity&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>START_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>继续看<code>targetStack.startActivityLocked()</code>方法,这里<code>targetStack</code>就是<code>ActivityStack</code>类:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">startActivityLocked</span><span class="token punctuation">(</span><span class="token class-name">ActivityRecord</span> r<span class="token punctuation">,</span> <span class="token keyword">boolean</span> newTask<span class="token punctuation">,</span>
		<span class="token keyword">boolean</span> doResume<span class="token punctuation">,</span> <span class="token keyword">boolean</span> keepCurTransition<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">TaskRecord</span> rTask <span class="token operator">=</span> r<span class="token punctuation">.</span>task<span class="token punctuation">;</span>
	<span class="token keyword">final</span> <span class="token keyword">int</span> taskId <span class="token operator">=</span> rTask<span class="token punctuation">.</span>taskId<span class="token punctuation">;</span>
	<span class="token comment">// mLaunchTaskBehind tasks get placed at the back of the task stack.</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span>mLaunchTaskBehind <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">taskForIdLocked</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> newTask<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// Last activity in task had been removed or ActivityManagerService is reusing task.</span>
		<span class="token comment">// Insert or replace.</span>
		<span class="token comment">// Might not even be in.</span>
		<span class="token function">insertTaskAtTop</span><span class="token punctuation">(</span>rTask<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
		mWindowManager<span class="token punctuation">.</span><span class="token function">moveTaskToTop</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token class-name">TaskRecord</span> task <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// If starting in an existing task, find where that is...</span>
		<span class="token keyword">boolean</span> startIt <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> taskNdx <span class="token operator">=</span> mTaskHistory<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> taskNdx <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>taskNdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			task <span class="token operator">=</span> mTaskHistory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>taskNdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getTopActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// All activities in task are finishing.</span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">==</span> r<span class="token punctuation">.</span>task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// Here it is!  Now, if this is not yet visible to the</span>
				<span class="token comment">// user, then just add it without starting; it will</span>
				<span class="token comment">// get started when the user navigates back to it.</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>startIt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_ADD_REMOVE<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Adding activity &quot;</span> <span class="token operator">+</span> r <span class="token operator">+</span> <span class="token string">&quot; to task &quot;</span>
							<span class="token operator">+</span> task<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;here&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fillInStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					task<span class="token punctuation">.</span><span class="token function">addActivityToTop</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
					r<span class="token punctuation">.</span><span class="token function">putInHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					mWindowManager<span class="token punctuation">.</span><span class="token function">addAppToken</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>mActivities<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>appToken<span class="token punctuation">,</span>
							r<span class="token punctuation">.</span>task<span class="token punctuation">.</span>taskId<span class="token punctuation">,</span> mStackId<span class="token punctuation">,</span> r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>screenOrientation<span class="token punctuation">,</span> r<span class="token punctuation">.</span>fullscreen<span class="token punctuation">,</span>
							<span class="token punctuation">(</span>r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token class-name">ActivityInfo</span><span class="token punctuation">.</span>FLAG_SHOW_FOR_ALL_USERS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span>
							r<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>configChanges<span class="token punctuation">,</span> task<span class="token punctuation">.</span>voiceSession <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
							r<span class="token punctuation">.</span>mLaunchTaskBehind<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>VALIDATE_TOKENS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token function">validateAppTokensLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token class-name">ActivityOptions</span><span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">return</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>numFullscreen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				startIt <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Place a new activity at top of stack, so it is next to interact</span>
	<span class="token comment">// with the user.</span>

	<span class="token comment">// If we are not placing the new activity frontmost, we do not want</span>
	<span class="token comment">// to deliver the onUserLeaving callback to the actual frontmost</span>
	<span class="token comment">// activity</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">==</span> r<span class="token punctuation">.</span>task <span class="token operator">&amp;&amp;</span> mTaskHistory<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span>mTaskHistory<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		mStackSupervisor<span class="token punctuation">.</span>mUserLeaving <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_USER_LEAVING<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_USER_LEAVING<span class="token punctuation">,</span>
				<span class="token string">&quot;startActivity() behind front, mUserLeaving=false&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	task <span class="token operator">=</span> r<span class="token punctuation">.</span>task<span class="token punctuation">;</span>

	<span class="token comment">// Slot the activity into the history stack and proceed</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_ADD_REMOVE<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Adding activity &quot;</span> <span class="token operator">+</span> r <span class="token operator">+</span> <span class="token string">&quot; to stack to task &quot;</span> <span class="token operator">+</span> task<span class="token punctuation">,</span>
			<span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;here&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fillInStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	task<span class="token punctuation">.</span><span class="token function">addActivityToTop</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
	task<span class="token punctuation">.</span><span class="token function">setFrontOfTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	r<span class="token punctuation">.</span><span class="token function">putInHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isHomeStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">numActivities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// We want to show the starting preview window if we are</span>
		<span class="token comment">// switching to a new task, or the next activity&#39;s process is</span>
		<span class="token comment">// not currently running.</span>
		<span class="token keyword">boolean</span> showStartingIcon <span class="token operator">=</span> newTask<span class="token punctuation">;</span>
		<span class="token class-name">ProcessRecord</span> proc <span class="token operator">=</span> r<span class="token punctuation">.</span>app<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>proc <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			proc <span class="token operator">=</span> mService<span class="token punctuation">.</span>mProcessNames<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>proc <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> proc<span class="token punctuation">.</span>thread <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			showStartingIcon <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_TRANSITION<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_TRANSITION<span class="token punctuation">,</span>
				<span class="token string">&quot;Prepare open transition: starting &quot;</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_NO_ANIMATION<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			mWindowManager<span class="token punctuation">.</span><span class="token function">prepareAppTransition</span><span class="token punctuation">(</span><span class="token class-name">AppTransition</span><span class="token punctuation">.</span>TRANSIT_NONE<span class="token punctuation">,</span> keepCurTransition<span class="token punctuation">)</span><span class="token punctuation">;</span>
			mNoAnimActivities<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			mWindowManager<span class="token punctuation">.</span><span class="token function">prepareAppTransition</span><span class="token punctuation">(</span>newTask
					<span class="token operator">?</span> r<span class="token punctuation">.</span>mLaunchTaskBehind
							<span class="token operator">?</span> <span class="token class-name">AppTransition</span><span class="token punctuation">.</span>TRANSIT_TASK_OPEN_BEHIND
							<span class="token operator">:</span> <span class="token class-name">AppTransition</span><span class="token punctuation">.</span>TRANSIT_TASK_OPEN
					<span class="token operator">:</span> <span class="token class-name">AppTransition</span><span class="token punctuation">.</span>TRANSIT_ACTIVITY_OPEN<span class="token punctuation">,</span> keepCurTransition<span class="token punctuation">)</span><span class="token punctuation">;</span>
			mNoAnimActivities<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		mWindowManager<span class="token punctuation">.</span><span class="token function">addAppToken</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>mActivities<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span>
				r<span class="token punctuation">.</span>appToken<span class="token punctuation">,</span> r<span class="token punctuation">.</span>task<span class="token punctuation">.</span>taskId<span class="token punctuation">,</span> mStackId<span class="token punctuation">,</span> r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>screenOrientation<span class="token punctuation">,</span> r<span class="token punctuation">.</span>fullscreen<span class="token punctuation">,</span>
				<span class="token punctuation">(</span>r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token class-name">ActivityInfo</span><span class="token punctuation">.</span>FLAG_SHOW_FOR_ALL_USERS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>userId<span class="token punctuation">,</span>
				r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>configChanges<span class="token punctuation">,</span> task<span class="token punctuation">.</span>voiceSession <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>mLaunchTaskBehind<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">boolean</span> doShow <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>newTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// Even though this activity is starting fresh, we still need</span>
			<span class="token comment">// to reset it to make sure we apply affinities to move any</span>
			<span class="token comment">// existing activities from other tasks in to it.</span>
			<span class="token comment">// If the caller has requested that the target task be</span>
			<span class="token comment">// reset, then do so.</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_RESET_TASK_IF_NEEDED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">resetTaskIfNeededLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
				doShow <span class="token operator">=</span> <span class="token function">topRunningNonDelayedActivityLocked</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">==</span> r<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">new</span> <span class="token class-name">ActivityOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAnimationType</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token operator">==</span> <span class="token class-name">ActivityOptions</span><span class="token punctuation">.</span>ANIM_SCENE_TRANSITION<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			doShow <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>mLaunchTaskBehind<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// Don&#39;t do a starting window for mLaunchTaskBehind. More importantly make sure we</span>
			<span class="token comment">// tell WindowManager that r is visible even though it is at the back of the stack.</span>
			mWindowManager<span class="token punctuation">.</span><span class="token function">setAppVisibility</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>appToken<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">ensureActivitiesVisibleLocked</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>SHOW_APP_STARTING_PREVIEW <span class="token operator">&amp;&amp;</span> doShow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// Figure out if we are transitioning from another activity that is</span>
			<span class="token comment">// &quot;has the same starting icon&quot; as the next one.  This allows the</span>
			<span class="token comment">// window manager to keep the previous window it had previously</span>
			<span class="token comment">// created, if it still had one.</span>
			<span class="token class-name">ActivityRecord</span> prev <span class="token operator">=</span> mResumedActivity<span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>prev <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// We don&#39;t want to reuse the previous starting preview if:</span>
				<span class="token comment">// (1) The current activity is in a different task.</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>prev<span class="token punctuation">.</span>task <span class="token operator">!=</span> r<span class="token punctuation">.</span>task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					prev <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token comment">// (2) The current activity is already displayed.</span>
				<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>prev<span class="token punctuation">.</span>nowVisible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					prev <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			mWindowManager<span class="token punctuation">.</span><span class="token function">setAppStartingWindow</span><span class="token punctuation">(</span>
					r<span class="token punctuation">.</span>appToken<span class="token punctuation">,</span> r<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> r<span class="token punctuation">.</span>theme<span class="token punctuation">,</span>
					mService<span class="token punctuation">.</span><span class="token function">compatibilityInfoForPackageLocked</span><span class="token punctuation">(</span>
							r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>nonLocalizedLabel<span class="token punctuation">,</span>
					r<span class="token punctuation">.</span>labelRes<span class="token punctuation">,</span> r<span class="token punctuation">.</span>icon<span class="token punctuation">,</span> r<span class="token punctuation">.</span>logo<span class="token punctuation">,</span> r<span class="token punctuation">.</span>windowFlags<span class="token punctuation">,</span>
					prev <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> prev<span class="token punctuation">.</span>appToken <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> showStartingIcon<span class="token punctuation">)</span><span class="token punctuation">;</span>
			r<span class="token punctuation">.</span>mStartingWindowShown <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">// If this is the first activity, don&#39;t do any fancy animations,</span>
		<span class="token comment">// because there is nothing for it to animate on top of.</span>
		mWindowManager<span class="token punctuation">.</span><span class="token function">addAppToken</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>mActivities<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>appToken<span class="token punctuation">,</span>
				r<span class="token punctuation">.</span>task<span class="token punctuation">.</span>taskId<span class="token punctuation">,</span> mStackId<span class="token punctuation">,</span> r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>screenOrientation<span class="token punctuation">,</span> r<span class="token punctuation">.</span>fullscreen<span class="token punctuation">,</span>
				<span class="token punctuation">(</span>r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token class-name">ActivityInfo</span><span class="token punctuation">.</span>FLAG_SHOW_FOR_ALL_USERS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>userId<span class="token punctuation">,</span>
				r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>configChanges<span class="token punctuation">,</span> task<span class="token punctuation">.</span>voiceSession <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>mLaunchTaskBehind<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">ActivityOptions</span><span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		options <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>VALIDATE_TOKENS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">validateAppTokensLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>doResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		mStackSupervisor<span class="token punctuation">.</span><span class="token function">resumeTopActivitiesLocked</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> r<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在Android应用程序框架层中，是由ActivityManagerService组件负责为Android应用程序创建新的进程的，它本来也是运行在一个独立的进程之中，不过这个进程是在系统启动的过程中创建的。 ActivityManagerService组件一般会在什么情况下会为应用程序创建一个新的进程呢？当系统决定要在一个新的进程中启动一个Activity或者Service时，它就会创建一个新的进程了， 然后在这个新的进程中启动这个Activity或者Service</p><hr><ul><li>邮箱 ：charon.chui@gmail.com</li><li>Good Luck!</li></ul></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 335891510@qq.com">Jungle68</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/android-note/assets/app.e2a3b496.js" defer></script>
  </body>
</html>
